<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="7144px" preserveAspectRatio="none" style="width:2467px;height:7144px;background:#FFFFFF;" version="1.1" viewBox="0 0 2467 7144" width="2467px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="75.1875" id="_title" style="stroke:none;stroke-width:1.0;" width="15" x="1222" y="10"/><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1227" y="27.9951"> </text><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1227" y="44.292"> </text><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1227" y="60.5889"> </text><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1227" y="76.8857"> </text><rect fill="#6FA8DC" height="7039.4297" style="stroke:#181818;stroke-width:0.5;" width="324" x="264" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="101" x="373" y="104.2544">Infrastructure</text><rect fill="#94C47D" height="7039.4297" style="stroke:#181818;stroke-width:0.5;" width="372" x="720" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="203" x="802" y="104.2544">Identity and Access Control</text><rect fill="#FC877E" height="7039.4297" style="stroke:#181818;stroke-width:0.5;" width="152" x="1230" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="141" x="1233" y="104.2544">Open Banking APIs</text><rect fill="#D5A6BD" height="7039.4297" style="stroke:#181818;stroke-width:0.5;" width="340.5" x="1476.5" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="195" x="1546.75" y="104.2544">Core Banking Applications</text><rect fill="none" height="449.1953" style="stroke:#000000;stroke-width:1.5;" width="703" x="1730" y="3571.6719"/><rect fill="none" height="322.6641" style="stroke:#000000;stroke-width:1.5;" width="652" x="1771" y="3691.2031"/><rect fill="none" height="1396.8516" style="stroke:#000000;stroke-width:1.5;" width="2110" x="10" y="4783.1172"/><rect fill="none" height="276.1953" style="stroke:#000000;stroke-width:1.5;" width="2090" x="20" y="4887.7813"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="69" x2="69" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="308" x2="308" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="547" x2="547" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="803" x2="803" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1035" x2="1035" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1305.5" x2="1305.5" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1515.5" x2="1515.5" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1776" x2="1776" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1902" x2="1902" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2040" x2="2040" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2145" x2="2145" y1="175.2109" y2="7137.6172"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2418" x2="2418" y1="175.2109" y2="7137.6172"/><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="79" x="30" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="53.5" y="131.3154">Data</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="37" y="147.6123">Recipient</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="56" y="163.9092">App</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="81" x="268" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51" x="283" y="147.6123">Ingress</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67" x="275" y="163.9092">Controller</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="73" x="511" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21" x="537" y="147.6123">API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="518" y="163.9092">Gateway</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="159" x="724" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="731" y="131.3154">Identity Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="15" x="796" y="147.6123">---</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139" x="734" y="163.9092">Authorisation Server</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="983" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="1006" y="147.6123">Consent</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="990" y="163.9092">Management</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="89" x="1261.5" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53" x="1279.5" y="131.3154">Bacend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="1269" y="147.6123">Integration</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="1268.5" y="163.9092">Application</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="1480.5" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1487.5" y="131.3154">Banking</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="1490.5" y="147.6123">Identity</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1487.5" y="163.9092">Provider</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="73" x="1740" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1748.5" y="147.6123">Banking</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="1747" y="163.9092">Systems</text><rect fill="#E2E2F0" height="79.1875" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="138" x="1833" y="95.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1853" y="115.0186">Open Banking</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="1871" y="131.3154">Directory</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="15" x="1894.5" y="147.6123">---</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124" x="1840" y="163.9092">JSON Web Key Set</text><rect fill="#E2E2F0" height="79.1875" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="119" x="1981" y="95.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69" x="2006" y="115.0186">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="2010" y="131.3154">Authority</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="15" x="2033" y="147.6123">---</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1988" y="163.9092">OCSP Endpoint</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="2110" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2122.5" y="131.3154">Mobile</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="2117" y="147.6123">Banking</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="2131.5" y="163.9092">App</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="2381" y="171.9092">Customer</text><ellipse cx="2418" cy="107.4141" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M2418,115.4141 L2418,142.4141 M2405,123.4141 L2431,123.4141 M2418,142.4141 L2405,157.4141 M2418,142.4141 L2431,157.4141 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2460" x="0" y="205.7773"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="205.7773" y2="205.7773"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="208.7773" y2="208.7773"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="391" x="1034.5" y="195.2109"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="372" x="1040.5" y="211.2778">Part 0: Registration of Token Delivery Preferences</text><path d="M74,233.3438 L74,485.3438 L549,485.3438 L549,243.3438 L539,233.3438 L74,233.3438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M539,233.3438 L539,243.3438 L549,243.3438 L539,233.3438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="397" x="80" y="250.4106">CIBA requires that Clients register a delivery mode prior to the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="289" x="80" y="265.5435">transmission of any Authentication Requests:</text><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="270.6094" y2="270.6094"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="270.6094" y2="270.6094"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="270.6094" y2="270.6094"/><a href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.4" target="_top" title="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.4" xlink:actuate="onRequest" xlink:href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.4" xlink:show="new" xlink:title="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.4" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="434" x="80" y="284.6763">Clients registering to use CIBA MUST indicate a token delivery mode</text></a><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="289.7422" y2="289.7422"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="289.7422" y2="289.7422"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="289.7422" y2="289.7422"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="411" x="80" y="303.8091">The Authorization Server (AS) therefore must host a registration</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="389" x="80" y="318.9419">endpoint - defined in the discoverable OpenID Configuration -</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="372" x="80" y="334.0747">that allows the Client to do so. The parameters for this call</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="379" x="80" y="349.2075">are described in the CIBA specification and differ depending</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="277" x="80" y="364.3403">on the method in question. The modes are:</text><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="369.4063" y2="369.4063"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="369.4063" y2="369.4063"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="369.4063" y2="369.4063"/><ellipse cx="85.5" cy="379.0391" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="91" y="383.4731">Poll</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="208" x="118" y="383.4731">: Client polls the Token endpoint.</text><ellipse cx="85.5" cy="394.1719" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="91" y="398.606">Ping</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="320" x="124" y="398.606">: AS notifies, Client retrieves from Token endpoint.</text><ellipse cx="85.5" cy="409.3047" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="36" x="91" y="413.7388">Push</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="176" x="127" y="413.7388">: AS sends tokens to Client.</text><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="418.8047" y2="418.8047"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="418.8047" y2="418.8047"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="418.8047" y2="418.8047"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="448" x="80" y="432.8716">The supported modes vary by AS as they are implementor specific i.e.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="452" x="80" y="448.0044">implementors of the AS can choose to only support one-or-more given</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="454" x="80" y="463.1372">modes. The supported modes must be made pushed in the AS OpenID</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="89" x="80" y="478.27">Configuration.</text><polygon fill="#181818" points="296.5,508.4688,306.5,512.4688,296.5,516.4688,300.5,512.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="512.4688" y2="512.4688"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="146" x="76.5" y="507.4028">POST /connect/register</text><path d="M313,525.4688 L313,625.4688 L701,625.4688 L701,535.4688 L691,525.4688 L313,525.4688 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M691,525.4688 L691,535.4688 L701,535.4688 L691,525.4688 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="355" x="319" y="542.5356">The Kubernetes Ingress Controller is responsible for TLS</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="367" x="319" y="557.6685">termination and perfoming an OCSP call to the Certificate</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="336" x="319" y="572.8013">Authority to ensure the client certificate presented is</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="346" x="319" y="587.9341">valid. The fingerprint of the certificate will be forwarded</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="366" x="319" y="603.0669">to Identity Management to verify the validity of the OAuth</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="276" x="319" y="618.1997">Client as this cannot be asserted via OCSP.</text><polygon fill="#181818" points="2028.5,648.3984,2038.5,652.3984,2028.5,656.3984,2032.5,652.3984" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="652.3984" y2="652.3984"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="647.3325">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,677.5313,309.5,681.5313,319.5,685.5313,315.5,681.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="681.5313" y2="681.5313"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="676.4653">Response</text><polygon fill="#181818" points="791.5,706.6641,801.5,710.6641,791.5,714.6641,795.5,710.6641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="797.5" y1="710.6641" y2="710.6641"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="132" x="315.5" y="705.5981">Registration Request</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="739.7969" y2="739.7969"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="739.7969" y2="752.7969"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="752.7969" y2="752.7969"/><polygon fill="#181818" points="814.5,748.7969,804.5,752.7969,814.5,756.7969,810.5,752.7969" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="76" x="810.5" y="734.731">Verify Client</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="781.9297" y2="781.9297"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="781.9297" y2="794.9297"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="794.9297" y2="794.9297"/><polygon fill="#181818" points="814.5,790.9297,804.5,794.9297,814.5,798.9297,810.5,794.9297" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="154" x="810.5" y="776.8638">Store Client Parameters</text><polygon fill="#181818" points="319.5,820.0625,309.5,824.0625,319.5,828.0625,315.5,824.0625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="802.5" y1="824.0625" y2="824.0625"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="818.9966">Response</text><polygon fill="#181818" points="80.5,849.1953,70.5,853.1953,80.5,857.1953,76.5,853.1953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="853.1953" y2="853.1953"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="86.5" y="848.1294">Response</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2460" x="0" y="881.7617"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="881.7617" y2="881.7617"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="884.7617" y2="884.7617"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="441" x="1009.5" y="871.1953"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="422" x="1015.5" y="887.2622">Part 1: Create Consent and Send Authentication Request</text><path d="M74,909.3281 L74,979.3281 L469,979.3281 L469,919.3281 L459,909.3281 L74,909.3281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M459,909.3281 L459,919.3281 L469,919.3281 L459,909.3281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="358" x="80" y="926.395">The Data Recipient App requests an Access Token using</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="374" x="80" y="941.5278">the Client Credentials grant type. Nominally authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="342" x="80" y="956.6606">is through Mutual Authentication over TLS but it could</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="103" x="80" y="971.7935">equally be using</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="97" x="187" y="971.7935">private_key_jwt</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="284" y="971.7935">.</text><polygon fill="#181818" points="296.5,1001.9922,306.5,1005.9922,296.5,1009.9922,300.5,1005.9922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="1005.9922" y2="1005.9922"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="127" x="76.5" y="1000.9263">POST /oauth2/token</text><polygon fill="#181818" points="2028.5,1031.125,2038.5,1035.125,2028.5,1039.125,2032.5,1035.125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="1035.125" y2="1035.125"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="1030.0591">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,1060.2578,309.5,1064.2578,319.5,1068.2578,315.5,1064.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="1064.2578" y2="1064.2578"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="1059.1919">Response</text><polygon fill="#181818" points="791.5,1089.3906,801.5,1093.3906,791.5,1097.3906,795.5,1093.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="797.5" y1="1093.3906" y2="1093.3906"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="127" x="315.5" y="1088.3247">POST /oauth2/token</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="1122.5234" y2="1122.5234"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="1122.5234" y2="1135.5234"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="1135.5234" y2="1135.5234"/><polygon fill="#181818" points="814.5,1131.5234,804.5,1135.5234,814.5,1139.5234,810.5,1135.5234" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="76" x="810.5" y="1117.4575">Verify Client</text><polygon fill="#181818" points="319.5,1175.7891,309.5,1179.7891,319.5,1183.7891,315.5,1179.7891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="802.5" y1="1179.7891" y2="1179.7891"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="46" x="325.5" y="1159.5903">200 OK</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="143" x="325.5" y="1174.7231">{"access_token": "..."}</text><polygon fill="#181818" points="80.5,1220.0547,70.5,1224.0547,80.5,1228.0547,76.5,1224.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="1224.0547" y2="1224.0547"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="46" x="86.5" y="1203.856">200 OK</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="143" x="86.5" y="1218.9888">{"access_token": "..."}</text><path d="M74,1237.0547 L74,1307.0547 L471,1307.0547 L471,1247.0547 L461,1237.0547 L74,1237.0547 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M461,1237.0547 L461,1247.0547 L471,1247.0547 L461,1237.0547 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="376" x="80" y="1254.1216">With the Access Token in hand the Data Recipient can then</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="366" x="80" y="1269.2544">create the consent resource. This needs to be completed</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="342" x="80" y="1284.3872">before the Authentication Request as the value of the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="62" x="80" y="1299.52">consentId</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="258" x="146" y="1299.52">is required to set the value of the scope.</text><polygon fill="#181818" points="296.5,1329.7188,306.5,1333.7188,296.5,1337.7188,300.5,1333.7188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="1333.7188" y2="1333.7188"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="187" x="76.5" y="1328.6528">POST /payments/v1/consents</text><polygon fill="#181818" points="2028.5,1358.8516,2038.5,1362.8516,2028.5,1366.8516,2032.5,1362.8516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="1362.8516" y2="1362.8516"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="1357.7856">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,1387.9844,309.5,1391.9844,319.5,1395.9844,315.5,1391.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="1391.9844" y2="1391.9844"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="1386.9185">Response</text><polygon fill="#181818" points="535.5,1417.1172,545.5,1421.1172,535.5,1425.1172,539.5,1421.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="541.5" y1="1421.1172" y2="1421.1172"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="187" x="315.5" y="1416.0513">POST /payments/v1/consents</text><polygon fill="#181818" points="1023.5,1446.25,1033.5,1450.25,1023.5,1454.25,1027.5,1450.25" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="1029.5" y1="1450.25" y2="1450.25"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="187" x="554.5" y="1445.1841">POST /payments/v1/consents</text><line style="stroke:#181818;stroke-width:1.0;" x1="1035.5" x2="1077.5" y1="1479.3828" y2="1479.3828"/><line style="stroke:#181818;stroke-width:1.0;" x1="1077.5" x2="1077.5" y1="1479.3828" y2="1492.3828"/><line style="stroke:#181818;stroke-width:1.0;" x1="1036.5" x2="1077.5" y1="1492.3828" y2="1492.3828"/><polygon fill="#181818" points="1046.5,1488.3828,1036.5,1492.3828,1046.5,1496.3828,1042.5,1492.3828" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="229" x="1042.5" y="1474.3169">Validate consent request properties</text><polygon fill="#181818" points="558.5,1532.6484,548.5,1536.6484,558.5,1540.6484,554.5,1536.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="552.5" x2="1034.5" y1="1536.6484" y2="1536.6484"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="564.5" y="1516.4497">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="108" x="564.5" y="1531.5825">{consentId: "..."}</text><polygon fill="#181818" points="319.5,1576.9141,309.5,1580.9141,319.5,1584.9141,315.5,1580.9141" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="546.5" y1="1580.9141" y2="1580.9141"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="325.5" y="1560.7153">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="108" x="325.5" y="1575.8481">{consentId: "..."}</text><polygon fill="#181818" points="80.5,1621.1797,70.5,1625.1797,80.5,1629.1797,76.5,1625.1797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="1625.1797" y2="1625.1797"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="86.5" y="1604.981">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="108" x="86.5" y="1620.1138">{consentId: "..."}</text><path d="M74,1638.1797 L74,1693.1797 L530,1693.1797 L530,1648.1797 L520,1638.1797 L74,1638.1797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M520,1638.1797 L520,1648.1797 L530,1648.1797 L520,1638.1797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="435" x="80" y="1655.2466">The Data Recipient App can now create and send the Authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="397" x="80" y="1670.3794">Request. This includes the dynamic scope that holds the value</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="37" x="80" y="1685.5122">of the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="62" x="121" y="1685.5122">consentId</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="218" x="187" y="1685.5122">returned by Identity Management.</text><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="111.5" y1="1719.7109" y2="1719.7109"/><line style="stroke:#181818;stroke-width:1.0;" x1="111.5" x2="111.5" y1="1719.7109" y2="1732.7109"/><line style="stroke:#181818;stroke-width:1.0;" x1="70.5" x2="111.5" y1="1732.7109" y2="1732.7109"/><polygon fill="#181818" points="80.5,1728.7109,70.5,1732.7109,80.5,1736.7109,76.5,1732.7109" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="196" x="76.5" y="1714.645">Create Authentication Request</text><polygon fill="#181818" points="296.5,1757.8438,306.5,1761.8438,296.5,1765.8438,300.5,1761.8438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="1761.8438" y2="1761.8438"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="122" x="76.5" y="1756.7778">POST /bc-authorize</text><polygon fill="#181818" points="2028.5,1786.9766,2038.5,1790.9766,2028.5,1794.9766,2032.5,1790.9766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="1790.9766" y2="1790.9766"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="1785.9106">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,1816.1094,309.5,1820.1094,319.5,1824.1094,315.5,1820.1094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="1820.1094" y2="1820.1094"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="1815.0435">Response</text><polygon fill="#181818" points="791.5,1845.2422,801.5,1849.2422,791.5,1853.2422,795.5,1849.2422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="797.5" y1="1849.2422" y2="1849.2422"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="122" x="315.5" y="1844.1763">POST /bc-authorize</text><path d="M808,1862.2422 L808,1947.2422 L1295,1947.2422 L1295,1872.2422 L1285,1862.2422 L808,1862.2422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1285,1862.2422 L1285,1872.2422 L1295,1872.2422 L1285,1862.2422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="389" x="814" y="1879.3091">As with the redirection-based FAPI profiles the Authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="370" x="814" y="1894.4419">Request is a JSON Web Signature. It therefore needs to be</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="384" x="814" y="1909.5747">checked for validity. Note that in the context of CIBA Pushed</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="434" x="814" y="1924.7075">Authorization Request is not required as the Authentication Request</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="466" x="814" y="1939.8403">is always sent via a secured backchannel and never through the browser.</text><polygon fill="#181818" points="1890,1970.0391,1900,1974.0391,1890,1978.0391,1894,1974.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="1896" y1="1974.0391" y2="1974.0391"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="143" x="810.5" y="1968.9731">Get JSON Web Key Set</text><polygon fill="#181818" points="814.5,1999.1719,804.5,2003.1719,814.5,2007.1719,810.5,2003.1719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808.5" x2="1901" y1="2003.1719" y2="2003.1719"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="820.5" y="1998.106">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="2047.4375" y2="2047.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="2047.4375" y2="2060.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="2060.4375" y2="2060.4375"/><polygon fill="#181818" points="814.5,2056.4375,804.5,2060.4375,814.5,2064.4375,810.5,2060.4375" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="136" x="810.5" y="2027.2388">Match Authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="124" x="810.5" y="2042.3716">Request parameter</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="18" x="938.5" y="2042.3716">kid</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="2104.7031" y2="2104.7031"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="2104.7031" y2="2117.7031"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="2117.7031" y2="2117.7031"/><polygon fill="#181818" points="814.5,2113.7031,804.5,2117.7031,814.5,2121.7031,810.5,2117.7031" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="133" x="810.5" y="2084.5044">Verify Authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="188" x="810.5" y="2099.6372">Request parameter signature</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="2146.8359" y2="2146.8359"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="2146.8359" y2="2159.8359"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="2159.8359" y2="2159.8359"/><polygon fill="#181818" points="814.5,2155.8359,804.5,2159.8359,814.5,2163.8359,810.5,2159.8359" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="205" x="810.5" y="2141.77">Validate Authentication Request</text><path d="M808,2172.8359 L808,2227.8359 L1159,2227.8359 L1159,2182.8359 L1149,2172.8359 L808,2172.8359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1149,2172.8359 L1149,2182.8359 L1159,2182.8359 L1149,2172.8359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="330" x="814" y="2189.9028">Note this approach is non-normative and the actual</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="330" x="814" y="2205.0356">implementation required should be considered on a</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="126" x="814" y="2220.1685">case-by-case basis.</text><polygon fill="#181818" points="1503.5,2250.3672,1513.5,2254.3672,1503.5,2258.3672,1507.5,2254.3672" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="1509.5" y1="2254.3672" y2="2254.3672"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="260" x="810.5" y="2249.3013">Send Authentication Request notification</text><polygon fill="#181818" points="319.5,2294.6328,309.5,2298.6328,319.5,2302.6328,315.5,2298.6328" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="802.5" y1="2298.6328" y2="2298.6328"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="325.5" y="2278.4341">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="121" x="325.5" y="2293.5669">{auth_req_id: "..."}</text><polygon fill="#181818" points="80.5,2338.8984,70.5,2342.8984,80.5,2346.8984,76.5,2342.8984" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="2342.8984" y2="2342.8984"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="86.5" y="2322.6997">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="121" x="86.5" y="2337.8325">{auth_req_id: "..."}</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2460" x="0" y="2371.4648"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="2371.4648" y2="2371.4648"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="2374.4648" y2="2374.4648"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="426" x="1017" y="2360.8984"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="407" x="1023" y="2376.9653">Part 2: Customer Authenticates at Mobile Banking App</text><path d="M1520,2399.0313 L1520,2484.0313 L1907,2484.0313 L1907,2409.0313 L1897,2399.0313 L1520,2399.0313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1897,2399.0313 L1897,2409.0313 L1907,2409.0313 L1897,2399.0313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="338" x="1526" y="2416.0981">The flow shown is a hypothetical approach to allowing</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="366" x="1526" y="2431.231">the End User to authenticate and confirm consent. In this</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="355" x="1526" y="2446.3638">scenario has installed their mobile banking app and can</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="366" x="1526" y="2461.4966">receive and act-on a request to authenticate and confirm</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="55" x="1526" y="2476.6294">consent.</text><line style="stroke:#181818;stroke-width:1.0;" x1="1515.5" x2="1557.5" y1="2525.9609" y2="2525.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="1557.5" x2="1557.5" y1="2525.9609" y2="2538.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="1516.5" x2="1557.5" y1="2538.9609" y2="2538.9609"/><polygon fill="#181818" points="1526.5,2534.9609,1516.5,2538.9609,1526.5,2542.9609,1522.5,2538.9609" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="156" x="1522.5" y="2505.7622">Correlate Authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="148" x="1522.5" y="2520.895">Request with Customer</text><polygon fill="#181818" points="1764.5,2564.0938,1774.5,2568.0938,1764.5,2572.0938,1768.5,2568.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1515.5" x2="1770.5" y1="2568.0938" y2="2568.0938"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="237" x="1522.5" y="2563.0278">Trigger push notification to Customer</text><path d="M1781,2581.0938 L1781,2636.0938 L2126,2636.0938 L2126,2591.0938 L2116,2581.0938 L1781,2581.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2116,2581.0938 L2116,2591.0938 L2126,2591.0938 L2116,2581.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="324" x="1787" y="2598.1606">The push notification needs to carry some context.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="108" x="1787" y="2613.2935">For example, the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="62" x="1899" y="2613.2935">consentId</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="96" x="1965" y="2613.2935">- to require the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="220" x="1787" y="2628.4263">consent to be correlated correctly.</text><polygon fill="#181818" points="2133,2658.625,2143,2662.625,2133,2666.625,2137,2662.625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1776.5" x2="2139" y1="2662.625" y2="2662.625"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="288" x="1783.5" y="2657.5591">Send push notification to mobile banking app</text><polygon fill="#181818" points="2406,2687.7578,2416,2691.7578,2406,2695.7578,2410,2691.7578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2145" x2="2412" y1="2691.7578" y2="2691.7578"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="104" x="2152" y="2686.6919">Notify Customer</text><polygon fill="#181818" points="2156,2716.8906,2146,2720.8906,2156,2724.8906,2152,2720.8906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2150" x2="2417" y1="2720.8906" y2="2720.8906"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="97" x="2162" y="2715.8247">Tap notification</text><polygon fill="#181818" points="2406,2761.1563,2416,2765.1563,2406,2769.1563,2410,2765.1563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2145" x2="2412" y1="2765.1563" y2="2765.1563"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="116" x="2152" y="2744.9575">Request biometric</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="151" x="2152" y="2760.0903">gesture to authenticate</text><polygon fill="#181818" points="2156,2805.4219,2146,2809.4219,2156,2813.4219,2152,2809.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2150" x2="2417" y1="2809.4219" y2="2809.4219"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="113" x="2162" y="2789.2231">Present biometric</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="49" x="2162" y="2804.356">gesture</text><path d="M1520,2822.4219 L1520,2941.4219 L1938,2941.4219 L1938,2832.4219 L1928,2822.4219 L1520,2822.4219 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1928,2822.4219 L1928,2832.4219 L1938,2832.4219 L1928,2822.4219 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="374" x="1526" y="2839.4888">As with the majority of mobile banking apps authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="396" x="1526" y="2854.6216">in this example is outsourced to the mobile operating system.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="397" x="1526" y="2869.7544">Once the customer has authenticated the mobile banking app</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="375" x="1526" y="2884.8872">simply sends a "user authenticated" notification to the IDP.</text><line style="stroke:#000000;stroke-width:0.5;" x1="1526" x2="1526" y1="2889.9531" y2="2889.9531"/><line style="stroke:#000000;stroke-width:0.5;" x1="1526" x2="1526" y1="2889.9531" y2="2889.9531"/><line style="stroke:#000000;stroke-width:0.5;" x1="1526" x2="1526" y1="2889.9531" y2="2889.9531"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="354" x="1526" y="2904.02">This flow is non-normative, implementation-specific and</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="371" x="1526" y="2919.1528">would be created based on the implementors architecture</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="102" x="1526" y="2934.2856">and technology.</text><polygon fill="#181818" points="1526.5,2964.4844,1516.5,2968.4844,1526.5,2972.4844,1522.5,2968.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1520.5" x2="2144" y1="2968.4844" y2="2968.4844"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="197" x="1532.5" y="2963.4185">User authenticated notification</text><polygon fill="#181818" points="2133,2993.6172,2143,2997.6172,2133,3001.6172,2137,2997.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1515.5" x2="2139" y1="2997.6172" y2="2997.6172"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="117" x="1522.5" y="2992.5513">Acknowledgement</text><polygon fill="#181818" points="1787.5,3022.75,1777.5,3026.75,1787.5,3030.75,1783.5,3026.75" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1781.5" x2="2144" y1="3026.75" y2="3026.75"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="181" x="1793.5" y="3021.6841">Request Customer accounts</text><polygon fill="#181818" points="2133,3051.8828,2143,3055.8828,2133,3059.8828,2137,3055.8828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1776.5" x2="2139" y1="3055.8828" y2="3055.8828"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1783.5" y="3050.8169">Response</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2460" x="0" y="3084.4492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="3084.4492" y2="3084.4492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="3087.4492" y2="3087.4492"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="436" x="1012" y="3073.8828"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="417" x="1018" y="3089.9497">Part 3: Customer Confirms Consent and Selects Account</text><path d="M1702,3112.0156 L1702,3231.0156 L2140,3231.0156 L2140,3122.0156 L2130,3112.0156 L1702,3112.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2130,3112.0156 L2130,3122.0156 L2140,3122.0156 L2130,3112.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="395" x="1708" y="3129.0825">As Consent needs to be retrieved from a hostile security zone</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="386" x="1708" y="3144.2153">i.e. from a Customer's mobile device the request to Consent</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="384" x="1708" y="3159.3481">Management should be routed via the Ingress Controller/API</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="375" x="1708" y="3174.481">Gateway. This flow is implementation-specific and would be</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="417" x="1708" y="3189.6138">created based on the implementors architecture and technology.</text><line style="stroke:#000000;stroke-width:0.5;" x1="1708" x2="1708" y1="3194.6797" y2="3194.6797"/><line style="stroke:#000000;stroke-width:0.5;" x1="1708" x2="1708" y1="3194.6797" y2="3194.6797"/><line style="stroke:#000000;stroke-width:0.5;" x1="1708" x2="1708" y1="3194.6797" y2="3194.6797"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="313" x="1708" y="3208.7466">In this example the Customer is the sole account</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="379" x="1708" y="3223.8794">holder and therefore no further authorizations are required.</text><polygon fill="#181818" points="319.5,3254.0781,309.5,3258.0781,319.5,3262.0781,315.5,3258.0781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="313.5" x2="2144" y1="3258.0781" y2="3258.0781"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="107" x="325.5" y="3253.0122">Retrieve consent</text><polygon fill="#181818" points="535.5,3283.2109,545.5,3287.2109,535.5,3291.2109,539.5,3287.2109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="541.5" y1="3287.2109" y2="3287.2109"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="107" x="315.5" y="3282.145">Retrieve consent</text><polygon fill="#181818" points="1023.5,3312.3438,1033.5,3316.3438,1023.5,3320.3438,1027.5,3316.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="1029.5" y1="3316.3438" y2="3316.3438"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="107" x="554.5" y="3311.2778">Retrieve consent</text><line style="stroke:#181818;stroke-width:1.0;" x1="1035.5" x2="1077.5" y1="3345.4766" y2="3345.4766"/><line style="stroke:#181818;stroke-width:1.0;" x1="1077.5" x2="1077.5" y1="3345.4766" y2="3358.4766"/><line style="stroke:#181818;stroke-width:1.0;" x1="1036.5" x2="1077.5" y1="3358.4766" y2="3358.4766"/><polygon fill="#181818" points="1046.5,3354.4766,1036.5,3358.4766,1046.5,3362.4766,1042.5,3358.4766" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="109" x="1042.5" y="3340.4106">Retrieve Consent</text><polygon fill="#181818" points="558.5,3383.6094,548.5,3387.6094,558.5,3391.6094,554.5,3387.6094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="552.5" x2="1034.5" y1="3387.6094" y2="3387.6094"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="564.5" y="3382.5435">Response</text><polygon fill="#181818" points="319.5,3412.7422,309.5,3416.7422,319.5,3420.7422,315.5,3416.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="546.5" y1="3416.7422" y2="3416.7422"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="3411.6763">Response</text><polygon fill="#181818" points="2133,3441.875,2143,3445.875,2133,3449.875,2137,3445.875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="308.5" x2="2139" y1="3445.875" y2="3445.875"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="315.5" y="3440.8091">Response</text><path d="M1781,3458.875 L1781,3558.875 L2328,3558.875 L2328,3468.875 L2318,3458.875 L1781,3458.875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2318,3458.875 L2318,3468.875 L2328,3468.875 L2318,3458.875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="526" x="1787" y="3475.9419">The Consent Confirmation screen requires the following properties to be displayed:</text><ellipse cx="1792.5" cy="3486.6406" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="118" x="1798" y="3491.0747">Transaction Value.</text><ellipse cx="1792.5" cy="3501.7734" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="279" x="1798" y="3506.2075">Recipient details (name, in Brazil CPF/CNPJ).</text><ellipse cx="1792.5" cy="3516.9063" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="96" x="1798" y="3521.3403">Payment Date.</text><ellipse cx="1792.5" cy="3532.0391" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="365" x="1798" y="3536.4731">Payment method (for example, in Brazil it is fixed as PIX).</text><ellipse cx="1792.5" cy="3547.1719" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="264" x="1798" y="3551.606">Fee amount charged by the bank (if any).</text><path d="M1730,3571.6719 L1800,3571.6719 L1800,3578.8047 L1790,3588.8047 L1730,3588.8047 L1730,3571.6719 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="449.1953" style="stroke:#000000;stroke-width:1.5;" width="703" x="1730" y="3571.6719"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="1745" y="3584.7388">par</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="220" x="1815" y="3583.8823">[Request fee amount for payment]</text><path d="M1781,3593.8047 L1781,3618.8047 L2204,3618.8047 L2204,3603.8047 L2194,3593.8047 L1781,3593.8047 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2194,3593.8047 L2194,3603.8047 L2204,3603.8047 L2194,3593.8047 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="402" x="1787" y="3610.8716">Fees for payment must be provided from the Banking Systems</text><polygon fill="#181818" points="1787.5,3641.0703,1777.5,3645.0703,1787.5,3649.0703,1783.5,3645.0703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1781.5" x2="2144" y1="3645.0703" y2="3645.0703"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="130" x="1793.5" y="3640.0044">Request fee amount</text><polygon fill="#181818" points="2133,3670.2031,2143,3674.2031,2133,3678.2031,2137,3674.2031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1776.5" x2="2139" y1="3674.2031" y2="3674.2031"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1783.5" y="3669.1372">Response</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1730" x2="2433" y1="3683.2031" y2="3683.2031"/><path d="M1771,3691.2031 L1835,3691.2031 L1835,3698.3359 L1825,3708.3359 L1771,3708.3359 L1771,3691.2031 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="322.6641" style="stroke:#000000;stroke-width:1.5;" width="652" x="1771" y="3691.2031"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="1786" y="3704.27">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="266" x="1850" y="3703.4136">[Debtor account not provided in Consent]</text><path d="M1781,3713.3359 L1781,3828.3359 L2262,3828.3359 L2262,3723.3359 L2252,3713.3359 L1781,3713.3359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2252,3713.3359 L2252,3723.3359 L2262,3723.3359 L2252,3713.3359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="410" x="1787" y="3730.4028">If the debtor account has not been provided in the Consent then</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="379" x="1787" y="3745.5356">the customer's payment accounts will need to be retrieved:</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="1787" y="3760.6685"> </text><ellipse cx="1792.5" cy="3771.3672" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="449" x="1798" y="3775.8013">If the customer only has one payment account then this is the default.</text><ellipse cx="1792.5" cy="3786.5" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="411" x="1798" y="3790.9341">If they have multiple accounts they should be able to select one.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="1787" y="3806.0669"> </text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="423" x="1787" y="3821.1997">This should be incorporated into the Consent Confirmation screen.</text><line style="stroke:#181818;stroke-width:1.0;" x1="2145" x2="2187" y1="3855.3984" y2="3855.3984"/><line style="stroke:#181818;stroke-width:1.0;" x1="2187" x2="2187" y1="3855.3984" y2="3868.3984"/><line style="stroke:#181818;stroke-width:1.0;" x1="2146" x2="2187" y1="3868.3984" y2="3868.3984"/><polygon fill="#181818" points="2156,3864.3984,2146,3868.3984,2156,3872.3984,2152,3868.3984" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="259" x="2152" y="3850.3325">Query account list for payment accounts</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1771" x2="2423" y1="3877.3984" y2="3877.3984"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="241" x="1776" y="3887.6089">[Debtor account provided in Consent]</text><path d="M1781,3896.2031 L1781,3966.2031 L2222,3966.2031 L2222,3906.2031 L2212,3896.2031 L1781,3896.2031 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2212,3896.2031 L2212,3906.2031 L2222,3906.2031 L2212,3896.2031 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="415" x="1787" y="3913.27">If the debtor account has already been provided ownership of the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="160" x="1787" y="3928.4028">account by the customer</text><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="37" x="1951" y="3928.4028">must</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="1992" y="3928.4028">be verified. In this example this</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="420" x="1787" y="3943.5356">can be done at the Mobile Banking App as it has already retrieved</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="190" x="1787" y="3958.6685">the list of customer accounts.</text><line style="stroke:#181818;stroke-width:1.0;" x1="2145" x2="2187" y1="3992.8672" y2="3992.8672"/><line style="stroke:#181818;stroke-width:1.0;" x1="2187" x2="2187" y1="3992.8672" y2="4005.8672"/><line style="stroke:#181818;stroke-width:1.0;" x1="2146" x2="2187" y1="4005.8672" y2="4005.8672"/><polygon fill="#181818" points="2156,4001.8672,2146,4005.8672,2156,4009.8672,2152,4005.8672" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="205" x="2152" y="3987.8013">Verify debtor account ownership</text><line style="stroke:#181818;stroke-width:1.0;" x1="2145" x2="2187" y1="4064.1328" y2="4064.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="2187" x2="2187" y1="4064.1328" y2="4077.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="2146" x2="2187" y1="4077.1328" y2="4077.1328"/><polygon fill="#181818" points="2156,4073.1328,2146,4077.1328,2156,4081.1328,2152,4077.1328" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="100" x="2152" y="4043.9341">Render consent</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="127" x="2152" y="4059.0669">confirmation screen</text><polygon fill="#181818" points="2406,4117.3984,2416,4121.3984,2406,4125.3984,2410,4121.3984" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2145" x2="2412" y1="4121.3984" y2="4121.3984"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="107" x="2152" y="4101.1997">Request consent</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="80" x="2152" y="4116.3325">confirmation</text><polygon fill="#181818" points="2156,4146.5313,2146,4150.5313,2156,4154.5313,2152,4150.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2150" x2="2417" y1="4150.5313" y2="4150.5313"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="105" x="2162" y="4145.4653">Confirm consent</text><polygon fill="#181818" points="319.5,4175.6641,309.5,4179.6641,319.5,4183.6641,315.5,4179.6641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="313.5" x2="2144" y1="4179.6641" y2="4179.6641"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="193" x="325.5" y="4174.5981">Update consent as authorized</text><polygon fill="#181818" points="535.5,4204.7969,545.5,4208.7969,535.5,4212.7969,539.5,4208.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="541.5" y1="4208.7969" y2="4208.7969"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="193" x="315.5" y="4203.731">Update consent as authorized</text><polygon fill="#181818" points="1023.5,4233.9297,1033.5,4237.9297,1023.5,4241.9297,1027.5,4237.9297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="1029.5" y1="4237.9297" y2="4237.9297"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="102" x="554.5" y="4232.8638">Update consent</text><line style="stroke:#181818;stroke-width:1.0;" x1="1035.5" x2="1077.5" y1="4267.0625" y2="4267.0625"/><line style="stroke:#181818;stroke-width:1.0;" x1="1077.5" x2="1077.5" y1="4267.0625" y2="4280.0625"/><line style="stroke:#181818;stroke-width:1.0;" x1="1036.5" x2="1077.5" y1="4280.0625" y2="4280.0625"/><polygon fill="#181818" points="1046.5,4276.0625,1036.5,4280.0625,1046.5,4284.0625,1042.5,4280.0625" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="104" x="1042.5" y="4261.9966">Update Consent</text><polygon fill="#181818" points="558.5,4305.1953,548.5,4309.1953,558.5,4313.1953,554.5,4309.1953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="552.5" x2="1034.5" y1="4309.1953" y2="4309.1953"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="564.5" y="4304.1294">Response</text><polygon fill="#181818" points="319.5,4334.3281,309.5,4338.3281,319.5,4342.3281,315.5,4338.3281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="546.5" y1="4338.3281" y2="4338.3281"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="4333.2622">Response</text><polygon fill="#181818" points="2133,4363.4609,2143,4367.4609,2133,4371.4609,2137,4367.4609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="308.5" x2="2139" y1="4367.4609" y2="4367.4609"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="315.5" y="4362.395">Response</text><path d="M1771,4380.4609 L1771,4495.4609 L2140,4495.4609 L2140,4390.4609 L2130,4380.4609 L1771,4380.4609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2130,4380.4609 L2130,4390.4609 L2140,4390.4609 L2130,4380.4609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="306" x="1777" y="4397.5278">The final step is to call the Identity Management</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="329" x="1777" y="4412.6606">component to indicate that the Customer has been</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="329" x="1777" y="4427.7935">authenticated. Identity Management will then signal</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="348" x="1777" y="4442.9263">to the Data Recipient App using the chosen mode that</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="283" x="1777" y="4458.0591">authentication is complete. Again this flow is</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="337" x="1777" y="4473.1919">implementation-specific and would be created based</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="321" x="1777" y="4488.3247">on the implementors architecture and technology.</text><polygon fill="#181818" points="814.5,4518.5234,804.5,4522.5234,814.5,4526.5234,810.5,4522.5234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="808.5" x2="2144" y1="4522.5234" y2="4522.5234"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="231" x="820.5" y="4517.4575">Authentication complete notification</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2460" x="0" y="4551.0898"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="4551.0898" y2="4551.0898"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="4554.0898" y2="4554.0898"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="286" x="1087" y="4540.5234"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="267" x="1093" y="4556.5903">Part 4: Client Granted Access Token</text><path d="M74,4578.6563 L74,4770.6563 L529,4770.6563 L529,4588.6563 L519,4578.6563 L74,4578.6563 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M519,4578.6563 L519,4588.6563 L529,4588.6563 L519,4578.6563 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="166" x="80" y="4595.7231">Notes on Token behaviors</text><line style="stroke:#181818;stroke-width:1.0;" x1="75" x2="528" y1="4598.7891" y2="4598.7891"/><line style="stroke:#181818;stroke-width:1.0;" x1="75" x2="528" y1="4600.7891" y2="4600.7891"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="383" x="80" y="4614.856">The Data Recipient App is made aware of the success of the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="364" x="80" y="4629.9888">based on their registered delivery mode. Each of these is</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="84" x="80" y="4645.1216">shown below.</text><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="4650.1875" y2="4650.1875"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="4650.1875" y2="4650.1875"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="4650.1875" y2="4650.1875"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="347" x="80" y="4664.2544">Note that the Poll looping example is purely illustrative</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="395" x="80" y="4679.3872">as the Data Recipient App would poll as soon as they received</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="21" x="80" y="4694.52">the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="75" x="105" y="4694.52">auth_req_id</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="227" x="184" y="4694.52">from the AS. Writing the diagram to</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="434" x="80" y="4709.6528">incorporate this sequentially would, however be extremely confusing</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="218" x="80" y="4724.7856">hence the sequence shown below.</text><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="4729.8516" y2="4729.8516"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="4729.8516" y2="4729.8516"/><line style="stroke:#000000;stroke-width:0.5;" x1="80" x2="80" y1="4729.8516" y2="4729.8516"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="386" x="80" y="4743.9185">For Poll and Ping mode the Data Recipient App must use the</text><a href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.1" target="_top" title="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.1" xlink:actuate="onRequest" xlink:href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.1" xlink:show="new" xlink:title="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.1" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="100" x="80" y="4759.0513">CIBA grant type</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="255" x="184" y="4759.0513">as described in the source specification.</text><path d="M10,4783.1172 L74,4783.1172 L74,4790.25 L64,4800.25 L10,4800.25 L10,4783.1172 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="1396.8516" style="stroke:#000000;stroke-width:1.5;" width="2110" x="10" y="4783.1172"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="4796.1841">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="188" x="89" y="4795.3276">[Client Registered Poll Mode]</text><path d="M74,4805.25 L74,4875.25 L523,4875.25 L523,4815.25 L513,4805.25 L74,4805.25 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M513,4805.25 L513,4815.25 L523,4815.25 L513,4805.25 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="374" x="80" y="4822.3169">In Poll mode the DR will periodically call the Token endpoint</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="362" x="80" y="4837.4497">until they get a positive response i.e. they do not receive</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="428" x="80" y="4852.5825">the 400 HTTP response code but instead are returned one-or-more</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="344" x="80" y="4867.7153">tokens (Access, Refresh, ID) from the Token endpoint.</text><path d="M20,4887.7813 L97,4887.7813 L97,4894.9141 L87,4904.9141 L20,4904.9141 L20,4887.7813 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="276.1953" style="stroke:#000000;stroke-width:1.5;" width="2090" x="20" y="4887.7813"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="35" y="4900.8481">loop</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="299" x="112" y="4899.9917">[Exit when Authentication Request successful]</text><polygon fill="#181818" points="296.5,4922.0469,306.5,4926.0469,296.5,4930.0469,300.5,4926.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="4926.0469" y2="4926.0469"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="180" x="76.5" y="4920.981">POST /token auth_req_id=...</text><polygon fill="#181818" points="2028.5,4951.1797,2038.5,4955.1797,2028.5,4959.1797,2032.5,4955.1797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="4955.1797" y2="4955.1797"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="4950.1138">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,4980.3125,309.5,4984.3125,319.5,4988.3125,315.5,4984.3125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="4984.3125" y2="4984.3125"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="4979.2466">Response</text><polygon fill="#181818" points="791.5,5009.4453,801.5,5013.4453,791.5,5017.4453,795.5,5013.4453" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="797.5" y1="5013.4453" y2="5013.4453"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="180" x="315.5" y="5008.3794">POST /token auth_req_id=...</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="5042.5781" y2="5042.5781"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="5042.5781" y2="5055.5781"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="5055.5781" y2="5055.5781"/><polygon fill="#181818" points="814.5,5051.5781,804.5,5055.5781,814.5,5059.5781,810.5,5055.5781" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="202" x="810.5" y="5037.5122">Retrieve Authentication request</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="5084.7109" y2="5084.7109"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="5084.7109" y2="5097.7109"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="5097.7109" y2="5097.7109"/><polygon fill="#181818" points="814.5,5093.7109,804.5,5097.7109,814.5,5101.7109,810.5,5097.7109" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="83" x="810.5" y="5079.645">Check status</text><polygon fill="#181818" points="319.5,5122.8438,309.5,5126.8438,319.5,5130.8438,315.5,5126.8438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="802.5" y1="5126.8438" y2="5126.8438"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="141" x="325.5" y="5121.7778">400 Bad Request {...}</text><polygon fill="#181818" points="80.5,5151.9766,70.5,5155.9766,80.5,5159.9766,76.5,5155.9766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="5155.9766" y2="5155.9766"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="141" x="86.5" y="5150.9106">400 Bad Request {...}</text><polygon fill="#181818" points="296.5,5188.1094,306.5,5192.1094,296.5,5196.1094,300.5,5192.1094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="5192.1094" y2="5192.1094"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="180" x="76.5" y="5187.0435">POST /token auth_req_id=...</text><polygon fill="#181818" points="2028.5,5217.2422,2038.5,5221.2422,2028.5,5225.2422,2032.5,5221.2422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="5221.2422" y2="5221.2422"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="5216.1763">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,5246.375,309.5,5250.375,319.5,5254.375,315.5,5250.375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="5250.375" y2="5250.375"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="5245.3091">Response</text><polygon fill="#181818" points="791.5,5275.5078,801.5,5279.5078,791.5,5283.5078,795.5,5279.5078" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="797.5" y1="5279.5078" y2="5279.5078"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="180" x="315.5" y="5274.4419">POST /token auth_req_id=...</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="5308.6406" y2="5308.6406"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="5308.6406" y2="5321.6406"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="5321.6406" y2="5321.6406"/><polygon fill="#181818" points="814.5,5317.6406,804.5,5321.6406,814.5,5325.6406,810.5,5321.6406" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="202" x="810.5" y="5303.5747">Retrieve Authentication request</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="5350.7734" y2="5350.7734"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="5350.7734" y2="5363.7734"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="5363.7734" y2="5363.7734"/><polygon fill="#181818" points="814.5,5359.7734,804.5,5363.7734,814.5,5367.7734,810.5,5363.7734" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="83" x="810.5" y="5345.7075">Check status</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="5392.9063" y2="5392.9063"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="5392.9063" y2="5405.9063"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="5405.9063" y2="5405.9063"/><polygon fill="#181818" points="814.5,5401.9063,804.5,5405.9063,814.5,5409.9063,810.5,5405.9063" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="90" x="810.5" y="5387.8403">Create tokens</text><polygon fill="#181818" points="319.5,5431.0391,309.5,5435.0391,319.5,5439.0391,315.5,5435.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="802.5" y1="5435.0391" y2="5435.0391"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="325.5" y="5429.9731">200 OK {...}</text><polygon fill="#181818" points="80.5,5460.1719,70.5,5464.1719,80.5,5468.1719,76.5,5464.1719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="5464.1719" y2="5464.1719"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="86.5" y="5459.106">200 OK {...}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="10" x2="2120" y1="5473.1719" y2="5473.1719"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="192" x="15" y="5483.3823">[Client Registered Ping Mode]</text><path d="M74,5491.9766 L74,5561.9766 L509,5561.9766 L509,5501.9766 L499,5491.9766 L74,5491.9766 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M499,5491.9766 L499,5501.9766 L509,5501.9766 L499,5491.9766 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="364" x="80" y="5509.0435">Ping mode is a simple notification by the AS to a callback</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="373" x="80" y="5524.1763">URL pre-registered by the Data Recipient App in Part 0. On</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="407" x="80" y="5539.3091">receipt the Data Recipient App can then call the Token endpoint</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="414" x="80" y="5554.4419">in the same way as in Poll mode and collect one-or-more tokens.</text><polygon fill="#181818" points="80.5,5584.6406,70.5,5588.6406,80.5,5592.6406,76.5,5588.6406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="74.5" x2="802.5" y1="5588.6406" y2="5588.6406"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="287" x="86.5" y="5583.5747">Authentication Request complete notification</text><polygon fill="#181818" points="791.5,5613.7734,801.5,5617.7734,791.5,5621.7734,795.5,5617.7734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="69.5" x2="797.5" y1="5617.7734" y2="5617.7734"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="101" x="76.5" y="5612.7075">204 No Content</text><polygon fill="#181818" points="296.5,5642.9063,306.5,5646.9063,296.5,5650.9063,300.5,5646.9063" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="5646.9063" y2="5646.9063"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="180" x="76.5" y="5641.8403">POST /token auth_req_id=...</text><polygon fill="#181818" points="2028.5,5672.0391,2038.5,5676.0391,2028.5,5680.0391,2032.5,5676.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="5676.0391" y2="5676.0391"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="5670.9731">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,5701.1719,309.5,5705.1719,319.5,5709.1719,315.5,5705.1719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="5705.1719" y2="5705.1719"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="5700.106">Response</text><polygon fill="#181818" points="791.5,5730.3047,801.5,5734.3047,791.5,5738.3047,795.5,5734.3047" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="797.5" y1="5734.3047" y2="5734.3047"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="180" x="315.5" y="5729.2388">POST /token auth_req_id=...</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="5763.4375" y2="5763.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="5763.4375" y2="5776.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="5776.4375" y2="5776.4375"/><polygon fill="#181818" points="814.5,5772.4375,804.5,5776.4375,814.5,5780.4375,810.5,5776.4375" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="202" x="810.5" y="5758.3716">Retrieve Authentication request</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="5805.5703" y2="5805.5703"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="5805.5703" y2="5818.5703"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="5818.5703" y2="5818.5703"/><polygon fill="#181818" points="814.5,5814.5703,804.5,5818.5703,814.5,5822.5703,810.5,5818.5703" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="90" x="810.5" y="5800.5044">Create tokens</text><polygon fill="#181818" points="319.5,5843.7031,309.5,5847.7031,319.5,5851.7031,315.5,5847.7031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="802.5" y1="5847.7031" y2="5847.7031"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="325.5" y="5842.6372">200 OK {...}</text><polygon fill="#181818" points="80.5,5872.8359,70.5,5876.8359,80.5,5880.8359,76.5,5876.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="5876.8359" y2="5876.8359"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="86.5" y="5871.77">200 OK {...}</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="10" x2="2120" y1="5885.8359" y2="5885.8359"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="195" x="15" y="5896.0464">[Client Registered Push Mode]</text><path d="M74,5904.6406 L74,5974.6406 L523,5974.6406 L523,5914.6406 L513,5904.6406 L74,5904.6406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M513,5904.6406 L513,5914.6406 L523,5914.6406 L513,5904.6406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="418" x="80" y="5921.7075">In Push mode tokens are created by the AS and then transmitted</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="428" x="80" y="5936.8403">to the Data Recipient App, therefore negating the need for them to</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="400" x="80" y="5951.9731">visit the Token endpoint. Their are various implications of using</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="248" x="80" y="5967.106">this method which are discussed in the</text><a href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.3" target="_top" title="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.3" xlink:actuate="onRequest" xlink:href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.3" xlink:show="new" xlink:title="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.3" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="79" x="332" y="5967.106">specification</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="411" y="5967.106">.</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="6001.3047" y2="6001.3047"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="6001.3047" y2="6014.3047"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="6014.3047" y2="6014.3047"/><polygon fill="#181818" points="814.5,6010.3047,804.5,6014.3047,814.5,6018.3047,810.5,6014.3047" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="202" x="810.5" y="5996.2388">Retrieve Authentication request</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="6043.4375" y2="6043.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="6043.4375" y2="6056.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="6056.4375" y2="6056.4375"/><polygon fill="#181818" points="814.5,6052.4375,804.5,6056.4375,814.5,6060.4375,810.5,6056.4375" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="90" x="810.5" y="6038.3716">Create tokens</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="6100.7031" y2="6100.7031"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="6100.7031" y2="6113.7031"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="6113.7031" y2="6113.7031"/><polygon fill="#181818" points="814.5,6109.7031,804.5,6113.7031,814.5,6117.7031,810.5,6113.7031" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="218" x="810.5" y="6080.5044">Retrieve callback URL and security</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="183" x="810.5" y="6095.6372">token for Data Recipient App</text><polygon fill="#181818" points="80.5,6138.8359,70.5,6142.8359,80.5,6146.8359,76.5,6142.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="74.5" x2="802.5" y1="6142.8359" y2="6142.8359"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="89" x="86.5" y="6137.77">POST /cb {...}</text><polygon fill="#181818" points="791.5,6167.9688,801.5,6171.9688,791.5,6175.9688,795.5,6171.9688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="69.5" x2="797.5" y1="6171.9688" y2="6171.9688"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="101" x="76.5" y="6166.9028">204 No Content</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2460" x="0" y="6207.5352"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="6207.5352" y2="6207.5352"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2460" y1="6210.5352" y2="6210.5352"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="367" x="1046.5" y="6196.9688"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="348" x="1052.5" y="6213.0356">Part 5: DR Makes Payment Instruction Request</text><path d="M74,6235.1016 L74,6305.1016 L496,6305.1016 L496,6245.1016 L486,6235.1016 L74,6235.1016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M486,6235.1016 L486,6245.1016 L496,6245.1016 L486,6235.1016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="401" x="80" y="6252.1685">With the Access Token in hand the Data Recipient App can now</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="368" x="80" y="6267.3013">make the payment instruction request. The Access Token</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="364" x="80" y="6282.4341">is bound to this single operation and will be revoked once</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="330" x="80" y="6297.5669">the payment instruction is successfully transmitted.</text><polygon fill="#181818" points="296.5,6327.7656,306.5,6331.7656,296.5,6335.7656,300.5,6331.7656" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="69.5" x2="302.5" y1="6331.7656" y2="6331.7656"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="215" x="76.5" y="6326.6997">POST /payments/v1/pix/payments</text><polygon fill="#181818" points="2028.5,6356.8984,2038.5,6360.8984,2028.5,6364.8984,2032.5,6360.8984" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="2034.5" y1="6360.8984" y2="6360.8984"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="315.5" y="6355.8325">Check Client Certificate Validity</text><polygon fill="#181818" points="319.5,6386.0313,309.5,6390.0313,319.5,6394.0313,315.5,6390.0313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="2039.5" y1="6390.0313" y2="6390.0313"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="325.5" y="6384.9653">Response</text><polygon fill="#181818" points="535.5,6415.1641,545.5,6419.1641,535.5,6423.1641,539.5,6419.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308.5" x2="541.5" y1="6419.1641" y2="6419.1641"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="215" x="315.5" y="6414.0981">POST /payments/v1/pix/payments</text><path d="M552,6432.1641 L552,6487.1641 L1085,6487.1641 L1085,6442.1641 L1075,6432.1641 L552,6432.1641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1075,6432.1641 L1075,6442.1641 L1085,6442.1641 L1075,6432.1641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="512" x="558" y="6449.231">The approach to Access Token introspection remains the same under payments</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="493" x="558" y="6464.3638">i.e. the API Gateway will need an assertion that indicates the consent granted</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="364" x="558" y="6479.4966">by the Customer matches the payment being instructed.</text><polygon fill="#181818" points="791.5,6509.6953,801.5,6513.6953,791.5,6517.6953,795.5,6513.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="797.5" y1="6513.6953" y2="6513.6953"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="554.5" y="6508.6294">Request Access Token properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="803.5" x2="845.5" y1="6542.8281" y2="6542.8281"/><line style="stroke:#181818;stroke-width:1.0;" x1="845.5" x2="845.5" y1="6542.8281" y2="6555.8281"/><line style="stroke:#181818;stroke-width:1.0;" x1="804.5" x2="845.5" y1="6555.8281" y2="6555.8281"/><polygon fill="#181818" points="814.5,6551.8281,804.5,6555.8281,814.5,6559.8281,810.5,6555.8281" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="810.5" y="6537.7622">Retrieve Access Token properties</text><polygon fill="#181818" points="558.5,6580.9609,548.5,6584.9609,558.5,6588.9609,554.5,6584.9609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="552.5" x2="802.5" y1="6584.9609" y2="6584.9609"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="564.5" y="6579.895">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="589.5" y1="6614.0938" y2="6614.0938"/><line style="stroke:#181818;stroke-width:1.0;" x1="589.5" x2="589.5" y1="6614.0938" y2="6627.0938"/><line style="stroke:#181818;stroke-width:1.0;" x1="548.5" x2="589.5" y1="6627.0938" y2="6627.0938"/><polygon fill="#181818" points="558.5,6623.0938,548.5,6627.0938,558.5,6631.0938,554.5,6627.0938" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="224" x="554.5" y="6609.0278">Introspect Access Token properties</text><path d="M552,6640.0938 L552,6710.0938 L1131,6710.0938 L1131,6650.0938 L1121,6640.0938 L552,6640.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1121,6640.0938 L1121,6650.0938 L1131,6650.0938 L1121,6640.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="437" x="558" y="6657.1606">On introspecting the Access Token the API Gateway will decorate the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="473" x="558" y="6672.2935">request with the debtor account which is stored with the Consent. This can</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="558" x="558" y="6687.4263">then be forwarded to the Backend Integration Application and used to make the correct</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="287" x="558" y="6702.5591">payment instruction in the Banking Systems.</text><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="589.5" y1="6736.7578" y2="6736.7578"/><line style="stroke:#181818;stroke-width:1.0;" x1="589.5" x2="589.5" y1="6736.7578" y2="6749.7578"/><line style="stroke:#181818;stroke-width:1.0;" x1="548.5" x2="589.5" y1="6749.7578" y2="6749.7578"/><polygon fill="#181818" points="558.5,6745.7578,548.5,6749.7578,558.5,6753.7578,554.5,6749.7578" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="242" x="554.5" y="6731.6919">Decorate request with debtor account</text><polygon fill="#181818" points="1294,6774.8906,1304,6778.8906,1294,6782.8906,1298,6778.8906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="1300" y1="6778.8906" y2="6778.8906"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="215" x="554.5" y="6773.8247">POST /payments/v1/pix/payments</text><path d="M1311,6791.8906 L1311,6846.8906 L1763,6846.8906 L1763,6801.8906 L1753,6791.8906 L1311,6791.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1753,6791.8906 L1753,6801.8906 L1763,6801.8906 L1753,6791.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="425" x="1317" y="6808.9575">This flow is non-normative and will vary on customer requirements.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="8" x="1317" y="6824.0903">It</text><text fill="#000000" font-family="Roboto" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="34" x="1329" y="6824.0903">could</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="381" x="1367" y="6824.0903">be to a PIX-compliant API or any other available mechanism</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="153" x="1317" y="6839.2231">to make a PIX payment.</text><line style="stroke:#181818;stroke-width:1.0;" x1="1306" x2="1348" y1="6873.4219" y2="6873.4219"/><line style="stroke:#181818;stroke-width:1.0;" x1="1348" x2="1348" y1="6873.4219" y2="6886.4219"/><line style="stroke:#181818;stroke-width:1.0;" x1="1307" x2="1348" y1="6886.4219" y2="6886.4219"/><polygon fill="#181818" points="1317,6882.4219,1307,6886.4219,1317,6890.4219,1313,6886.4219" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="158" x="1313" y="6868.356">Mediate request payload</text><polygon fill="#181818" points="1764.5,6911.5547,1774.5,6915.5547,1764.5,6919.5547,1768.5,6915.5547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1306" x2="1770.5" y1="6915.5547" y2="6915.5547"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="325" x="1313" y="6910.4888">Deliver payment instruction to Banking System API</text><polygon fill="#181818" points="1317,6940.6875,1307,6944.6875,1317,6948.6875,1313,6944.6875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1311" x2="1775.5" y1="6944.6875" y2="6944.6875"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1323" y="6939.6216">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="1306" x2="1348" y1="6973.8203" y2="6973.8203"/><line style="stroke:#181818;stroke-width:1.0;" x1="1348" x2="1348" y1="6973.8203" y2="6986.8203"/><line style="stroke:#181818;stroke-width:1.0;" x1="1307" x2="1348" y1="6986.8203" y2="6986.8203"/><polygon fill="#181818" points="1317,6982.8203,1307,6986.8203,1317,6990.8203,1313,6986.8203" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="168" x="1313" y="6968.7544">Mediate response payload</text><polygon fill="#181818" points="558.5,7027.0859,548.5,7031.0859,558.5,7035.0859,554.5,7031.0859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="552.5" x2="1305" y1="7031.0859" y2="7031.0859"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="564.5" y="7010.8872">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="114" x="564.5" y="7026.02">{paymentId: "..."}</text><polygon fill="#181818" points="319.5,7071.3516,309.5,7075.3516,319.5,7079.3516,315.5,7075.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313.5" x2="546.5" y1="7075.3516" y2="7075.3516"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="325.5" y="7055.1528">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="114" x="325.5" y="7070.2856">{paymentId: "..."}</text><polygon fill="#181818" points="80.5,7115.6172,70.5,7119.6172,80.5,7123.6172,76.5,7119.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="74.5" x2="307.5" y1="7119.6172" y2="7119.6172"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="86.5" y="7099.4185">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="114" x="86.5" y="7114.5513">{paymentId: "..."}</text><!--MD5=[d0681ae0815e52947cc7b1740a70db15]
@startuml CIBA_Example_Sequence

title \n\n\n
hide footbox

participant "Data\nRecipient\nApp" as DR

box Infrastructure #6FA8DC
participant "Ingress\nController" as INGRESS
participant "API\nGateway" as API_GATEWAY
end box

box Identity and Access Control #94c47d
participant "Identity Management\n- - -\nAuthorisation Server" as IAM
participant "Consent\nManagement" as CONSENT
end box

box Open Banking APIs #fc877e
participant "Bacend\nIntegration\nApplication" as BIA
end box

box Core Banking Applications #d5a6bd
participant "Banking\nIdentity\nProvider" as ASPSP_IDP
participant "Banking\nSystems" as ASPSP_API
end box

participant "Open Banking\nDirectory\n- - -\nJSON Web Key Set" as OBD_JWKS
participant "Certificate\nAuthority\n- - -\nOCSP Endpoint" as OCSP
participant "Mobile\nBanking\nApp" as MOBILE
actor "Customer" as PSU

hide footbox
skinparam defaultFontName Roboto
skinparam BoxPadding 10

== Part 0: Registration of Token Delivery Preferences ==

note right of DR
CIBA requires that Clients register a delivery mode prior to the
transmission of any Authentication Requests:
|||
[[https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.4 Clients registering to use CIBA MUST indicate a token delivery mode]]
|||
The Authorization Server (AS) therefore must host a registration
endpoint - defined in the discoverable OpenID Configuration -
that allows the Client to do so. The parameters for this call
are described in the CIBA specification and differ depending
on the method in question. The modes are:
|||
* **Poll**: Client polls the Token endpoint.
* **Ping**: AS notifies, Client retrieves from Token endpoint.
* **Push**: AS sends tokens to Client.
|||
The supported modes vary by AS as they are implementor specific i.e.
implementors of the AS can choose to only support one-or-more given
modes. The supported modes must be made pushed in the AS OpenID
Configuration.
end note

DR -> INGRESS: ""POST /connect/register""

note right of INGRESS
The Kubernetes Ingress Controller is responsible for TLS
termination and perfoming an OCSP call to the Certificate
Authority to ensure the client certificate presented is
valid. The fingerprint of the certificate will be forwarded
to Identity Management to verify the validity of the OAuth
Client as this cannot be asserted via OCSP.
end note

INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
'INGRESS -> API_GATEWAY: Registration Request

/'
note right of API_GATEWAY
The API Gateway acts as a proxy for both Identity and Consent
Management. This approach is designed to ensure all identity
and access control can be monitored and logged for analytics purposes
end note

API_GATEWAY -> IAM: Registration Request
IAM -> IAM: Verify Client
IAM -> IAM: Store Client Parameters
API_GATEWAY <- - IAM: Response
INGRESS <- - API_GATEWAY: Response
DR <- - INGRESS: Response
'/

INGRESS -> IAM: Registration Request
IAM -> IAM: Verify Client
IAM -> IAM: Store Client Parameters
INGRESS <- - IAM: Response
DR <- - INGRESS: Response

== Part 1: Create Consent and Send Authentication Request ==

note right of DR
The Data Recipient App requests an Access Token using
the Client Credentials grant type. Nominally authentication
is through Mutual Authentication over TLS but it could
equally be using ""private_key_jwt"".
end note

DR -> INGRESS: ""POST /oauth2/token""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /oauth2/token""
'API_GATEWAY -> IAM: ""POST /oauth2/token""
IAM -> IAM: Verify Client
'API_GATEWAY <- IAM: ""200 OK""\n""{"access_token": "..."}""
INGRESS <- - IAM: ""200 OK""\n""{"access_token": "..."}""
DR <- - INGRESS: ""200 OK""\n""{"access_token": "..."}""

note right of DR
With the Access Token in hand the Data Recipient can then
create the consent resource. This needs to be completed
before the Authentication Request as the value of the
""consentId"" is required to set the value of the scope.
end note

DR -> INGRESS: ""POST /payments/v1/consents""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/consents""
API_GATEWAY -> CONSENT: ""POST /payments/v1/consents""
CONSENT -> CONSENT: Validate consent request properties
API_GATEWAY <- - CONSENT: ""201 Created""\n""{consentId: "..."}""
INGRESS <- - API_GATEWAY: ""201 Created""\n""{consentId: "..."}""
DR <- - INGRESS: ""201 Created""\n""{consentId: "..."}""

note right of DR
The Data Recipient App can now create and send the Authentication
Request. This includes the dynamic scope that holds the value 
of the ""consentId"" returned by Identity Management.
end note

DR -> DR: Create Authentication Request
DR -> INGRESS: ""POST /bc-authorize""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
/'
INGRESS -> API_GATEWAY: ""POST /bc-authorize""

note right of API_GATEWAY
As with the redirection-based FAPI profiles the Authentication
Request is a JSON Web Signature. It therefore needs to be
checked for validity. Note that in the context of CIBA Pushed
Authorization Request is not required as the Authentication Request
is always sent via a secured backchannel and never through the browser.
end note

API_GATEWAY -> OBD_JWKS: Get JSON Web Key Set
API_GATEWAY <- - OBD_JWKS: Response
API_GATEWAY -> API_GATEWAY: Match Authentication\nRequest parameter ""kid""
API_GATEWAY -> API_GATEWAY: Verify Authentication\nRequest parameter signature
API_GATEWAY -> IAM: Forward Authentication Request
IAM -> IAM: Validate Authentication Request
'/

INGRESS -> IAM: ""POST /bc-authorize""

note right of IAM
As with the redirection-based FAPI profiles the Authentication
Request is a JSON Web Signature. It therefore needs to be
checked for validity. Note that in the context of CIBA Pushed
Authorization Request is not required as the Authentication Request
is always sent via a secured backchannel and never through the browser.
end note

IAM -> OBD_JWKS: Get JSON Web Key Set
IAM <- - OBD_JWKS: Response
IAM -> IAM: Match Authentication\nRequest parameter ""kid""
IAM -> IAM: Verify Authentication\nRequest parameter signature
IAM -> IAM: Validate Authentication Request

note right of IAM
Note this approach is non-normative and the actual
implementation required should be considered on a
case-by-case basis.
end note

IAM -> ASPSP_IDP: Send Authentication Request notification
INGRESS <- - IAM: ""201 Created""\n""{auth_req_id: "..."}""
DR <- - INGRESS: ""201 Created""\n""{auth_req_id: "..."}""

== Part 2: Customer Authenticates at Mobile Banking App ==

note right of ASPSP_IDP
The flow shown is a hypothetical approach to allowing
the End User to authenticate and confirm consent. In this
scenario has installed their mobile banking app and can
receive and act-on a request to authenticate and confirm
consent.
end note

ASPSP_IDP -> ASPSP_IDP: Correlate Authentication\nRequest with Customer
ASPSP_IDP -> ASPSP_API: Trigger push notification to Customer

note right of ASPSP_API
The push notification needs to carry some context.
For example, the ""consentId"" - to require the
consent to be correlated correctly.
end note

MOBILE <- ASPSP_API: Send push notification to mobile banking app
MOBILE -> PSU: Notify Customer

MOBILE <- - PSU: Tap notification
MOBILE -> PSU: Request biometric\ngesture to authenticate
MOBILE <- - PSU: Present biometric\ngesture

note right of ASPSP_IDP
As with the majority of mobile banking apps authentication
in this example is outsourced to the mobile operating system.
Once the customer has authenticated the mobile banking app
simply sends a "user authenticated" notification to the IDP.
|||
This flow is non-normative, implementation-specific and 
would be created based on the implementors architecture
and technology. 
end note

MOBILE -> ASPSP_IDP: User authenticated notification
MOBILE <- - ASPSP_IDP: Acknowledgement
MOBILE -> ASPSP_API: Request Customer accounts
MOBILE <- - ASPSP_API: Response

== Part 3: Customer Confirms Consent and Selects Account ==

note left of MOBILE
As Consent needs to be retrieved from a hostile security zone
i.e. from a Customer's mobile device the request to Consent
Management should be routed via the Ingress Controller/API
Gateway. This flow is implementation-specific and would be
created based on the implementors architecture and technology.
|||
In this example the Customer is the sole account
holder and therefore no further authorizations are required.
end note

MOBILE -> INGRESS: Retrieve consent
INGRESS -> API_GATEWAY: Retrieve consent
API_GATEWAY -> CONSENT: Retrieve consent
CONSENT -> CONSENT: Retrieve Consent
API_GATEWAY <- - CONSENT: Response
INGRESS <- - API_GATEWAY: Response
MOBILE <- - INGRESS: Response

note right of ASPSP_API
The Consent Confirmation screen requires the following properties to be displayed:
* Transaction Value.
* Recipient details (name, in Brazil CPF/CNPJ).
* Payment Date.
* Payment method (for example, in Brazil it is fixed as PIX).
* Fee amount charged by the bank (if any).
end note

par Request fee amount for payment

note right of ASPSP_API
Fees for payment must be provided from the Banking Systems
end note

MOBILE -> ASPSP_API: Request fee amount
MOBILE <- - ASPSP_API: Response

else

alt Debtor account not provided in Consent

note right of ASPSP_API
If the debtor account has not been provided in the Consent then
the customer's payment accounts will need to be retrieved:

* If the customer only has one payment account then this is the default.
* If they have multiple accounts they should be able to select one.

This should be incorporated into the Consent Confirmation screen.
end note

MOBILE -> MOBILE: Query account list for payment accounts

else Debtor account provided in Consent

note right of ASPSP_API
If the debtor account has already been provided ownership of the
account by the customer **must** be verified. In this example this
can be done at the Mobile Banking App as it has already retrieved
the list of customer accounts.
end note

MOBILE -> MOBILE: Verify debtor account ownership

end alt

end par

MOBILE -> MOBILE: Render consent\nconfirmation screen
MOBILE -> PSU: Request consent\nconfirmation
MOBILE <- - PSU: Confirm consent

MOBILE -> INGRESS: Update consent as authorized
INGRESS -> API_GATEWAY: Update consent as authorized
API_GATEWAY -> CONSENT: Update consent
CONSENT -> CONSENT: Update Consent
API_GATEWAY <- - CONSENT: Response
INGRESS <- - API_GATEWAY: Response
MOBILE <- - INGRESS: Response

note left of MOBILE
The final step is to call the Identity Management
component to indicate that the Customer has been
authenticated. Identity Management will then signal
to the Data Recipient App using the chosen mode that
authentication is complete. Again this flow is
implementation-specific and would be created based
on the implementors architecture and technology.
end note

'MOBILE -> API_GATEWAY: Authentication complete notification
'API_GATEWAY -> IAM: Forward authentication complete notification
MOBILE -> IAM: Authentication complete notification

== Part 4: Client Granted Access Token ==

note right of DR
Notes on Token behaviors
===
The Data Recipient App is made aware of the success of the
based on their registered delivery mode. Each of these is
shown below.
|||
Note that the Poll looping example is purely illustrative
as the Data Recipient App would poll as soon as they received
the ""auth_req_id"" from the AS. Writing the diagram to
incorporate this sequentially would, however be extremely confusing
hence the sequence shown below.
|||
For Poll and Ping mode the Data Recipient App must use the
[[https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.1 CIBA grant type]] as described in the source specification.
end note

alt Client Registered Poll Mode

note right of DR
In Poll mode the DR will periodically call the Token endpoint
until they get a positive response i.e. they do not receive
the 400 HTTP response code but instead are returned one-or-more
tokens (Access, Refresh, ID) from the Token endpoint.
end note

loop Exit when Authentication Request successful
DR -> INGRESS: ""POST /token auth_req_id=...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /token auth_req_id=...""
'API_GATEWAY -> IAM: ""POST /token auth_req_id=...""
IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Check status
'API_GATEWAY <- - IAM: ""400 Bad Request {...}""
INGRESS <- - IAM: ""400 Bad Request {...}""
DR <- - INGRESS: ""400 Bad Request {...}""
end loop

DR -> INGRESS: ""POST /token auth_req_id=...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
'INGRESS -> API_GATEWAY: ""POST /token auth_req_id=...""
INGRESS -> IAM: ""POST /token auth_req_id=...""
IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Check status
IAM -> IAM: Create tokens
'API_GATEWAY <- - IAM: ""200 OK {...}""
INGRESS <- - IAM: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

else Client Registered Ping Mode

note right of DR
Ping mode is a simple notification by the AS to a callback
URL pre-registered by the Data Recipient App in Part 0. On
receipt the Data Recipient App can then call the Token endpoint
in the same way as in Poll mode and collect one-or-more tokens.
end note

DR <- IAM: Authentication Request complete notification
DR - -> IAM: ""204 No Content""

DR -> INGRESS: ""POST /token auth_req_id=...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
'INGRESS -> API_GATEWAY: ""POST /token auth_req_id=...""
INGRESS -> IAM: ""POST /token auth_req_id=...""
IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Create tokens
'API_GATEWAY <- - IAM: ""200 OK {...}""
INGRESS <- - IAM: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

else Client Registered Push Mode

note right of DR
In Push mode tokens are created by the AS and then transmitted
to the Data Recipient App, therefore negating the need for them to
visit the Token endpoint. Their are various implications of using
this method which are discussed in the [[https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.3 specification]].
end note

IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Create tokens
IAM -> IAM: Retrieve callback URL and security\ntoken for Data Recipient App

DR <- IAM: ""POST /cb {...}""
DR - -> IAM: ""204 No Content""

end alt

== Part 5: DR Makes Payment Instruction Request ==

note right of DR
With the Access Token in hand the Data Recipient App can now
make the payment instruction request. The Access Token
is bound to this single operation and will be revoked once
the payment instruction is successfully transmitted.
end note

DR -> INGRESS: ""POST /payments/v1/pix/payments""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/pix/payments""

note right of API_GATEWAY
The approach to Access Token introspection remains the same under payments
i.e. the API Gateway will need an assertion that indicates the consent granted
by the Customer matches the payment being instructed.
end note

API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties

note right of API_GATEWAY
On introspecting the Access Token the API Gateway will decorate the
request with the debtor account which is stored with the Consent. This can
then be forwarded to the Backend Integration Application and used to make the correct
payment instruction in the Banking Systems.
end note

API_GATEWAY -> API_GATEWAY: Decorate request with debtor account
API_GATEWAY -> BIA: ""POST /payments/v1/pix/payments""

note right of BIA
This flow is non-normative and will vary on customer requirements.
It //could// be to a PIX-compliant API or any other available mechanism
to make a PIX payment.
end note

BIA -> BIA: Mediate request payload
BIA -> ASPSP_API: Deliver payment instruction to Banking System API
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""201 Created""\n""{paymentId: "..."}""
INGRESS <- - API_GATEWAY: ""201 Created""\n""{paymentId: "..."}""
DR <- - INGRESS: ""201 Created""\n""{paymentId: "..."}""

@enduml

@startuml CIBA_Example_Sequence

title \n\n\n
hide footbox

participant "Data\nRecipient\nApp" as DR

box Infrastructure #6FA8DC
participant "Ingress\nController" as INGRESS
participant "API\nGateway" as API_GATEWAY
end box

box Identity and Access Control #94c47d
participant "Identity Management\n- - -\nAuthorisation Server" as IAM
participant "Consent\nManagement" as CONSENT
end box

box Open Banking APIs #fc877e
participant "Bacend\nIntegration\nApplication" as BIA
end box

box Core Banking Applications #d5a6bd
participant "Banking\nIdentity\nProvider" as ASPSP_IDP
participant "Banking\nSystems" as ASPSP_API
end box

participant "Open Banking\nDirectory\n- - -\nJSON Web Key Set" as OBD_JWKS
participant "Certificate\nAuthority\n- - -\nOCSP Endpoint" as OCSP
participant "Mobile\nBanking\nApp" as MOBILE
actor "Customer" as PSU

hide footbox
skinparam defaultFontName Roboto
skinparam BoxPadding 10

== Part 0: Registration of Token Delivery Preferences ==

note right of DR
CIBA requires that Clients register a delivery mode prior to the
transmission of any Authentication Requests:
|||
[[https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.4 Clients registering to use CIBA MUST indicate a token delivery mode]]
|||
The Authorization Server (AS) therefore must host a registration
endpoint - defined in the discoverable OpenID Configuration -
that allows the Client to do so. The parameters for this call
are described in the CIBA specification and differ depending
on the method in question. The modes are:
|||
* **Poll**: Client polls the Token endpoint.
* **Ping**: AS notifies, Client retrieves from Token endpoint.
* **Push**: AS sends tokens to Client.
|||
The supported modes vary by AS as they are implementor specific i.e.
implementors of the AS can choose to only support one-or-more given
modes. The supported modes must be made pushed in the AS OpenID
Configuration.
end note

DR -> INGRESS: ""POST /connect/register""

note right of INGRESS
The Kubernetes Ingress Controller is responsible for TLS
termination and perfoming an OCSP call to the Certificate
Authority to ensure the client certificate presented is
valid. The fingerprint of the certificate will be forwarded
to Identity Management to verify the validity of the OAuth
Client as this cannot be asserted via OCSP.
end note

INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response


INGRESS -> IAM: Registration Request
IAM -> IAM: Verify Client
IAM -> IAM: Store Client Parameters
INGRESS <- - IAM: Response
DR <- - INGRESS: Response

== Part 1: Create Consent and Send Authentication Request ==

note right of DR
The Data Recipient App requests an Access Token using
the Client Credentials grant type. Nominally authentication
is through Mutual Authentication over TLS but it could
equally be using ""private_key_jwt"".
end note

DR -> INGRESS: ""POST /oauth2/token""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /oauth2/token""
IAM -> IAM: Verify Client
INGRESS <- - IAM: ""200 OK""\n""{"access_token": "..."}""
DR <- - INGRESS: ""200 OK""\n""{"access_token": "..."}""

note right of DR
With the Access Token in hand the Data Recipient can then
create the consent resource. This needs to be completed
before the Authentication Request as the value of the
""consentId"" is required to set the value of the scope.
end note

DR -> INGRESS: ""POST /payments/v1/consents""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/consents""
API_GATEWAY -> CONSENT: ""POST /payments/v1/consents""
CONSENT -> CONSENT: Validate consent request properties
API_GATEWAY <- - CONSENT: ""201 Created""\n""{consentId: "..."}""
INGRESS <- - API_GATEWAY: ""201 Created""\n""{consentId: "..."}""
DR <- - INGRESS: ""201 Created""\n""{consentId: "..."}""

note right of DR
The Data Recipient App can now create and send the Authentication
Request. This includes the dynamic scope that holds the value 
of the ""consentId"" returned by Identity Management.
end note

DR -> DR: Create Authentication Request
DR -> INGRESS: ""POST /bc-authorize""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response

INGRESS -> IAM: ""POST /bc-authorize""

note right of IAM
As with the redirection-based FAPI profiles the Authentication
Request is a JSON Web Signature. It therefore needs to be
checked for validity. Note that in the context of CIBA Pushed
Authorization Request is not required as the Authentication Request
is always sent via a secured backchannel and never through the browser.
end note

IAM -> OBD_JWKS: Get JSON Web Key Set
IAM <- - OBD_JWKS: Response
IAM -> IAM: Match Authentication\nRequest parameter ""kid""
IAM -> IAM: Verify Authentication\nRequest parameter signature
IAM -> IAM: Validate Authentication Request

note right of IAM
Note this approach is non-normative and the actual
implementation required should be considered on a
case-by-case basis.
end note

IAM -> ASPSP_IDP: Send Authentication Request notification
INGRESS <- - IAM: ""201 Created""\n""{auth_req_id: "..."}""
DR <- - INGRESS: ""201 Created""\n""{auth_req_id: "..."}""

== Part 2: Customer Authenticates at Mobile Banking App ==

note right of ASPSP_IDP
The flow shown is a hypothetical approach to allowing
the End User to authenticate and confirm consent. In this
scenario has installed their mobile banking app and can
receive and act-on a request to authenticate and confirm
consent.
end note

ASPSP_IDP -> ASPSP_IDP: Correlate Authentication\nRequest with Customer
ASPSP_IDP -> ASPSP_API: Trigger push notification to Customer

note right of ASPSP_API
The push notification needs to carry some context.
For example, the ""consentId"" - to require the
consent to be correlated correctly.
end note

MOBILE <- ASPSP_API: Send push notification to mobile banking app
MOBILE -> PSU: Notify Customer

MOBILE <- - PSU: Tap notification
MOBILE -> PSU: Request biometric\ngesture to authenticate
MOBILE <- - PSU: Present biometric\ngesture

note right of ASPSP_IDP
As with the majority of mobile banking apps authentication
in this example is outsourced to the mobile operating system.
Once the customer has authenticated the mobile banking app
simply sends a "user authenticated" notification to the IDP.
|||
This flow is non-normative, implementation-specific and 
would be created based on the implementors architecture
and technology. 
end note

MOBILE -> ASPSP_IDP: User authenticated notification
MOBILE <- - ASPSP_IDP: Acknowledgement
MOBILE -> ASPSP_API: Request Customer accounts
MOBILE <- - ASPSP_API: Response

== Part 3: Customer Confirms Consent and Selects Account ==

note left of MOBILE
As Consent needs to be retrieved from a hostile security zone
i.e. from a Customer's mobile device the request to Consent
Management should be routed via the Ingress Controller/API
Gateway. This flow is implementation-specific and would be
created based on the implementors architecture and technology.
|||
In this example the Customer is the sole account
holder and therefore no further authorizations are required.
end note

MOBILE -> INGRESS: Retrieve consent
INGRESS -> API_GATEWAY: Retrieve consent
API_GATEWAY -> CONSENT: Retrieve consent
CONSENT -> CONSENT: Retrieve Consent
API_GATEWAY <- - CONSENT: Response
INGRESS <- - API_GATEWAY: Response
MOBILE <- - INGRESS: Response

note right of ASPSP_API
The Consent Confirmation screen requires the following properties to be displayed:
* Transaction Value.
* Recipient details (name, in Brazil CPF/CNPJ).
* Payment Date.
* Payment method (for example, in Brazil it is fixed as PIX).
* Fee amount charged by the bank (if any).
end note

par Request fee amount for payment

note right of ASPSP_API
Fees for payment must be provided from the Banking Systems
end note

MOBILE -> ASPSP_API: Request fee amount
MOBILE <- - ASPSP_API: Response

else

alt Debtor account not provided in Consent

note right of ASPSP_API
If the debtor account has not been provided in the Consent then
the customer's payment accounts will need to be retrieved:

* If the customer only has one payment account then this is the default.
* If they have multiple accounts they should be able to select one.

This should be incorporated into the Consent Confirmation screen.
end note

MOBILE -> MOBILE: Query account list for payment accounts

else Debtor account provided in Consent

note right of ASPSP_API
If the debtor account has already been provided ownership of the
account by the customer **must** be verified. In this example this
can be done at the Mobile Banking App as it has already retrieved
the list of customer accounts.
end note

MOBILE -> MOBILE: Verify debtor account ownership

end alt

end par

MOBILE -> MOBILE: Render consent\nconfirmation screen
MOBILE -> PSU: Request consent\nconfirmation
MOBILE <- - PSU: Confirm consent

MOBILE -> INGRESS: Update consent as authorized
INGRESS -> API_GATEWAY: Update consent as authorized
API_GATEWAY -> CONSENT: Update consent
CONSENT -> CONSENT: Update Consent
API_GATEWAY <- - CONSENT: Response
INGRESS <- - API_GATEWAY: Response
MOBILE <- - INGRESS: Response

note left of MOBILE
The final step is to call the Identity Management
component to indicate that the Customer has been
authenticated. Identity Management will then signal
to the Data Recipient App using the chosen mode that
authentication is complete. Again this flow is
implementation-specific and would be created based
on the implementors architecture and technology.
end note

MOBILE -> IAM: Authentication complete notification

== Part 4: Client Granted Access Token ==

note right of DR
Notes on Token behaviors
===
The Data Recipient App is made aware of the success of the
based on their registered delivery mode. Each of these is
shown below.
|||
Note that the Poll looping example is purely illustrative
as the Data Recipient App would poll as soon as they received
the ""auth_req_id"" from the AS. Writing the diagram to
incorporate this sequentially would, however be extremely confusing
hence the sequence shown below.
|||
For Poll and Ping mode the Data Recipient App must use the
[[https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.1 CIBA grant type]] as described in the source specification.
end note

alt Client Registered Poll Mode

note right of DR
In Poll mode the DR will periodically call the Token endpoint
until they get a positive response i.e. they do not receive
the 400 HTTP response code but instead are returned one-or-more
tokens (Access, Refresh, ID) from the Token endpoint.
end note

loop Exit when Authentication Request successful
DR -> INGRESS: ""POST /token auth_req_id=...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /token auth_req_id=...""
IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Check status
INGRESS <- - IAM: ""400 Bad Request {...}""
DR <- - INGRESS: ""400 Bad Request {...}""
end loop

DR -> INGRESS: ""POST /token auth_req_id=...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /token auth_req_id=...""
IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Check status
IAM -> IAM: Create tokens
INGRESS <- - IAM: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

else Client Registered Ping Mode

note right of DR
Ping mode is a simple notification by the AS to a callback
URL pre-registered by the Data Recipient App in Part 0. On
receipt the Data Recipient App can then call the Token endpoint
in the same way as in Poll mode and collect one-or-more tokens.
end note

DR <- IAM: Authentication Request complete notification
DR - -> IAM: ""204 No Content""

DR -> INGRESS: ""POST /token auth_req_id=...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /token auth_req_id=...""
IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Create tokens
INGRESS <- - IAM: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

else Client Registered Push Mode

note right of DR
In Push mode tokens are created by the AS and then transmitted
to the Data Recipient App, therefore negating the need for them to
visit the Token endpoint. Their are various implications of using
this method which are discussed in the [[https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html#rfc.section.10.3 specification]].
end note

IAM -> IAM: Retrieve Authentication request
IAM -> IAM: Create tokens
IAM -> IAM: Retrieve callback URL and security\ntoken for Data Recipient App

DR <- IAM: ""POST /cb {...}""
DR - -> IAM: ""204 No Content""

end alt

== Part 5: DR Makes Payment Instruction Request ==

note right of DR
With the Access Token in hand the Data Recipient App can now
make the payment instruction request. The Access Token
is bound to this single operation and will be revoked once
the payment instruction is successfully transmitted.
end note

DR -> INGRESS: ""POST /payments/v1/pix/payments""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/pix/payments""

note right of API_GATEWAY
The approach to Access Token introspection remains the same under payments
i.e. the API Gateway will need an assertion that indicates the consent granted
by the Customer matches the payment being instructed.
end note

API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties

note right of API_GATEWAY
On introspecting the Access Token the API Gateway will decorate the
request with the debtor account which is stored with the Consent. This can
then be forwarded to the Backend Integration Application and used to make the correct
payment instruction in the Banking Systems.
end note

API_GATEWAY -> API_GATEWAY: Decorate request with debtor account
API_GATEWAY -> BIA: ""POST /payments/v1/pix/payments""

note right of BIA
This flow is non-normative and will vary on customer requirements.
It //could// be to a PIX-compliant API or any other available mechanism
to make a PIX payment.
end note

BIA -> BIA: Mediate request payload
BIA -> ASPSP_API: Deliver payment instruction to Banking System API
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""201 Created""\n""{paymentId: "..."}""
INGRESS <- - API_GATEWAY: ""201 Created""\n""{paymentId: "..."}""
DR <- - INGRESS: ""201 Created""\n""{paymentId: "..."}""

@enduml

PlantUML version 1.2022.7(Mon Aug 22 19:01:30 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>