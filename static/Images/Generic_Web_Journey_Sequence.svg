<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="10035px" preserveAspectRatio="none" style="width:2616px;height:10035px;background:#FFFFFF;" version="1.1" viewBox="0 0 2616 10035" width="2616px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="75.1875" id="_title" style="stroke:none;stroke-width:1.0;" width="15" x="1296.75" y="10"/><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1301.75" y="27.9951"> </text><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1301.75" y="44.292"> </text><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1301.75" y="60.5889"> </text><text fill="#000000" font-family="Roboto" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="1301.75" y="76.8857"> </text><rect fill="#6FA8DC" height="9930.125" style="stroke:#181818;stroke-width:0.5;" width="471" x="540.5" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="101" x="723" y="104.2544">Infrastructure</text><rect fill="#94C47D" height="9930.125" style="stroke:#181818;stroke-width:0.5;" width="380" x="1143.5" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="203" x="1229.5" y="104.2544">Identity and Access Control</text><rect fill="#E06666" height="9930.125" style="stroke:#181818;stroke-width:0.5;" width="152" x="1639.5" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="141" x="1642.5" y="104.2544">Open Banking APIs</text><rect fill="#D5A6BD" height="9930.125" style="stroke:#181818;stroke-width:0.5;" width="342.5" x="1886" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="195" x="1957.25" y="104.2544">Core Banking Applications</text><rect fill="#DDDDDD" height="9930.125" style="stroke:#181818;stroke-width:0.5;" width="194" x="2250.5" y="92.1875"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="176" x="2259.5" y="104.2544">Open Banking Directory</text><rect fill="none" height="384.5313" style="stroke:#000000;stroke-width:1.5;" width="2150" x="208.5" y="804.3984"/><rect fill="none" height="411.7969" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="1750.1172"/><rect fill="none" height="90.2031" style="stroke:#000000;stroke-width:1.5;" width="605" x="924.5" y="2383.8438"/><rect fill="none" height="182.9297" style="stroke:#000000;stroke-width:1.5;" width="2044" x="10" y="3787.5547"/><rect fill="none" height="780.125" style="stroke:#000000;stroke-width:1.5;" width="627" x="1860" y="4441.2734"/><rect fill="none" height="481.4609" style="stroke:#000000;stroke-width:1.5;" width="561" x="1870" y="4732.9375"/><rect fill="none" height="354.9297" style="stroke:#000000;stroke-width:1.5;" width="541" x="1880" y="4852.4688"/><rect fill="none" height="294.5938" style="stroke:#000000;stroke-width:1.5;" width="2348" x="10" y="5335.7969"/><rect fill="none" height="3056.4141" style="stroke:#000000;stroke-width:1.5;" width="2401" x="198.5" y="6954.8984"/><rect fill="none" height="630.9219" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="7082.6953"/><rect fill="none" height="661.1875" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="7727.6172"/><rect fill="none" height="834.1172" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="8555.5391"/><rect fill="none" height="600.6563" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="9403.6563"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="57" x2="57" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="257.5" x2="257.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="584.5" x2="584.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="970.5" x2="970.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1226.5" x2="1226.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1466.5" x2="1466.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1715" x2="1715" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1925" x2="1925" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2187.5" x2="2187.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2301.5" x2="2301.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2399.5" x2="2399.5" y1="175.2109" y2="10028.3125"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="2519.5" x2="2519.5" y1="175.2109" y2="10028.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="20" y="171.9092">Customer</text><ellipse cx="57" cy="107.4141" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M57,115.4141 L57,142.4141 M44,123.4141 L70,123.4141 M57,142.4141 L44,157.4141 M57,142.4141 L70,157.4141 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="79" x="218.5" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="242" y="147.6123">Data</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="225.5" y="163.9092">Recipient</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="81" x="544.5" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51" x="559.5" y="147.6123">Ingress</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67" x="551.5" y="163.9092">Controller</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="73" x="934.5" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21" x="960.5" y="147.6123">API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="941.5" y="163.9092">Gateway</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="159" x="1147.5" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="1154.5" y="131.3154">Identity Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="15" x="1219.5" y="147.6123">---</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139" x="1157.5" y="163.9092">Authorisation Server</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="1414.5" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="1437.5" y="147.6123">Consent</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1421.5" y="163.9092">Management</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="89" x="1671" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1685" y="131.3154">Backend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="1678.5" y="147.6123">Integration</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="1678" y="163.9092">Application</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="1890" y="111.3203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1897" y="131.3154">Banking</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="1900" y="147.6123">Identity</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1897" y="163.9092">Provider</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="73" x="2151.5" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="2160" y="147.6123">Banking</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="2158.5" y="163.9092">Systems</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="2254.5" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="2261.5" y="147.6123">Participants</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="23" x="2290" y="163.9092">List</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="2358.5" y="127.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="2365.5" y="147.6123">JSON Web</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="2373.5" y="163.9092">Key Set</text><rect fill="#E2E2F0" height="79.1875" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="119" x="2460.5" y="95.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69" x="2485.5" y="115.0186">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="2489.5" y="131.3154">Authority</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="15" x="2512.5" y="147.6123">---</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2467.5" y="163.9092">OCSP Endpoint</text><path d="M62,190.2109 L62,302.2109 L687,302.2109 L687,200.2109 L677,190.2109 L62,190.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M677,190.2109 L677,200.2109 L687,200.2109 L677,190.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="57" x="68" y="207.2778">Overview</text><line style="stroke:#181818;stroke-width:1.0;" x1="63" x2="686" y1="210.3438" y2="210.3438"/><line style="stroke:#181818;stroke-width:1.0;" x1="63" x2="686" y1="212.3438" y2="212.3438"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="589" x="68" y="226.4106">This diagram shows the end-to-end web journey for obtaining Consent and starting to collect</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="604" x="68" y="241.5435">Account Information data. The goal is to place the components from the Architecture Overview</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="67" x="68" y="256.6763">in context.</text><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="261.7422" y2="261.7422"/><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="261.7422" y2="261.7422"/><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="261.7422" y2="261.7422"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="596" x="68" y="275.8091">Note this diagram shows the means for the Client to authenticate at the Authorization Server</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="393" x="68" y="290.9419">as mutual authentication but this could equally be done using</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="97" x="465" y="290.9419">private_key_jwt</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="562" y="290.9419">.</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2609.5" x="0" y="328.5742"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="328.5742" y2="328.5742"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="331.5742" y2="331.5742"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="298" x="1155.75" y="318.0078"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="279" x="1161.75" y="334.0747">Part 1: DR Obtains Customer Consent</text><path d="M62,356.1406 L62,430.1406 L704,430.1406 L704,366.1406 L694,356.1406 L62,356.1406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M694,356.1406 L694,366.1406 L704,366.1406 L694,356.1406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="600" x="68" y="373.2075">Obtaining Consent from the Customer is usually outside the scope of technical standards. The</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="621" x="68" y="388.3403">Customer Experience Guidelines in Brazil informs how Consent should be displayed and obtained.</text><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="393.4063" y2="393.4063"/><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="393.4063" y2="393.4063"/><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="393.4063" y2="393.4063"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="542" x="68" y="407.4731">The specifics of this process are therefore not shown here. The Data Recipient (DR) is</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="424" x="68" y="422.606">assumed to have implemented this within the guidelines specified.</text><polygon fill="#181818" points="246,452.8047,256,456.8047,246,460.8047,250,456.8047" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="252" y1="456.8047" y2="456.8047"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="171" x="64" y="451.7388">Indicate wish to share data</text><polygon fill="#181818" points="68,512.2031,58,516.2031,68,520.2031,64,516.2031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="257" y1="516.2031" y2="516.2031"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="97" x="74" y="480.8716">Display "Intent"</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="153" x="74" y="496.0044">i.e. data to be accessed</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="152" x="74" y="511.1372">or payment to be made</text><polygon fill="#181818" points="246,541.3359,256,545.3359,246,549.3359,250,545.3359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="252" y1="545.3359" y2="545.3359"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="91" x="64" y="540.27">Confirm intent</text><polygon fill="#181818" points="68,570.4688,58,574.4688,68,578.4688,64,574.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="257" y1="574.4688" y2="574.4688"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="177" x="74" y="569.4028">Show bank selection screen</text><polygon fill="#181818" points="246,599.6016,256,603.6016,246,607.6016,250,603.6016" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="252" y1="603.6016" y2="603.6016"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="146" x="64" y="598.5356">Confirm bank selection</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2609.5" x="0" y="632.168"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="632.168" y2="632.168"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="635.168" y2="635.168"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="311" x="1149.25" y="621.6016"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="292" x="1155.25" y="637.6685">Part 2: DR Creates and Lodges "Intent"</text><path d="M263,659.7344 L263,699.7344 L1310,699.7344 L1310,669.7344 L1300,659.7344 L263,659.7344 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1300,659.7344 L1300,669.7344 L1310,669.7344 L1300,659.7344 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="1026" x="269" y="676.8013">With the consent of the Consumer obtained the DR can now call the Consent API at the correct bank. Note at this point Consent is usual termed "Intent" as it has</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="186" x="269" y="691.9341">yet to confirmed at the bank.</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="726.1328" y2="726.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="726.1328" y2="739.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="739.1328" y2="739.1328"/><polygon fill="#181818" points="269,735.1328,259,739.1328,269,743.1328,265,739.1328" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="138" x="265" y="721.0669">Create Intent payload</text><path d="M263,752.1328 L263,792.1328 L895,792.1328 L895,762.1328 L885,752.1328 L263,752.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M885,752.1328 L885,762.1328 L895,762.1328 L885,752.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="611" x="269" y="769.1997">Given the adherence to OpenID Connect Discovery in the standards DRs are expected to collect</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="376" x="269" y="784.3325">OpenID Configuration information from participating banks.</text><path d="M208.5,804.3984 L272.5,804.3984 L272.5,811.5313 L262.5,821.5313 L208.5,821.5313 L208.5,804.3984 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="384.5313" style="stroke:#000000;stroke-width:1.5;" width="2150" x="208.5" y="804.3984"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="223.5" y="817.4653">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="304" x="287.5" y="816.6089">[DR has cached OpenID Configuration for bank]</text><path d="M263,826.5313 L263,851.5313 L354,851.5313 L354,836.5313 L344,826.5313 L263,826.5313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M344,826.5313 L344,836.5313 L354,836.5313 L344,826.5313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="70" x="269" y="843.5981">Do nothing</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="208.5" x2="2358.5" y1="857.6641" y2="857.6641"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="288" x="213.5" y="867.8745">[DR retrieves OpenID Configuration for bank]</text><polygon fill="#181818" points="2289.5,888.6016,2299.5,892.6016,2289.5,896.6016,2293.5,892.6016" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="2295.5" y1="892.6016" y2="892.6016"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="144" x="265" y="887.5356">Get List of Participants</text><polygon fill="#181818" points="269,917.7344,259,921.7344,269,925.7344,265,921.7344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="2300.5" y1="921.7344" y2="921.7344"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="275" y="916.6685">Response</text><path d="M263,934.7344 L263,974.7344 L889,974.7344 L889,944.7344 L879,934.7344 L263,934.7344 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M879,934.7344 L879,944.7344 L889,944.7344 L879,934.7344 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="284" x="269" y="951.8013">The discovery endpoint value is stored in the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="176" x="557" y="951.8013">OpenIDDiscoveryDocument</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="137" x="737" y="951.8013">property of the banks</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="95" x="269" y="966.9341">entry in the list</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="1001.1328" y2="1001.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="1001.1328" y2="1014.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="1014.1328" y2="1014.1328"/><polygon fill="#181818" points="269,1010.1328,259,1014.1328,269,1018.1328,265,1014.1328" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="248" x="265" y="996.0669">Get Discovery endpoint for target bank</text><path d="M263,1027.1328 L263,1067.1328 L793,1067.1328 L793,1037.1328 L783,1027.1328 L263,1027.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M783,1027.1328 L783,1037.1328 L793,1037.1328 L783,1027.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="509" x="269" y="1044.1997">The OpenID Configuration is hosted at Authorization Server. This is an open URL</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="235" x="269" y="1059.3325">that does not require authentication.</text><polygon fill="#181818" points="573,1089.5313,583,1093.5313,573,1097.5313,577,1093.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="1093.5313" y2="1093.5313"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="235" x="265" y="1088.4653">GET /.well-known/openid-configuation</text><polygon fill="#181818" points="1215,1118.6641,1225,1122.6641,1215,1126.6641,1219,1122.6641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="1221" y1="1122.6641" y2="1122.6641"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="235" x="592" y="1117.5981">GET /.well-known/openid-configuation</text><polygon fill="#181818" points="596,1147.7969,586,1151.7969,596,1155.7969,592,1151.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="1226" y1="1151.7969" y2="1151.7969"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="602" y="1146.731">200 OK {...}</text><polygon fill="#181818" points="269,1176.9297,259,1180.9297,269,1184.9297,265,1180.9297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="1180.9297" y2="1180.9297"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="275" y="1175.8638">200 OK {...}</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="1232.1953" y2="1232.1953"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="1232.1953" y2="1245.1953"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="1245.1953" y2="1245.1953"/><polygon fill="#181818" points="269,1241.1953,259,1245.1953,269,1249.1953,265,1245.1953" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="148" x="265" y="1211.9966">Lookup Token endpoint</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="170" x="265" y="1227.1294">from OpenID Configuration</text><path d="M263,1258.1953 L263,1461.1953 L899,1461.1953 L899,1268.1953 L889,1258.1953 L263,1258.1953 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M889,1258.1953 L889,1268.1953 L899,1268.1953 L889,1258.1953 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="513" x="269" y="1275.2622">The DR then uses the Client Credentials grant to obtain an Access Token to then</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="295" x="269" y="1290.395">lodge the Consent on behalf of the Consumer.</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1295.4609" y2="1295.4609"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1295.4609" y2="1295.4609"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1295.4609" y2="1295.4609"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="471" x="269" y="1309.5278">These request will be made using Mutual TLS with a certificate signed by a</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="464" x="269" y="1324.6606">Certificate Authority whose certificate chain resolves at the Brazil ICP CA.</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1329.7266" y2="1329.7266"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1329.7266" y2="1329.7266"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1329.7266" y2="1329.7266"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="535" x="269" y="1343.7935">The Kubernetes Ingress Controller is responsible for TLS termination and performing</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="518" x="269" y="1358.9263">an OCSP call to the Certificate Authority to ensure the client certificate presented</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="517" x="269" y="1374.0591">is valid. The fingerprint of the certificate will be forwarded to Identity Management</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="489" x="269" y="1389.1919">to verify the validity of the OAuth Client as this cannot be asserted via OCSP.</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1394.2578" y2="1394.2578"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1394.2578" y2="1394.2578"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="1394.2578" y2="1394.2578"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="537" x="269" y="1408.3247">It should be noted that due to the adoption of the Mutual TLS profile for OAuth 2.0 in</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="27" x="269" y="1423.4575">FAPI</text><a href="https://tools.ietf.org/id/draft-ietf-oauth-mtls-08.html" target="_top" title="https://tools.ietf.org/id/draft-ietf-oauth-mtls-08.html" xlink:actuate="onRequest" xlink:href="https://tools.ietf.org/id/draft-ietf-oauth-mtls-08.html" xlink:show="new" xlink:title="https://tools.ietf.org/id/draft-ietf-oauth-mtls-08.html" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="39" x="300" y="1423.4575">(here)</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="371" x="343" y="1423.4575">many Authorization Servers will bind Access Tokens to the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="615" x="269" y="1438.5903">client certificate presented when they were created. This is indicated in the OpenID Configuration</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="173" x="269" y="1453.7231">through by the value of the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="274" x="446" y="1453.7231">tls_client_certificate_bound_access_tokens</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="58" x="724" y="1453.7231">property.</text><polygon fill="#181818" points="573,1483.9219,583,1487.9219,573,1491.9219,577,1487.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="1487.9219" y2="1487.9219"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="127" x="265" y="1482.856">POST /oauth2/token</text><polygon fill="#181818" points="2508,1513.0547,2518,1517.0547,2508,1521.0547,2512,1517.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="1517.0547" y2="1517.0547"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="1511.9888">Check Client Certificate Validity</text><polygon fill="#181818" points="596,1542.1875,586,1546.1875,596,1550.1875,592,1546.1875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="1546.1875" y2="1546.1875"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="1541.1216">Response</text><polygon fill="#181818" points="1215,1571.3203,1225,1575.3203,1215,1579.3203,1219,1575.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="1221" y1="1575.3203" y2="1575.3203"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="127" x="592" y="1570.2544">POST /oauth2/token</text><polygon fill="#181818" points="1215,1600.4531,1225,1604.4531,1215,1608.4531,1219,1604.4531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1221" y1="1604.4531" y2="1604.4531"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="127" x="978" y="1599.3872">POST /oauth2/token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="1633.5859" y2="1633.5859"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="1633.5859" y2="1646.5859"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="1646.5859" y2="1646.5859"/><polygon fill="#181818" points="1238,1642.5859,1228,1646.5859,1238,1650.5859,1234,1646.5859" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="76" x="1234" y="1628.52">Verify Client</text><polygon fill="#181818" points="596,1686.8516,586,1690.8516,596,1694.8516,592,1690.8516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="590" x2="1226" y1="1690.8516" y2="1690.8516"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="46" x="602" y="1670.6528">200 OK</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="143" x="602" y="1685.7856">{"access_token": "..."}</text><polygon fill="#181818" points="269,1731.1172,259,1735.1172,269,1739.1172,265,1735.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="1735.1172" y2="1735.1172"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="46" x="275" y="1714.9185">200 OK</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="143" x="275" y="1730.0513">{"access_token": "..."}</text><path d="M208.5,1750.1172 L272.5,1750.1172 L272.5,1757.25 L262.5,1767.25 L208.5,1767.25 L208.5,1750.1172 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="411.7969" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="1750.1172"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="223.5" y="1763.1841">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="259" x="287.5" y="1762.3276">[DR requires access to account for data]</text><path d="M263,1772.25 L263,1835.25 L707,1835.25 L707,1782.25 L697,1772.25 L263,1772.25 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M697,1772.25 L697,1782.25 L707,1782.25 L697,1772.25 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149" x="269" y="1789.3169">Account Information</text><line style="stroke:#181818;stroke-width:1.0;" x1="264" x2="706" y1="1792.3828" y2="1792.3828"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="423" x="269" y="1808.4497">DRs use a generic endpoint for Account Information that covers all</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="310" x="269" y="1823.5825">account types (checking, credit card, loans, etc).</text><polygon fill="#181818" points="573,1857.7813,583,1861.7813,573,1865.7813,577,1861.7813" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="1861.7813" y2="1861.7813"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="181" x="265" y="1856.7153">POST /consents/v1/consents</text><polygon fill="#181818" points="2508,1886.9141,2518,1890.9141,2508,1894.9141,2512,1890.9141" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="1890.9141" y2="1890.9141"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="1885.8481">Check Client Certificate Validity</text><polygon fill="#181818" points="596,1916.0469,586,1920.0469,596,1924.0469,592,1920.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="1920.0469" y2="1920.0469"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="1914.981">Response</text><polygon fill="#181818" points="959,1945.1797,969,1949.1797,959,1953.1797,963,1949.1797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="1949.1797" y2="1949.1797"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="181" x="592" y="1944.1138">POST /consents/v1/consents</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="208.5" x2="2589.5" y1="1958.1797" y2="1958.1797"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="330" x="213.5" y="1968.3901">[DR requires access to account to initiate payment]</text><path d="M263,1976.9844 L263,2039.9844 L672,2039.9844 L672,1986.9844 L662,1976.9844 L263,1976.9844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M662,1976.9844 L662,1986.9844 L672,1986.9844 L662,1976.9844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="134" x="269" y="1994.0513">Payment Initiation</text><line style="stroke:#181818;stroke-width:1.0;" x1="264" x2="671" y1="1997.1172" y2="1997.1172"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="388" x="269" y="2013.1841">Payment Initiation has a dedicated endpoint that will be used</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="259" x="269" y="2028.3169">to cover all payment rails (PIX, TED, etc).</text><polygon fill="#181818" points="573,2062.5156,583,2066.5156,573,2070.5156,577,2066.5156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="2066.5156" y2="2066.5156"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="187" x="265" y="2061.4497">POST /payments/v1/consents</text><polygon fill="#181818" points="2508,2091.6484,2518,2095.6484,2508,2099.6484,2512,2095.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="2095.6484" y2="2095.6484"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="2090.5825">Check Client Certificate Validity</text><polygon fill="#181818" points="596,2120.7813,586,2124.7813,596,2128.7813,592,2124.7813" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="2124.7813" y2="2124.7813"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="2119.7153">Response</text><polygon fill="#181818" points="959,2149.9141,969,2153.9141,959,2157.9141,963,2153.9141" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="2153.9141" y2="2153.9141"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="187" x="592" y="2148.8481">POST /payments/v1/consents</text><polygon fill="#181818" points="1215,2186.0469,1225,2190.0469,1215,2194.0469,1219,2190.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1221" y1="2190.0469" y2="2190.0469"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="155" x="978" y="2184.981">Introspect Access Token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="2219.1797" y2="2219.1797"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="2219.1797" y2="2232.1797"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="2232.1797" y2="2232.1797"/><polygon fill="#181818" points="1238,2228.1797,1228,2232.1797,1238,2236.1797,1234,2232.1797" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="1234" y="2214.1138">Retrieve Access Token properties</text><polygon fill="#181818" points="982,2257.3125,972,2261.3125,982,2265.3125,978,2261.3125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1226" y1="2261.3125" y2="2261.3125"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="988" y="2256.2466">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="2290.4453" y2="2290.4453"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="2290.4453" y2="2303.4453"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="2303.4453" y2="2303.4453"/><polygon fill="#181818" points="982,2299.4453,972,2303.4453,982,2307.4453,978,2303.4453" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="169" x="978" y="2285.3794">Verify Access Token scope</text><path d="M976,2316.4453 L976,2371.4453 L1595,2371.4453 L1595,2326.4453 L1585,2316.4453 L976,2316.4453 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1585,2316.4453 L1585,2326.4453 L1595,2326.4453 L1585,2316.4453 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="598" x="982" y="2333.5122">The consent management API provides separate operations based on the type of consent i.e.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="512" x="982" y="2348.645">account information, payments, etc. The API Gateway mediates the request and</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="371" x="982" y="2363.7778">calls the operation appropriate to the consent in question.</text><path d="M924.5,2383.8438 L988.5,2383.8438 L988.5,2390.9766 L978.5,2400.9766 L924.5,2400.9766 L924.5,2383.8438 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="90.2031" style="stroke:#000000;stroke-width:1.5;" width="605" x="924.5" y="2383.8438"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="939.5" y="2396.9106">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1003.5" y="2396.0542">[Account Information]</text><polygon fill="#181818" points="1455,2418.1094,1465,2422.1094,1455,2426.1094,1459,2422.1094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1461" y1="2422.1094" y2="2422.1094"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="181" x="978" y="2417.0435">POST /consents/v1/consents</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="924.5" x2="1529.5" y1="2431.1094" y2="2431.1094"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="123" x="929.5" y="2441.3198">[Payment Initation]</text><polygon fill="#181818" points="1455,2462.0469,1465,2466.0469,1455,2470.0469,1459,2466.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1461" y1="2466.0469" y2="2466.0469"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="187" x="978" y="2460.981">POST /payments/v1/consents</text><polygon fill="#181818" points="982,2513.3125,972,2517.3125,982,2521.3125,978,2517.3125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1466" y1="2517.3125" y2="2517.3125"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="988" y="2497.1138">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="118" x="988" y="2512.2466">{"consentId": "..."}</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="2546.4453" y2="2546.4453"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="2546.4453" y2="2559.4453"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="2559.4453" y2="2559.4453"/><polygon fill="#181818" points="982,2555.4453,972,2559.4453,982,2563.4453,978,2559.4453" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="109" x="978" y="2541.3794">Format response</text><polygon fill="#181818" points="596,2599.7109,586,2603.7109,596,2607.7109,592,2603.7109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="970" y1="2603.7109" y2="2603.7109"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="602" y="2583.5122">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="118" x="602" y="2598.645">{"consentId": "..."}</text><polygon fill="#181818" points="269,2643.9766,259,2647.9766,269,2651.9766,265,2647.9766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="2647.9766" y2="2647.9766"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="275" y="2627.7778">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="118" x="275" y="2642.9106">{"consentId": "..."}</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2609.5" x="0" y="2676.543"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="2676.543" y2="2676.543"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="2679.543" y2="2679.543"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="423" x="1093.25" y="2665.9766"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="404" x="1099.25" y="2682.0435">Part 3: Customer is Redirected to Authorization Server</text><path d="M263,2704.1094 L263,2949.1094 L944,2949.1094 L944,2714.1094 L934,2704.1094 L263,2704.1094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M934,2704.1094 L934,2714.1094 L944,2714.1094 L934,2704.1094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="141" x="269" y="2721.1763">API Security Profile</text><line style="stroke:#181818;stroke-width:1.0;" x1="264" x2="943" y1="2724.2422" y2="2724.2422"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="189" x="269" y="2740.3091">FAPI mandates the use of the</text><a href="https://openid.net/specs/openid-financial-api-part-2-ID2.html#authorization-server" target="_top" title="https://openid.net/specs/openid-financial-api-part-2-ID2.html#authorization-server" xlink:actuate="onRequest" xlink:href="https://openid.net/specs/openid-financial-api-part-2-ID2.html#authorization-server" xlink:show="new" xlink:title="https://openid.net/specs/openid-financial-api-part-2-ID2.html#authorization-server" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="192" x="462" y="2740.3091">Authentication Request object</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="115" x="658" y="2740.3091">which is defined in</text><a href="https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests" target="_top" title="https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests" xlink:actuate="onRequest" xlink:href="https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests" xlink:show="new" xlink:title="https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="60" x="777" y="2740.3091">Section 6</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="513" x="269" y="2755.4419">of OpenID Connect Core. This is a JSON Web Signature that contains parameters</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="365" x="269" y="2770.5747">normally found in the URL (redirect_uri, state, scope, etc)</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2775.6406" y2="2775.6406"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2775.6406" y2="2775.6406"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2775.6406" y2="2775.6406"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="261" x="269" y="2789.7075">However, FAPI has been extended by the</text><a href="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html" target="_top" title="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html" xlink:actuate="onRequest" xlink:href="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html" xlink:show="new" xlink:title="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="179" x="534" y="2789.7075">API Security Profile for Brazil</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="50" x="717" y="2789.7075">where 2</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="554" x="269" y="2804.8403">alternatives are added to the Authorization Server (AS) in terms of Request parameter</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="53" x="269" y="2819.9731">support:</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2825.0391" y2="2825.0391"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2825.0391" y2="2825.0391"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2825.0391" y2="2825.0391"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="342" x="269" y="2839.106">1. Request parameter passed in the URI that must be</text><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="615" y="2839.106">signed and encrypted</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="778" y="2839.106">.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="328" x="269" y="2854.2388">2. Request parameter passed by reference through</text><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-par" target="_top" title="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-par" xlink:actuate="onRequest" xlink:href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-par" xlink:show="new" xlink:title="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-par" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="238" x="601" y="2854.2388">Pushed Authorization Requests (PAR)</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="839" y="2854.2388">.</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2859.3047" y2="2859.3047"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2859.3047" y2="2859.3047"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2859.3047" y2="2859.3047"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="540" x="269" y="2873.3716">Support for either approach should be included in the OpenID Configuration available</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="524" x="269" y="2888.5044">through Discovery that banks are obliged to provide under the API Security Profile.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="317" x="269" y="2903.6372">Both options are shown in the sequence diagram.</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2908.7031" y2="2908.7031"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2908.7031" y2="2908.7031"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="2908.7031" y2="2908.7031"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="660" x="269" y="2922.77">Note that Amplify Open Banking will initially support the first approach, namely a signed</text><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="602" x="269" y="2937.9028">and encrypted JSON Web Token and introduce support for PAR in a later release.</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="2976.1016" y2="2976.1016"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="2976.1016" y2="2989.1016"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="2989.1016" y2="2989.1016"/><polygon fill="#181818" points="269,2985.1016,259,2989.1016,269,2993.1016,265,2989.1016" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="171" x="265" y="2971.0356">Create Request parameter</text><path d="M263,3002.1016 L263,3057.1016 L866,3057.1016 L866,3012.1016 L856,3002.1016 L263,3002.1016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M856,3002.1016 L856,3012.1016 L866,3012.1016 L856,3002.1016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="572" x="269" y="3019.1685">The Signing and Encryption keys will be the private part of the pair signed by the Directory</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="582" x="269" y="3034.3013">that can be referenced in the JSON Web Key Set maintained therein i.e. the key ID matches</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="199" x="269" y="3049.4341">one of the DRs JSON Web Keys.</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="3083.6328" y2="3083.6328"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="3083.6328" y2="3096.6328"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="3096.6328" y2="3096.6328"/><polygon fill="#181818" points="269,3092.6328,259,3096.6328,269,3100.6328,265,3096.6328" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="263" x="265" y="3078.5669">Sign Request parameter with Signing Key</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="3125.7656" y2="3125.7656"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="3125.7656" y2="3138.7656"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="3138.7656" y2="3138.7656"/><polygon fill="#181818" points="269,3134.7656,259,3138.7656,269,3142.7656,265,3138.7656" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="303" x="265" y="3120.6997">Encrypt Request parameter with Encryption Key</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="3167.8984" y2="3167.8984"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="3167.8984" y2="3180.8984"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="3180.8984" y2="3180.8984"/><polygon fill="#181818" points="269,3176.8984,259,3180.8984,269,3184.8984,265,3180.8984" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="313" x="265" y="3162.8325">Create redirect URL including Request parameter</text><polygon fill="#181818" points="68,3206.0313,58,3210.0313,68,3214.0313,64,3210.0313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="257" y1="3210.0313" y2="3210.0313"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="117" x="74" y="3204.9653">Redirect customer</text><polygon fill="#181818" points="1215,3235.1641,1225,3239.1641,1215,3243.1641,1219,3239.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="1221" y1="3239.1641" y2="3239.1641"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="161" x="64" y="3234.0981">GET /oauth2/authorize?...</text><path d="M1232,3252.1641 L1232,3307.1641 L1693,3307.1641 L1693,3262.1641 L1683,3252.1641 L1232,3252.1641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1683,3252.1641 L1683,3262.1641 L1693,3262.1641 L1683,3252.1641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="413" x="1238" y="3269.231">This is indicative as the Directory JWKS is likely to be cached for a</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="440" x="1238" y="3284.3638">period time i.e. the JWKS will not be retrieved on every Authentication</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="56" x="1238" y="3299.4966">Request.</text><polygon fill="#181818" points="2387.5,3329.6953,2397.5,3333.6953,2387.5,3337.6953,2391.5,3333.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="2393.5" y1="3333.6953" y2="3333.6953"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="143" x="1234" y="3328.6294">Get JSON Web Key Set</text><polygon fill="#181818" points="1238,3358.8281,1228,3362.8281,1238,3366.8281,1234,3362.8281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1232" x2="2398.5" y1="3362.8281" y2="3362.8281"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1244" y="3357.7622">Response</text><polygon fill="#181818" points="982,3387.9609,972,3391.9609,982,3395.9609,978,3391.9609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="976" x2="1226" y1="3391.9609" y2="3391.9609"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="167" x="988" y="3386.895">Match Request parameter</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="18" x="1159" y="3386.895">kid</text><polygon fill="#181818" points="982,3417.0938,972,3421.0938,982,3425.0938,978,3421.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="976" x2="1226" y1="3421.0938" y2="3421.0938"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="228" x="988" y="3416.0278">Verify Request parameter signature</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="3450.2266" y2="3450.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="3450.2266" y2="3463.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="3463.2266" y2="3463.2266"/><polygon fill="#181818" points="1238,3459.2266,1228,3463.2266,1238,3467.2266,1234,3463.2266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="164" x="1234" y="3445.1606">Verify Request parameter</text><polygon fill="#181818" points="1455,3488.3594,1465,3492.3594,1455,3496.3594,1459,3492.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1461" y1="3492.3594" y2="3492.3594"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="145" x="1234" y="3487.2935">Request Consent by ID</text><line style="stroke:#181818;stroke-width:1.0;" x1="1467" x2="1509" y1="3521.4922" y2="3521.4922"/><line style="stroke:#181818;stroke-width:1.0;" x1="1509" x2="1509" y1="3521.4922" y2="3534.4922"/><line style="stroke:#181818;stroke-width:1.0;" x1="1468" x2="1509" y1="3534.4922" y2="3534.4922"/><polygon fill="#181818" points="1478,3530.4922,1468,3534.4922,1478,3538.4922,1474,3534.4922" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="109" x="1474" y="3516.4263">Retrieve Consent</text><polygon fill="#181818" points="1238,3559.625,1228,3563.625,1238,3567.625,1234,3563.625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1232" x2="1466" y1="3563.625" y2="3563.625"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1244" y="3558.5591">Response</text><polygon fill="#181818" points="68,3588.7578,58,3592.7578,68,3596.7578,64,3592.7578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="62" x2="1226" y1="3592.7578" y2="3592.7578"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="124" x="74" y="3587.6919">Return redirect URL</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2609.5" x="0" y="3621.3242"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="3621.3242" y2="3621.3242"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="3624.3242" y2="3624.3242"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="433" x="1088.25" y="3610.7578"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="414" x="1094.25" y="3626.8247">Part 4: Customer Authenticates and Authorizes Consent</text><path d="M62,3648.8906 L62,3703.8906 L499,3703.8906 L499,3658.8906 L489,3648.8906 L62,3648.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M489,3648.8906 L489,3658.8906 L499,3658.8906 L489,3648.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="404" x="68" y="3665.9575">The following steps can vary according the bank's requirements</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="384" x="68" y="3681.0903">for authentication and authorization but these steps provide</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="416" x="68" y="3696.2231">an accurate overview in the context of the Amplify Open Banking.</text><polygon fill="#181818" points="1913,3726.4219,1923,3730.4219,1913,3734.4219,1917,3730.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="1919" y1="3730.4219" y2="3730.4219"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="94" x="64" y="3725.356">Follow Redirect</text><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="1967" y1="3759.5547" y2="3759.5547"/><line style="stroke:#181818;stroke-width:1.0;" x1="1967" x2="1967" y1="3759.5547" y2="3772.5547"/><line style="stroke:#181818;stroke-width:1.0;" x1="1926" x2="1967" y1="3772.5547" y2="3772.5547"/><polygon fill="#181818" points="1936,3768.5547,1926,3772.5547,1936,3776.5547,1932,3772.5547" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="89" x="1932" y="3754.4888">Verify redirect</text><path d="M10,3787.5547 L87,3787.5547 L87,3794.6875 L77,3804.6875 L10,3804.6875 L10,3787.5547 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="182.9297" style="stroke:#000000;stroke-width:1.5;" width="2044" x="10" y="3787.5547"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="25" y="3800.6216">loop</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="336" x="102" y="3799.7651">[Request required number of authentication factors]</text><path d="M62,3809.6875 L62,3864.6875 L436,3864.6875 L436,3819.6875 L426,3809.6875 L62,3809.6875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M426,3809.6875 L426,3819.6875 L436,3819.6875 L426,3809.6875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="327" x="68" y="3826.7544">This loop is intended to be indicative and the actual</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="308" x="68" y="3841.8872">mechanics are entirely dependent on the bank's</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="353" x="68" y="3857.02">implementation and their approach to user experience.</text><polygon fill="#181818" points="68,3887.2188,58,3891.2188,68,3895.2188,64,3891.2188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="1924" y1="3891.2188" y2="3891.2188"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="183" x="74" y="3886.1528">Serve credentials input page</text><polygon fill="#181818" points="1913,3916.3516,1923,3920.3516,1913,3924.3516,1917,3920.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="1919" y1="3920.3516" y2="3920.3516"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="120" x="64" y="3915.2856">Submit credentials</text><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="1967" y1="3949.4844" y2="3949.4844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1967" x2="1967" y1="3949.4844" y2="3962.4844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1926" x2="1967" y1="3962.4844" y2="3962.4844"/><polygon fill="#181818" points="1936,3958.4844,1926,3962.4844,1936,3966.4844,1932,3962.4844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="110" x="1932" y="3944.4185">Verify credentials</text><path d="M590,3982.4844 L590,4211.4844 L1197,4211.4844 L1197,3992.4844 L1187,3982.4844 L590,3982.4844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1187,3982.4844 L1187,3992.4844 L1197,3992.4844 L1187,3982.4844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="601.5" cy="3995.1172" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="575" x="607" y="3999.5513">Providing security for the Consent Management API should be reviewed on a case-by-case</text><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="456" x="596" y="4014.6841">basis and implemented according to customer requirements.</text><line style="stroke:#000000;stroke-width:0.5;" x1="596" x2="596" y1="4019.75" y2="4019.75"/><line style="stroke:#000000;stroke-width:0.5;" x1="596" x2="596" y1="4019.75" y2="4019.75"/><line style="stroke:#000000;stroke-width:0.5;" x1="596" x2="596" y1="4019.75" y2="4019.75"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="480" x="596" y="4033.8169">This diagram shows an example of access to the Consent Management API</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="430" x="596" y="4048.9497">being implemented via the Ingress Controller/API Gateway. Security</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="283" x="596" y="4064.0825">is provided via an internal certificate which is</text><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="24" x="883" y="4064.0825">not</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="58" x="911" y="4064.0825">validated</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="75" x="596" y="4079.2153">against ICP.</text><line style="stroke:#000000;stroke-width:0.5;" x1="596" x2="596" y1="4084.2813" y2="4084.2813"/><line style="stroke:#000000;stroke-width:0.5;" x1="596" x2="596" y1="4084.2813" y2="4084.2813"/><line style="stroke:#000000;stroke-width:0.5;" x1="596" x2="596" y1="4084.2813" y2="4084.2813"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="23" x="596" y="4098.3481">The</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="77" x="623" y="4098.3481">{operation}</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="335" x="704" y="4098.3481">parameter denotes either an Account Information or</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="331" x="596" y="4113.481">Payment Initiation consent. The possible values are:</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="596" y="4128.6138"> </text><ellipse cx="601.5" cy="4139.3125" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="58" x="607" y="4143.7466">consents</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="137" x="665" y="4143.7466">: Account Information</text><ellipse cx="601.5" cy="4154.4453" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="64" x="607" y="4158.8794">payments</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="123" x="671" y="4158.8794">: Payment Initiation</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="596" y="4174.0122"> </text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="77" x="596" y="4189.145">The value of</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="83" x="677" y="4189.145">{consent-id}</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="303" x="764" y="4189.145">must be retrieved from the requested scope as</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="390" x="596" y="4204.2778">this contains the consent resource identifier as defined in the</text><a href="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html#section-7.1.2" target="_top" title="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html#section-7.1.2" xlink:actuate="onRequest" xlink:href="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html#section-7.1.2" xlink:show="new" xlink:title="https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html#section-7.1.2" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="95" x="990" y="4204.2778">Security Profile</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="1085" y="4204.2778">.</text><polygon fill="#181818" points="596,4234.4766,586,4238.4766,596,4242.4766,592,4238.4766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="590" x2="1924" y1="4238.4766" y2="4238.4766"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="362" x="602" y="4233.4106">GET ​/open-banking​/{operation}/v1/consent/{consent-id}</text><polygon fill="#181818" points="959,4263.6094,969,4267.6094,959,4271.6094,963,4267.6094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="4267.6094" y2="4267.6094"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="362" x="592" y="4262.5435">GET ​/open-banking​/{operation}/v1/consent/{consent-id}</text><polygon fill="#181818" points="1455,4292.7422,1465,4296.7422,1455,4300.7422,1459,4296.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1461" y1="4296.7422" y2="4296.7422"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="362" x="978" y="4291.6763">GET ​/open-banking​/{operation}/v1/consent/{consent-id}</text><line style="stroke:#181818;stroke-width:1.0;" x1="1467" x2="1509" y1="4325.875" y2="4325.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="1509" x2="1509" y1="4325.875" y2="4338.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="1468" x2="1509" y1="4338.875" y2="4338.875"/><polygon fill="#181818" points="1478,4334.875,1468,4338.875,1478,4342.875,1474,4338.875" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="103" x="1474" y="4320.8091">Retrieve "Intent"</text><polygon fill="#181818" points="982,4364.0078,972,4368.0078,982,4372.0078,978,4368.0078" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1466" y1="4368.0078" y2="4368.0078"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="988" y="4362.9419">200 OK {...}</text><polygon fill="#181818" points="596,4393.1406,586,4397.1406,596,4401.1406,592,4397.1406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="970" y1="4397.1406" y2="4397.1406"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="602" y="4392.0747">200 OK {...}</text><polygon fill="#181818" points="1913,4422.2734,1923,4426.2734,1913,4430.2734,1917,4426.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="585" x2="1919" y1="4426.2734" y2="4426.2734"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="592" y="4421.2075">200 OK {...}</text><path d="M1860,4441.2734 L1924,4441.2734 L1924,4448.4063 L1914,4458.4063 L1860,4458.4063 L1860,4441.2734 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="780.125" style="stroke:#000000;stroke-width:1.5;" width="627" x="1860" y="4441.2734"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="1875" y="4454.3403">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="196" x="1939" y="4453.4839">[Account Information Consent]</text><path d="M1930,4463.4063 L1930,4571.4063 L2295,4571.4063 L2295,4473.4063 L2285,4463.4063 L1930,4463.4063 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2285,4463.4063 L2285,4473.4063 L2295,4473.4063 L2285,4463.4063 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149" x="1936" y="4480.4731">Account Information</text><line style="stroke:#181818;stroke-width:1.0;" x1="1931" x2="2294" y1="4483.5391" y2="4483.5391"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="331" x="1936" y="4499.606">When creating the Consent Confirmation screen the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="307" x="1936" y="4514.7388">permission codes held in the "Intent" need to be</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="342" x="1936" y="4529.8716">converted to something that will be meaningful to the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="344" x="1936" y="4545.0044">Customer. The wording should adhere to that detailed</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="36" x="1936" y="4560.1372">in the</text><a href="https://github.com/OpenBanking-Brasil/areadesenvolvedor/raw/gh-pages/documents/GuiaDeExperienciaDoUsuarioCompartilhamentoDeDadosEIniciacaoDePagamento_v3.02.03.pdf" target="_top" title="https://github.com/OpenBanking-Brasil/areadesenvolvedor/raw/gh-pages/documents/GuiaDeExperienciaDoUsuarioCompartilhamentoDeDadosEIniciacaoDePagamento_v3.02.03.pdf" xlink:actuate="onRequest" xlink:href="https://github.com/OpenBanking-Brasil/areadesenvolvedor/raw/gh-pages/documents/GuiaDeExperienciaDoUsuarioCompartilhamentoDeDadosEIniciacaoDePagamento_v3.02.03.pdf" xlink:show="new" xlink:title="https://github.com/OpenBanking-Brasil/areadesenvolvedor/raw/gh-pages/documents/GuiaDeExperienciaDoUsuarioCompartilhamentoDeDadosEIniciacaoDePagamento_v3.02.03.pdf" xlink:type="simple"><text fill="#0000FF" font-family="Roboto" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="207" x="1976" y="4560.1372">Customer Experience Guidelines</text></a><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="2183" y="4560.1372">.</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1860" x2="2487" y1="4578.2031" y2="4578.2031"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="184" x="1865" y="4588.4136">[Payment Initiation Consent]</text><path d="M1930,4597.0078 L1930,4720.0078 L2477,4720.0078 L2477,4607.0078 L2467,4597.0078 L1930,4597.0078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2467,4597.0078 L2467,4607.0078 L2477,4607.0078 L2467,4597.0078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="134" x="1936" y="4614.0747">Payment Initiation</text><line style="stroke:#181818;stroke-width:1.0;" x1="1931" x2="2476" y1="4617.1406" y2="4617.1406"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="526" x="1936" y="4633.2075">The Consent Confirmation screen requires the following properties to be displayed:</text><ellipse cx="1941.5" cy="4643.9063" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="118" x="1947" y="4648.3403">Transaction Value.</text><ellipse cx="1941.5" cy="4659.0391" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="225" x="1947" y="4663.4731">Recipient details (name, CPF/CNPJ).</text><ellipse cx="1941.5" cy="4674.1719" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="96" x="1947" y="4678.606">Payment Date.</text><ellipse cx="1941.5" cy="4689.3047" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="262" x="1947" y="4693.7388">Payment method (currently fixed on PIX).</text><ellipse cx="1941.5" cy="4704.4375" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="264" x="1947" y="4708.8716">Fee amount charged by the bank (if any).</text><path d="M1870,4732.9375 L1940,4732.9375 L1940,4740.0703 L1930,4750.0703 L1870,4750.0703 L1870,4732.9375 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="481.4609" style="stroke:#000000;stroke-width:1.5;" width="561" x="1870" y="4732.9375"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="1885" y="4746.0044">par</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="220" x="1955" y="4745.1479">[Request fee amount for payment]</text><path d="M1930,4755.0703 L1930,4780.0703 L2353,4780.0703 L2353,4765.0703 L2343,4755.0703 L1930,4755.0703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2343,4755.0703 L2343,4765.0703 L2353,4765.0703 L2343,4755.0703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="402" x="1936" y="4772.1372">Fees for payment must be provided from the Banking Systems</text><polygon fill="#181818" points="2176,4802.3359,2186,4806.3359,2176,4810.3359,2180,4806.3359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="2182" y1="4806.3359" y2="4806.3359"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="130" x="1932" y="4801.27">Request fee amount</text><polygon fill="#181818" points="1936,4831.4688,1926,4835.4688,1936,4839.4688,1932,4835.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1930" x2="2187" y1="4835.4688" y2="4835.4688"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1942" y="4830.4028">Response</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1870" x2="2431" y1="4844.4688" y2="4844.4688"/><path d="M1880,4852.4688 L1944,4852.4688 L1944,4859.6016 L1934,4869.6016 L1880,4869.6016 L1880,4852.4688 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="354.9297" style="stroke:#000000;stroke-width:1.5;" width="541" x="1880" y="4852.4688"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="1895" y="4865.5356">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="266" x="1959" y="4864.6792">[Debtor account not provided in Consent]</text><path d="M1930,4874.6016 L1930,4989.6016 L2411,4989.6016 L2411,4884.6016 L2401,4874.6016 L1930,4874.6016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2401,4874.6016 L2401,4884.6016 L2411,4884.6016 L2401,4874.6016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="410" x="1936" y="4891.6685">If the debtor account has not been provided in the Consent then</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="379" x="1936" y="4906.8013">the customer's payment accounts will need to be retrieved:</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="1936" y="4921.9341"> </text><ellipse cx="1941.5" cy="4932.6328" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="449" x="1947" y="4937.0669">If the customer only has one payment account then this is the default.</text><ellipse cx="1941.5" cy="4947.7656" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="411" x="1947" y="4952.1997">If they have multiple accounts they should be able to select one.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="1936" y="4967.3325"> </text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="423" x="1936" y="4982.4653">This should be incorporated into the Consent Confirmation screen.</text><polygon fill="#181818" points="2176,5012.6641,2186,5016.6641,2176,5020.6641,2180,5016.6641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="2182" y1="5016.6641" y2="5016.6641"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="233" x="1932" y="5011.5981">Request in-scope payment accounts</text><polygon fill="#181818" points="1936,5041.7969,1926,5045.7969,1936,5049.7969,1932,5045.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1930" x2="2187" y1="5045.7969" y2="5045.7969"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1942" y="5040.731">Response</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1880" x2="2421" y1="5054.7969" y2="5054.7969"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="241" x="1885" y="5065.0073">[Debtor account provided in Consent]</text><path d="M1930,5073.6016 L1930,5143.6016 L2394,5143.6016 L2394,5083.6016 L2384,5073.6016 L1930,5073.6016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2384,5073.6016 L2384,5083.6016 L2394,5083.6016 L2384,5073.6016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="415" x="1936" y="5090.6685">If the debtor account has already been provided ownership of the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="160" x="1936" y="5105.8013">account by the customer</text><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="37" x="2100" y="5105.8013">must</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="219" x="2141" y="5105.8013">be verified. This must be executed</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="406" x="1936" y="5120.9341">at the Banking Systems as they will understand the relationship</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="443" x="1936" y="5136.0669">between a (now authenticated) customer and the accounts they own.</text><polygon fill="#181818" points="2176,5166.2656,2186,5170.2656,2176,5174.2656,2180,5170.2656" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="2182" y1="5170.2656" y2="5170.2656"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="159" x="1932" y="5165.1997">Verify account ownership</text><polygon fill="#181818" points="1936,5195.3984,1926,5199.3984,1936,5203.3984,1932,5199.3984" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1930" x2="2187" y1="5199.3984" y2="5199.3984"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1942" y="5194.3325">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="1967" y1="5249.5313" y2="5249.5313"/><line style="stroke:#181818;stroke-width:1.0;" x1="1967" x2="1967" y1="5249.5313" y2="5262.5313"/><line style="stroke:#181818;stroke-width:1.0;" x1="1926" x2="1967" y1="5262.5313" y2="5262.5313"/><polygon fill="#181818" points="1936,5258.5313,1926,5262.5313,1936,5266.5313,1932,5262.5313" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="235" x="1932" y="5244.4653">Render Consent Confirmation screen</text><polygon fill="#181818" points="68,5287.6641,58,5291.6641,68,5295.6641,64,5291.6641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="1924" y1="5291.6641" y2="5291.6641"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="227" x="74" y="5286.5981">Serve Consent Confirmation screen</text><polygon fill="#181818" points="1913,5316.7969,1923,5320.7969,1913,5324.7969,1917,5320.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="1919" y1="5320.7969" y2="5320.7969"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="168" x="64" y="5315.731">Confirm consent is correct</text><path d="M10,5335.7969 L74,5335.7969 L74,5342.9297 L64,5352.9297 L10,5352.9297 L10,5335.7969 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="294.5938" style="stroke:#000000;stroke-width:1.5;" width="2348" x="10" y="5335.7969"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="5348.8638">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="196" x="89" y="5348.0073">[Account Information Consent]</text><path d="M1930,5357.9297 L1930,5465.9297 L2348,5465.9297 L2348,5367.9297 L2338,5357.9297 L1930,5357.9297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2338,5357.9297 L2338,5367.9297 L2348,5367.9297 L2338,5357.9297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149" x="1936" y="5374.9966">Account Information</text><line style="stroke:#181818;stroke-width:1.0;" x1="1931" x2="2347" y1="5378.0625" y2="5378.0625"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="393" x="1936" y="5394.1294">Once consent has been confirmed by the Customer the list of</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="397" x="1936" y="5409.2622">in-scope accounts will be retrieved from the Banking Systems.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="368" x="1936" y="5424.395">This list will obviously be dictated by the permission codes</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="195" x="1936" y="5439.5278">requested by the DR i.e. if only</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="115" x="2135" y="5439.5278">ACCOUNTS_READ</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="79" x="2254" y="5439.5278">is requested</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="282" x="1936" y="5454.6606">then all other account types can be ignored.</text><polygon fill="#181818" points="2176,5488.8594,2186,5492.8594,2176,5496.8594,2180,5492.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="2182" y1="5492.8594" y2="5492.8594"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="239" x="1932" y="5487.7935">Request in-scope Customer accounts</text><polygon fill="#181818" points="1936,5517.9922,1926,5521.9922,1936,5525.9922,1932,5521.9922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1930" x2="2187" y1="5521.9922" y2="5521.9922"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1942" y="5516.9263">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="1925" x2="1967" y1="5551.125" y2="5551.125"/><line style="stroke:#181818;stroke-width:1.0;" x1="1967" x2="1967" y1="5551.125" y2="5564.125"/><line style="stroke:#181818;stroke-width:1.0;" x1="1926" x2="1967" y1="5564.125" y2="5564.125"/><polygon fill="#181818" points="1936,5560.125,1926,5564.125,1936,5568.125,1932,5564.125" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="211" x="1932" y="5546.0591">Render Account Selection screen</text><polygon fill="#181818" points="68,5589.2578,58,5593.2578,68,5597.2578,64,5593.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="1924" y1="5593.2578" y2="5593.2578"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="203" x="74" y="5588.1919">Serve Account Selection screen</text><polygon fill="#181818" points="1913,5618.3906,1923,5622.3906,1913,5626.3906,1917,5622.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="1919" y1="5622.3906" y2="5622.3906"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="152" x="64" y="5617.3247">Send Account Selection</text><path d="M590,5642.3906 L590,5705.3906 L1072,5705.3906 L1072,5652.3906 L1062,5642.3906 L590,5642.3906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1062,5642.3906 L1062,5652.3906 L1072,5652.3906 L1062,5642.3906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="130" x="596" y="5659.4575">Payment Initation</text><line style="stroke:#181818;stroke-width:1.0;" x1="591" x2="1071" y1="5662.5234" y2="5662.5234"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="461" x="596" y="5678.5903">The consent is updated with the granted accounts. Note for for Payment</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="54" x="596" y="5693.7231">Initiation</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="76" x="654" y="5693.7231">account_ids</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="101" x="734" y="5693.7231">can be omitted.</text><polygon fill="#181818" points="596,5743.0547,586,5747.0547,596,5751.0547,592,5747.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="590" x2="1924" y1="5747.0547" y2="5747.0547"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="307" x="602" y="5726.856">POST /open-banking/{operation}/{login}/accept</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="130" x="602" y="5741.9888">{ account_ids: [...] }</text><polygon fill="#181818" points="959,5787.3203,969,5791.3203,959,5795.3203,963,5791.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="5791.3203" y2="5791.3203"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="307" x="592" y="5771.1216">POST /open-banking/{operation}/{login}/accept</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="130" x="592" y="5786.2544">{ account_ids: [...] }</text><polygon fill="#181818" points="1455,5831.5859,1465,5835.5859,1455,5839.5859,1459,5835.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1461" y1="5835.5859" y2="5835.5859"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="307" x="978" y="5815.3872">POST /open-banking/{operation}/{login}/accept</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="130" x="978" y="5830.52">{ account_ids: [...] }</text><line style="stroke:#181818;stroke-width:1.0;" x1="1467" x2="1509" y1="5864.7188" y2="5864.7188"/><line style="stroke:#181818;stroke-width:1.0;" x1="1509" x2="1509" y1="5864.7188" y2="5877.7188"/><line style="stroke:#181818;stroke-width:1.0;" x1="1468" x2="1509" y1="5877.7188" y2="5877.7188"/><polygon fill="#181818" points="1478,5873.7188,1468,5877.7188,1478,5881.7188,1474,5877.7188" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="207" x="1474" y="5859.6528">Update "Intent" with Account IDs</text><line style="stroke:#181818;stroke-width:1.0;" x1="1467" x2="1509" y1="5906.8516" y2="5906.8516"/><line style="stroke:#181818;stroke-width:1.0;" x1="1509" x2="1509" y1="5906.8516" y2="5919.8516"/><line style="stroke:#181818;stroke-width:1.0;" x1="1468" x2="1509" y1="5919.8516" y2="5919.8516"/><polygon fill="#181818" points="1478,5915.8516,1468,5919.8516,1478,5923.8516,1474,5919.8516" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="107" x="1474" y="5901.7856">Mark Consent as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="84" x="1585" y="5901.7856">AUTHORISED</text><polygon fill="#181818" points="982,5944.9844,972,5948.9844,982,5952.9844,978,5948.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1466" y1="5948.9844" y2="5948.9844"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="165" x="988" y="5943.9185">200 OK {redirect_to: "..."}</text><polygon fill="#181818" points="596,5974.1172,586,5978.1172,596,5982.1172,592,5978.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="970" y1="5978.1172" y2="5978.1172"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="165" x="602" y="5973.0513">200 OK {redirect_to: "..."}</text><polygon fill="#181818" points="1913,6003.25,1923,6007.25,1913,6011.25,1917,6007.25" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="585" x2="1919" y1="6007.25" y2="6007.25"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="165" x="592" y="6002.1841">200 OK {redirect_to: "..."}</text><path d="M62,6020.25 L62,6139.25 L548,6139.25 L548,6030.25 L538,6020.25 L62,6020.25 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M538,6020.25 L538,6030.25 L548,6030.25 L538,6020.25 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="465" x="68" y="6037.3169">The Customer is redirected back to the Amplify Open Banking stack from</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="425" x="68" y="6052.4497">the bank's Identity Provider in order to complete Hybrid Flow, using</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="100" x="68" y="6067.5825">the value of the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="72" x="172" y="6067.5825">redirect_uri</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="216" x="248" y="6067.5825">property returned in the response</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="205" x="68" y="6082.7153">from the call to the consent API.</text><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="6087.7813" y2="6087.7813"/><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="6087.7813" y2="6087.7813"/><line style="stroke:#000000;stroke-width:0.5;" x1="68" x2="68" y1="6087.7813" y2="6087.7813"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="429" x="68" y="6101.8481">The hand-off is constrained using a number of parameters included</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="404" x="68" y="6116.981">in the redirect URI to help safeguard this process i.e. to prevent</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="360" x="68" y="6132.1138">unsolicited authentication attempts or session takeover.</text><polygon fill="#181818" points="68,6177.4453,58,6181.4453,68,6185.4453,64,6181.4453" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="1924" y1="6181.4453" y2="6181.4453"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="119" x="74" y="6161.2466">Redirect Customer</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="182" x="74" y="6176.3794">back to Authorization Server</text><polygon fill="#181818" points="573,6206.5781,583,6210.5781,573,6214.5781,577,6210.5781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="579" y1="6210.5781" y2="6210.5781"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="91" x="64" y="6205.5122">Follow redirect</text><polygon fill="#181818" points="1215,6235.7109,1225,6239.7109,1215,6243.7109,1219,6239.7109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="1221" y1="6239.7109" y2="6239.7109"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="182" x="592" y="6234.645">Forward redirect parameters</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="6268.8438" y2="6268.8438"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="6268.8438" y2="6281.8438"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="6281.8438" y2="6281.8438"/><polygon fill="#181818" points="1238,6277.8438,1228,6281.8438,1238,6285.8438,1234,6281.8438" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="89" x="1234" y="6263.7778">Verify redirect</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="6326.1094" y2="6326.1094"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="6326.1094" y2="6339.1094"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="6339.1094" y2="6339.1094"/><polygon fill="#181818" points="1238,6335.1094,1228,6339.1094,1238,6343.1094,1234,6339.1094" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="153" x="1234" y="6305.9106">Mint Authorization Code</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="83" x="1234" y="6321.0435">and ID Token</text><path d="M1232,6352.1094 L1232,6422.1094 L1656,6422.1094 L1656,6362.1094 L1646,6352.1094 L1232,6352.1094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1646,6352.1094 L1646,6362.1094 L1656,6362.1094 L1646,6352.1094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="399" x="1238" y="6369.1763">At this point the Identity Management module mints a redirect</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="403" x="1238" y="6384.3091">URI that will take the Customer back to the Data Recipient App.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="392" x="1238" y="6399.4419">The URI includes the Authorization Code and parameters that</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="274" x="1238" y="6414.5747">adhere to the API Security Profile for Brazil.</text><polygon fill="#181818" points="596,6444.7734,586,6448.7734,596,6452.7734,592,6448.7734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="1226" y1="6448.7734" y2="6448.7734"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="95" x="602" y="6443.7075">Return redirect</text><polygon fill="#181818" points="68,6473.9063,58,6477.9063,68,6481.9063,64,6477.9063" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="62" x2="584" y1="6477.9063" y2="6477.9063"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="119" x="74" y="6472.8403">Redirect Customer</text><polygon fill="#181818" points="246,6503.0391,256,6507.0391,246,6511.0391,250,6507.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="57" x2="252" y1="6507.0391" y2="6507.0391"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="94" x="64" y="6501.9731">Follow Redirect</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2609.5" x="0" y="6535.6055"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="6535.6055" y2="6535.6055"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="6538.6055" y2="6538.6055"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="425" x="1092.25" y="6525.0391"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="406" x="1098.25" y="6541.106">Part 5: DR Swaps Authorization Code for Access Token</text><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="300" y1="6594.4375" y2="6594.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="300" x2="300" y1="6594.4375" y2="6607.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="259" x2="300" y1="6607.4375" y2="6607.4375"/><polygon fill="#181818" points="269,6603.4375,259,6607.4375,269,6611.4375,265,6607.4375" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="149" x="265" y="6574.2388">Verify redirect including</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="281" x="265" y="6589.3716">ID Token signature, nonce and s_hash value</text><polygon fill="#181818" points="573,6632.5703,583,6636.5703,573,6640.5703,577,6636.5703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="6636.5703" y2="6636.5703"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="127" x="265" y="6631.5044">POST /oauth2/token</text><polygon fill="#181818" points="2508,6661.7031,2518,6665.7031,2508,6669.7031,2512,6665.7031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="6665.7031" y2="6665.7031"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="6660.6372">Check Client Certificate Validity</text><polygon fill="#181818" points="596,6690.8359,586,6694.8359,596,6698.8359,592,6694.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="6694.8359" y2="6694.8359"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="6689.77">Response</text><polygon fill="#181818" points="1215,6719.9688,1225,6723.9688,1215,6727.9688,1219,6723.9688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="1221" y1="6723.9688" y2="6723.9688"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="127" x="592" y="6718.9028">POST /oauth2/token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="6753.1016" y2="6753.1016"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="6753.1016" y2="6766.1016"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="6766.1016" y2="6766.1016"/><polygon fill="#181818" points="1238,6762.1016,1228,6766.1016,1238,6770.1016,1234,6766.1016" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="150" x="1234" y="6748.0356">Validate Token Request</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="6795.2344" y2="6795.2344"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="6795.2344" y2="6808.2344"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="6808.2344" y2="6808.2344"/><polygon fill="#181818" points="1238,6804.2344,1228,6808.2344,1238,6812.2344,1234,6808.2344" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="226" x="1234" y="6790.1685">Mint ID, Access and Refresh Tokens</text><polygon fill="#181818" points="596,6848.5,586,6852.5,596,6856.5,592,6852.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="1226" y1="6852.5" y2="6852.5"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="46" x="602" y="6832.3013">200 OK</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="143" x="602" y="6847.4341">{"access_token": "..."}</text><polygon fill="#181818" points="269,6892.7656,259,6896.7656,269,6900.7656,265,6896.7656" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="6896.7656" y2="6896.7656"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="46" x="275" y="6876.5669">200 OK</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="143" x="275" y="6891.6997">{"access_token": "..."}</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2609.5" x="0" y="6925.332"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="6925.332" y2="6925.332"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2609.5" y1="6928.332" y2="6928.332"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="366" x="1121.75" y="6914.7656"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="347" x="1127.75" y="6930.8325">Part 6: Data Recipient Gets Data from Account</text><path d="M198.5,6954.8984 L262.5,6954.8984 L262.5,6962.0313 L252.5,6972.0313 L198.5,6972.0313 L198.5,6954.8984 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="3056.4141" style="stroke:#000000;stroke-width:1.5;" width="2401" x="198.5" y="6954.8984"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="213.5" y="6967.9653">alt</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="139" x="277.5" y="6967.1089">[Account Information]</text><path d="M263,6977.0313 L263,7070.0313 L697,7070.0313 L697,6987.0313 L687,6977.0313 L263,6977.0313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M687,6977.0313 L687,6987.0313 L697,6987.0313 L687,6977.0313 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149" x="269" y="6994.0981">Account Information</text><line style="stroke:#181818;stroke-width:1.0;" x1="264" x2="696" y1="6997.1641" y2="6997.1641"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="334" x="269" y="7013.231">The retrieval of account data happens in two stages:</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="269" y="7028.3638"> </text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="413" x="269" y="7043.4966">1. The DR requests the available resources at the Resources API.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="406" x="269" y="7058.6294">2. Using the identifiers returned they can request account data.</text><path d="M208.5,7082.6953 L450.5,7082.6953 L450.5,7089.8281 L440.5,7099.8281 L208.5,7099.8281 L208.5,7082.6953 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="630.9219" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="7082.6953"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="197" x="223.5" y="7095.7622">Get all resource identifiers</text><path d="M263,7104.8281 L263,7159.8281 L689,7159.8281 L689,7114.8281 L679,7104.8281 L263,7104.8281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M679,7104.8281 L679,7114.8281 L689,7114.8281 L679,7104.8281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="141" x="269" y="7121.895">The DR will require the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="121" x="414" y="7121.895">RESOURCES_READ</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="135" x="539" y="7121.895">permission to access</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="21" x="269" y="7137.0278">the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="67" x="294" y="7137.0278">/resources</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="305" x="365" y="7137.0278">endpoint. If Customer has not consented to this</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="312" x="269" y="7152.1606">the request should be rejected (not shown here).</text><polygon fill="#181818" points="573,7197.4922,583,7201.4922,573,7205.4922,577,7201.4922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="7201.4922" y2="7201.4922"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="182" x="265" y="7181.2935">GET /resources/v1/resources</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="152" x="265" y="7196.4263">Authorization: Bearer ...</text><polygon fill="#181818" points="2508,7226.625,2518,7230.625,2508,7234.625,2512,7230.625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="7230.625" y2="7230.625"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="7225.5591">Check Client Certificate Validity</text><polygon fill="#181818" points="596,7255.7578,586,7259.7578,596,7263.7578,592,7259.7578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="7259.7578" y2="7259.7578"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="7254.6919">Response</text><polygon fill="#181818" points="959,7300.0234,969,7304.0234,959,7308.0234,963,7304.0234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="7304.0234" y2="7304.0234"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="182" x="592" y="7283.8247">GET /resources/v1/resources</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="152" x="592" y="7298.9575">Authorization: Bearer ...</text><polygon fill="#181818" points="1215,7329.1563,1225,7333.1563,1215,7337.1563,1219,7333.1563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1221" y1="7333.1563" y2="7333.1563"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="978" y="7328.0903">Request Access Token properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="7362.2891" y2="7362.2891"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="7362.2891" y2="7375.2891"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="7375.2891" y2="7375.2891"/><polygon fill="#181818" points="1238,7371.2891,1228,7375.2891,1238,7379.2891,1234,7375.2891" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="1234" y="7357.2231">Retrieve Access Token properties</text><polygon fill="#181818" points="982,7400.4219,972,7404.4219,982,7408.4219,978,7404.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1226" y1="7404.4219" y2="7404.4219"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="988" y="7399.356">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="7433.5547" y2="7433.5547"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="7433.5547" y2="7446.5547"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="7446.5547" y2="7446.5547"/><polygon fill="#181818" points="982,7442.5547,972,7446.5547,982,7450.5547,978,7446.5547" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="224" x="978" y="7428.4888">Introspect Access Token properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="7475.6875" y2="7475.6875"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="7475.6875" y2="7488.6875"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="7488.6875" y2="7488.6875"/><polygon fill="#181818" points="982,7484.6875,972,7488.6875,982,7492.6875,978,7488.6875" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="138" x="978" y="7470.6216">Apply access controls</text><polygon fill="#181818" points="1703.5,7513.8203,1713.5,7517.8203,1703.5,7521.8203,1707.5,7517.8203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1709.5" y1="7517.8203" y2="7517.8203"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="182" x="978" y="7512.7544">GET /resources/v1/resources</text><polygon fill="#181818" points="2176,7542.9531,2186,7546.9531,2176,7550.9531,2180,7546.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="2182" y1="7546.9531" y2="7546.9531"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="238" x="1722.5" y="7541.8872">Get available resources for Customer</text><polygon fill="#181818" points="1726.5,7572.0859,1716.5,7576.0859,1726.5,7580.0859,1722.5,7576.0859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1720.5" x2="2187" y1="7576.0859" y2="7576.0859"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1732.5" y="7571.02">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="1757.5" y1="7605.2188" y2="7605.2188"/><line style="stroke:#181818;stroke-width:1.0;" x1="1757.5" x2="1757.5" y1="7605.2188" y2="7618.2188"/><line style="stroke:#181818;stroke-width:1.0;" x1="1716.5" x2="1757.5" y1="7618.2188" y2="7618.2188"/><polygon fill="#181818" points="1726.5,7614.2188,1716.5,7618.2188,1726.5,7622.2188,1722.5,7618.2188" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="168" x="1722.5" y="7600.1528">Mediate response payload</text><polygon fill="#181818" points="982,7643.3516,972,7647.3516,982,7651.3516,978,7647.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1714.5" y1="7647.3516" y2="7647.3516"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="133" x="988" y="7642.2856">200 OK { "data": ... }</text><polygon fill="#181818" points="596,7672.4844,586,7676.4844,596,7680.4844,592,7676.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="970" y1="7676.4844" y2="7676.4844"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="133" x="602" y="7671.4185">200 OK { "data": ... }</text><polygon fill="#181818" points="269,7701.6172,259,7705.6172,269,7709.6172,265,7705.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="7705.6172" y2="7705.6172"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="133" x="275" y="7700.5513">200 OK { "data": ... }</text><path d="M208.5,7727.6172 L285.5,7727.6172 L285.5,7734.75 L275.5,7744.75 L208.5,7744.75 L208.5,7727.6172 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="661.1875" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="7727.6172"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="223.5" y="7740.6841">loop</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="225" x="300.5" y="7739.8276">[For each Account ID returned from</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="67" x="529.5" y="7739.8276">/resources</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="5" x="596.5" y="7739.8276">]</text><path d="M263,7749.75 L263,7834.75 L677,7834.75 L677,7759.75 L667,7749.75 L263,7749.75 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M667,7749.75 L667,7759.75 L677,7759.75 L667,7749.75 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="392" x="269" y="7766.8169">In this example the DR only has access to checking accounts.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="126" x="269" y="7781.9497">They will require the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="115" x="399" y="7781.9497">ACCOUNTS_READ</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="135" x="518" y="7781.9497">permission to access</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="21" x="269" y="7797.0825">the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="225" x="294" y="7797.0825">/accounts/v1/accounts/{accountId}</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="138" x="523" y="7797.0825">endpoint. If Customer</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="393" x="269" y="7812.2153">has not consented to this the request should be rejected (not</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="82" x="269" y="7827.3481">shown here).</text><polygon fill="#181818" points="573,7872.6797,583,7876.6797,573,7880.6797,577,7876.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="7876.6797" y2="7876.6797"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="254" x="265" y="7856.481">GET /accounts/v1/accounts/{accountId}</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="152" x="265" y="7871.6138">Authorization: Bearer ...</text><polygon fill="#181818" points="2508,7901.8125,2518,7905.8125,2508,7909.8125,2512,7905.8125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="7905.8125" y2="7905.8125"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="7900.7466">Check Client Certificate Validity</text><polygon fill="#181818" points="596,7930.9453,586,7934.9453,596,7938.9453,592,7934.9453" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="7934.9453" y2="7934.9453"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="7929.8794">Response</text><polygon fill="#181818" points="959,7975.2109,969,7979.2109,959,7983.2109,963,7979.2109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="7979.2109" y2="7979.2109"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="254" x="592" y="7959.0122">GET /accounts/v1/accounts/{accountId}</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="152" x="592" y="7974.145">Authorization: Bearer ...</text><polygon fill="#181818" points="1215,8004.3438,1225,8008.3438,1215,8012.3438,1219,8008.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1221" y1="8008.3438" y2="8008.3438"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="978" y="8003.2778">Request Access Token properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="8037.4766" y2="8037.4766"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="8037.4766" y2="8050.4766"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="8050.4766" y2="8050.4766"/><polygon fill="#181818" points="1238,8046.4766,1228,8050.4766,1238,8054.4766,1234,8050.4766" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="1234" y="8032.4106">Retrieve Access Token properties</text><polygon fill="#181818" points="982,8075.6094,972,8079.6094,982,8083.6094,978,8079.6094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1226" y1="8079.6094" y2="8079.6094"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="988" y="8074.5435">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="8108.7422" y2="8108.7422"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="8108.7422" y2="8121.7422"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="8121.7422" y2="8121.7422"/><polygon fill="#181818" points="982,8117.7422,972,8121.7422,982,8125.7422,978,8121.7422" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="224" x="978" y="8103.6763">Introspect Access Token properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="8150.875" y2="8150.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="8150.875" y2="8163.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="8163.875" y2="8163.875"/><polygon fill="#181818" points="982,8159.875,972,8163.875,982,8167.875,978,8163.875" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="138" x="978" y="8145.8091">Apply access controls</text><polygon fill="#181818" points="1703.5,8189.0078,1713.5,8193.0078,1703.5,8197.0078,1707.5,8193.0078" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1709.5" y1="8193.0078" y2="8193.0078"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="254" x="978" y="8187.9419">GET /accounts/v1/accounts/{accountId}</text><polygon fill="#181818" points="2176,8218.1406,2186,8222.1406,2176,8226.1406,2180,8222.1406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="2182" y1="8222.1406" y2="8222.1406"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="147" x="1722.5" y="8217.0747">Get requested account</text><polygon fill="#181818" points="1726.5,8247.2734,1716.5,8251.2734,1726.5,8255.2734,1722.5,8251.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1720.5" x2="2187" y1="8251.2734" y2="8251.2734"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1732.5" y="8246.2075">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="1757.5" y1="8280.4063" y2="8280.4063"/><line style="stroke:#181818;stroke-width:1.0;" x1="1757.5" x2="1757.5" y1="8280.4063" y2="8293.4063"/><line style="stroke:#181818;stroke-width:1.0;" x1="1716.5" x2="1757.5" y1="8293.4063" y2="8293.4063"/><polygon fill="#181818" points="1726.5,8289.4063,1716.5,8293.4063,1726.5,8297.4063,1722.5,8293.4063" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="168" x="1722.5" y="8275.3403">Mediate response payload</text><polygon fill="#181818" points="982,8318.5391,972,8322.5391,982,8326.5391,978,8322.5391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1714.5" y1="8322.5391" y2="8322.5391"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="133" x="988" y="8317.4731">200 OK { "data": ... }</text><polygon fill="#181818" points="596,8347.6719,586,8351.6719,596,8355.6719,592,8351.6719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="970" y1="8351.6719" y2="8351.6719"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="133" x="602" y="8346.606">200 OK { "data": ... }</text><polygon fill="#181818" points="269,8376.8047,259,8380.8047,269,8384.8047,265,8380.8047" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="8380.8047" y2="8380.8047"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="133" x="275" y="8375.7388">200 OK { "data": ... }</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="198.5" x2="2599.5" y1="8396.8047" y2="8396.8047"/><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="127" x="203.5" y="8407.0151">[Payment Initiation]</text><path d="M263,8415.6094 L263,8542.6094 L757,8542.6094 L757,8425.6094 L747,8415.6094 L263,8415.6094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M747,8415.6094 L747,8425.6094 L757,8425.6094 L747,8415.6094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="134" x="269" y="8432.6763">Payment Initiation</text><line style="stroke:#181818;stroke-width:1.0;" x1="264" x2="756" y1="8435.7422" y2="8435.7422"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="473" x="269" y="8451.8091">The DR can now make the payment instruction request. The Access Token</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="450" x="269" y="8466.9419">is bound to this single operation and will be revoked once the payment</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="244" x="269" y="8482.0747">instruction is successfully transmitted.</text><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="8487.1406" y2="8487.1406"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="8487.1406" y2="8487.1406"/><line style="stroke:#000000;stroke-width:0.5;" x1="269" x2="269" y1="8487.1406" y2="8487.1406"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="438" x="269" y="8501.2075">Note that in cases where multiple authorizations are required the DR</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="195" x="269" y="8516.3403">will receive and indicator in the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="40" x="468" y="8516.3403">status</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="149" x="512" y="8516.3403">property with a value of</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="32" x="269" y="8531.4731">PART</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="4" x="301" y="8531.4731">.</text><path d="M208.5,8555.5391 L499.5,8555.5391 L499.5,8562.6719 L489.5,8572.6719 L208.5,8572.6719 L208.5,8555.5391 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="834.1172" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="8555.5391"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="246" x="223.5" y="8568.606">Create payment initation request</text><polygon fill="#181818" points="573,8589.8047,583,8593.8047,573,8597.8047,577,8593.8047" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="8593.8047" y2="8593.8047"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="215" x="265" y="8588.7388">POST /payments/v1/pix/payments</text><polygon fill="#181818" points="2508,8618.9375,2518,8622.9375,2508,8626.9375,2512,8622.9375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="8622.9375" y2="8622.9375"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="8617.8716">Check Client Certificate Validity</text><polygon fill="#181818" points="596,8648.0703,586,8652.0703,596,8656.0703,592,8652.0703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="8652.0703" y2="8652.0703"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="8647.0044">Response</text><polygon fill="#181818" points="959,8677.2031,969,8681.2031,959,8685.2031,963,8681.2031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="8681.2031" y2="8681.2031"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="215" x="592" y="8676.1372">POST /payments/v1/pix/payments</text><path d="M976,8694.2031 L976,8749.2031 L1509,8749.2031 L1509,8704.2031 L1499,8694.2031 L976,8694.2031 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1499,8694.2031 L1499,8704.2031 L1509,8704.2031 L1499,8694.2031 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="512" x="982" y="8711.27">The approach to Access Token introspection remains the same under payments</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="493" x="982" y="8726.4028">i.e. the API Gateway will need an assertion that indicates the consent granted</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="364" x="982" y="8741.5356">by the Customer matches the payment being instructed.</text><polygon fill="#181818" points="1215,8771.7344,1225,8775.7344,1215,8779.7344,1219,8775.7344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1221" y1="8775.7344" y2="8775.7344"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="978" y="8770.6685">Request Access Token properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="8804.8672" y2="8804.8672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="8804.8672" y2="8817.8672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="8817.8672" y2="8817.8672"/><polygon fill="#181818" points="1238,8813.8672,1228,8817.8672,1238,8821.8672,1234,8817.8672" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="1234" y="8799.8013">Retrieve Access Token properties</text><polygon fill="#181818" points="982,8843,972,8847,982,8851,978,8847" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1226" y1="8847" y2="8847"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="988" y="8841.9341">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="8876.1328" y2="8876.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="8876.1328" y2="8889.1328"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="8889.1328" y2="8889.1328"/><polygon fill="#181818" points="982,8885.1328,972,8889.1328,982,8893.1328,978,8889.1328" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="224" x="978" y="8871.0669">Introspect Access Token properties</text><path d="M976,8902.1328 L976,8972.1328 L1554,8972.1328 L1554,8912.1328 L1544,8902.1328 L976,8902.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1544,8902.1328 L1544,8912.1328 L1554,8912.1328 L1544,8902.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="437" x="982" y="8919.1997">On introspecting the Access Token the API Gateway will decorate the</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="473" x="982" y="8934.3325">request with the debtor account which is stored with the Consent. This can</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="557" x="982" y="8949.4653">then be forwarded to the Backend Integration application and used to make the correct</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="287" x="982" y="8964.5981">payment instruction in the Banking Systems.</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="8998.7969" y2="8998.7969"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="8998.7969" y2="9011.7969"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="9011.7969" y2="9011.7969"/><polygon fill="#181818" points="982,9007.7969,972,9011.7969,982,9015.7969,978,9011.7969" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="242" x="978" y="8993.731">Decorate request with debtor account</text><polygon fill="#181818" points="1703.5,9036.9297,1713.5,9040.9297,1703.5,9044.9297,1707.5,9040.9297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1709.5" y1="9040.9297" y2="9040.9297"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="215" x="978" y="9035.8638">POST /payments/v1/pix/payments</text><path d="M1720,9053.9297 L1720,9108.9297 L2172,9108.9297 L2172,9063.9297 L2162,9053.9297 L1720,9053.9297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2162,9053.9297 L2162,9063.9297 L2172,9063.9297 L2162,9053.9297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="425" x="1726" y="9070.9966">This flow is non-normative and will vary on customer requirements.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="8" x="1726" y="9086.1294">It</text><text fill="#000000" font-family="Roboto" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="34" x="1738" y="9086.1294">could</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="381" x="1776" y="9086.1294">be to a PIX-compliant API or any other available mechanism</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="153" x="1726" y="9101.2622">to make a PIX payment.</text><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="1757.5" y1="9135.4609" y2="9135.4609"/><line style="stroke:#181818;stroke-width:1.0;" x1="1757.5" x2="1757.5" y1="9135.4609" y2="9148.4609"/><line style="stroke:#181818;stroke-width:1.0;" x1="1716.5" x2="1757.5" y1="9148.4609" y2="9148.4609"/><polygon fill="#181818" points="1726.5,9144.4609,1716.5,9148.4609,1726.5,9152.4609,1722.5,9148.4609" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="158" x="1722.5" y="9130.395">Mediate request payload</text><polygon fill="#181818" points="2176,9173.5938,2186,9177.5938,2176,9181.5938,2180,9177.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="2182" y1="9177.5938" y2="9177.5938"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="325" x="1722.5" y="9172.5278">Deliver payment instruction to Banking System API</text><polygon fill="#181818" points="1726.5,9202.7266,1716.5,9206.7266,1726.5,9210.7266,1722.5,9206.7266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1720.5" x2="2187" y1="9206.7266" y2="9206.7266"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1732.5" y="9201.6606">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="1757.5" y1="9235.8594" y2="9235.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="1757.5" x2="1757.5" y1="9235.8594" y2="9248.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="1716.5" x2="1757.5" y1="9248.8594" y2="9248.8594"/><polygon fill="#181818" points="1726.5,9244.8594,1716.5,9248.8594,1726.5,9252.8594,1722.5,9248.8594" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="168" x="1722.5" y="9230.7935">Mediate response payload</text><polygon fill="#181818" points="982,9289.125,972,9293.125,982,9297.125,978,9293.125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1714.5" y1="9293.125" y2="9293.125"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="988" y="9272.9263">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="114" x="988" y="9288.0591">{paymentId: "..."}</text><polygon fill="#181818" points="596,9333.3906,586,9337.3906,596,9341.3906,592,9337.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="970" y1="9337.3906" y2="9337.3906"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="602" y="9317.1919">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="114" x="602" y="9332.3247">{paymentId: "..."}</text><polygon fill="#181818" points="269,9377.6563,259,9381.6563,269,9385.6563,265,9381.6563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="9381.6563" y2="9381.6563"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="79" x="275" y="9361.4575">201 Created</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="114" x="275" y="9376.5903">{paymentId: "..."}</text><path d="M208.5,9403.6563 L285.5,9403.6563 L285.5,9410.7891 L275.5,9420.7891 L208.5,9420.7891 L208.5,9403.6563 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="600.6563" style="stroke:#000000;stroke-width:1.5;" width="2381" x="208.5" y="9403.6563"/><text fill="#000000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="223.5" y="9416.7231">loop</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="79" x="300.5" y="9415.8667">[Until status</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="240" x="383.5" y="9415.8667">ACCEPTED_SETTLEMENT_COMPLETED</text><text fill="#000000" font-family="Roboto" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="75" x="627.5" y="9415.8667">is returned]</text><polygon fill="#181818" points="573,9437.9219,583,9441.9219,573,9445.9219,577,9441.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="258" x2="579" y1="9441.9219" y2="9441.9219"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="294" x="265" y="9436.856">GET /payments/v1/pix/payments/{paymentId}</text><polygon fill="#181818" points="2508,9467.0547,2518,9471.0547,2508,9475.0547,2512,9471.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="2514" y1="9471.0547" y2="9471.0547"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="198" x="592" y="9465.9888">Check Client Certificate Validity</text><polygon fill="#181818" points="596,9496.1875,586,9500.1875,596,9504.1875,592,9500.1875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="2519" y1="9500.1875" y2="9500.1875"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="602" y="9495.1216">Response</text><polygon fill="#181818" points="959,9525.3203,969,9529.3203,959,9533.3203,963,9529.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585" x2="965" y1="9529.3203" y2="9529.3203"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="294" x="592" y="9524.2544">GET /payments/v1/pix/payments/{paymentId}</text><polygon fill="#181818" points="1215,9554.4531,1225,9558.4531,1215,9562.4531,1219,9558.4531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1221" y1="9558.4531" y2="9558.4531"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="978" y="9553.3872">Request Access Token properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="1227" x2="1269" y1="9587.5859" y2="9587.5859"/><line style="stroke:#181818;stroke-width:1.0;" x1="1269" x2="1269" y1="9587.5859" y2="9600.5859"/><line style="stroke:#181818;stroke-width:1.0;" x1="1228" x2="1269" y1="9600.5859" y2="9600.5859"/><polygon fill="#181818" points="1238,9596.5859,1228,9600.5859,1238,9604.5859,1234,9600.5859" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="212" x="1234" y="9582.52">Retrieve Access Token properties</text><polygon fill="#181818" points="982,9625.7188,972,9629.7188,982,9633.7188,978,9629.7188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1226" y1="9629.7188" y2="9629.7188"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="988" y="9624.6528">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1013" y1="9658.8516" y2="9658.8516"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013" x2="1013" y1="9658.8516" y2="9671.8516"/><line style="stroke:#181818;stroke-width:1.0;" x1="972" x2="1013" y1="9671.8516" y2="9671.8516"/><polygon fill="#181818" points="982,9667.8516,972,9671.8516,982,9675.8516,978,9671.8516" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="224" x="978" y="9653.7856">Introspect Access Token properties</text><polygon fill="#181818" points="1703.5,9696.9844,1713.5,9700.9844,1703.5,9704.9844,1707.5,9700.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="971" x2="1709.5" y1="9700.9844" y2="9700.9844"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="294" x="978" y="9695.9185">GET /payments/v1/pix/payments/{paymentId}</text><path d="M1720,9713.9844 L1720,9768.9844 L2172,9768.9844 L2172,9723.9844 L2162,9713.9844 L1720,9713.9844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2162,9713.9844 L2162,9723.9844 L2172,9723.9844 L2162,9713.9844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="425" x="1726" y="9731.0513">This flow is non-normative and will vary on customer requirements.</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="8" x="1726" y="9746.1841">It</text><text fill="#000000" font-family="Roboto" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="34" x="1738" y="9746.1841">could</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="381" x="1776" y="9746.1841">be to a PIX-compliant API or any other available mechanism</text><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="223" x="1726" y="9761.3169">to get the status of a PIX payment.</text><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="1757.5" y1="9795.5156" y2="9795.5156"/><line style="stroke:#181818;stroke-width:1.0;" x1="1757.5" x2="1757.5" y1="9795.5156" y2="9808.5156"/><line style="stroke:#181818;stroke-width:1.0;" x1="1716.5" x2="1757.5" y1="9808.5156" y2="9808.5156"/><polygon fill="#181818" points="1726.5,9804.5156,1716.5,9808.5156,1726.5,9812.5156,1722.5,9808.5156" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="158" x="1722.5" y="9790.4497">Mediate request payload</text><polygon fill="#181818" points="2176,9833.6484,2186,9837.6484,2176,9841.6484,2180,9837.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="2182" y1="9837.6484" y2="9837.6484"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="130" x="1722.5" y="9832.5825">Get Payment Status</text><polygon fill="#181818" points="1726.5,9862.7813,1716.5,9866.7813,1726.5,9870.7813,1722.5,9866.7813" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1720.5" x2="2187" y1="9866.7813" y2="9866.7813"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="62" x="1732.5" y="9861.7153">Response</text><line style="stroke:#181818;stroke-width:1.0;" x1="1715.5" x2="1757.5" y1="9895.9141" y2="9895.9141"/><line style="stroke:#181818;stroke-width:1.0;" x1="1757.5" x2="1757.5" y1="9895.9141" y2="9908.9141"/><line style="stroke:#181818;stroke-width:1.0;" x1="1716.5" x2="1757.5" y1="9908.9141" y2="9908.9141"/><polygon fill="#181818" points="1726.5,9904.9141,1716.5,9908.9141,1726.5,9912.9141,1722.5,9908.9141" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="Roboto" font-size="13" lengthAdjust="spacing" textLength="168" x="1722.5" y="9890.8481">Mediate response payload</text><polygon fill="#181818" points="982,9934.0469,972,9938.0469,982,9942.0469,978,9938.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="976" x2="1714.5" y1="9938.0469" y2="9938.0469"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="988" y="9932.981">200 OK {...}</text><polygon fill="#181818" points="596,9963.1797,586,9967.1797,596,9971.1797,592,9967.1797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="590" x2="970" y1="9967.1797" y2="9967.1797"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="602" y="9962.1138">200 OK {...}</text><polygon fill="#181818" points="269,9992.3125,259,9996.3125,269,10000.3125,265,9996.3125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="263" x2="584" y1="9996.3125" y2="9996.3125"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="78" x="275" y="9991.2466">200 OK {...}</text><!--MD5=[a91c8fc053cb7747d15ab38c0d00d147]
@startuml Generic_Web_Journey_Sequence

title \n\n\n

actor "Customer" as PSU
participant "Data\nRecipient" as DR

box Infrastructure #6FA8DC
participant "Ingress\nController" as INGRESS
participant "API\nGateway" as API_GATEWAY
end box

box Identity and Access Control #94c47d
participant "Identity Management\n- - -\nAuthorisation Server" as IAM
participant "Consent\nManagement" as CONSENT
end box

box Open Banking APIs #e06666
participant "Backend\nIntegration\nApplication" as BIA
end box

box Core Banking Applications #d5a6bd
participant "Banking\nIdentity\nProvider" as ASPSP_WEB
participant "Banking\nSystems" as ASPSP_API
end box

box Open Banking Directory
participant "Participants\nList" as OBD_PARTICIPANTS
participant "JSON Web\nKey Set" as OBD_JWKS
end box

participant "Certificate\nAuthority\n- - -\nOCSP Endpoint" as OCSP

hide footbox
skinparam defaultFontName Roboto
skinparam BoxPadding 10

note right of PSU
Overview
===
This diagram shows the end-to-end web journey for obtaining Consent and starting to collect
Account Information data. The goal is to place the components from the Architecture Overview
in context.
|||
Note this diagram shows the means for the Client to authenticate at the Authorization Server
as mutual authentication but this could equally be done using ""private_key_jwt"".
end note

== Part 1: DR Obtains Customer Consent ==

note right of PSU
Obtaining Consent from the Customer is usually outside the scope of technical standards. The
Customer Experience Guidelines in Brazil informs how Consent should be displayed and obtained.
|||
The specifics of this process are therefore not shown here. The Data Recipient (DR) is
assumed to have implemented this within the guidelines specified.
end note

PSU -> DR: Indicate wish to share data
PSU <- - DR: Display "Intent"\ni.e. data to be accessed\nor payment to be made
PSU -> DR: Confirm intent
PSU <- - DR: Show bank selection screen
PSU -> DR: Confirm bank selection

== Part 2: DR Creates and Lodges "Intent" ==

note right of DR
With the consent of the Consumer obtained the DR can now call the Consent API at the correct bank. Note at this point Consent is usual termed "Intent" as it has
yet to confirmed at the bank.
end note

DR -> DR: Create Intent payload

note right of DR
Given the adherence to OpenID Connect Discovery in the standards DRs are expected to collect
OpenID Configuration information from participating banks.
end note

alt DR has cached OpenID Configuration for bank 

note right of DR
Do nothing
end note

else DR retrieves OpenID Configuration for bank

DR -> OBD_PARTICIPANTS: Get List of Participants
DR <- - OBD_PARTICIPANTS: Response

note right of DR
The discovery endpoint value is stored in the ""OpenIDDiscoveryDocument"" property of the banks
entry in the list
end note

DR -> DR: Get Discovery endpoint for target bank

note right of DR
The OpenID Configuration is hosted at Authorization Server. This is an open URL
that does not require authentication.
end note

DR -> INGRESS: ""GET /.well-known/openid-configuation""
INGRESS -> IAM: ""GET /.well-known/openid-configuation""
/'
INGRESS -> API_GATEWAY: ""GET /.well-known/openid-configuation""
API_GATEWAY -> IAM: ""GET /.well-known/openid-configuation""
API_GATEWAY <- - IAM: ""200 OK {...}""
INGRESS <- - API_GATEWAY: ""200 OK {...}""
'/
INGRESS <- - IAM: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

end alt

DR -> DR: Lookup Token endpoint\nfrom OpenID Configuration

note right of DR
The DR then uses the Client Credentials grant to obtain an Access Token to then
lodge the Consent on behalf of the Consumer.
|||
These request will be made using Mutual TLS with a certificate signed by a 
Certificate Authority whose certificate chain resolves at the Brazil ICP CA.
|||
The Kubernetes Ingress Controller is responsible for TLS termination and performing
an OCSP call to the Certificate Authority to ensure the client certificate presented
is valid. The fingerprint of the certificate will be forwarded to Identity Management
to verify the validity of the OAuth Client as this cannot be asserted via OCSP.
|||
It should be noted that due to the adoption of the Mutual TLS profile for OAuth 2.0 in
FAPI [[https://tools.ietf.org/id/draft-ietf-oauth-mtls-08.html (here)]] many Authorization Servers will bind Access Tokens to the
client certificate presented when they were created. This is indicated in the OpenID Configuration
through by the value of the ""tls_client_certificate_bound_access_tokens"" property.
end note

DR -> INGRESS: ""POST /oauth2/token""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
'INGRESS -> API_GATEWAY: ""POST /oauth2/token""
INGRESS -> IAM: ""POST /oauth2/token""
API_GATEWAY -> IAM: ""POST /oauth2/token""
IAM -> IAM: Verify Client
'API_GATEWAY <- IAM: ""200 OK""\n""{"access_token": "..."}""
'INGRESS <- - API_GATEWAY: ""200 OK""\n""{"access_token": "..."}""
INGRESS <- IAM: ""200 OK""\n""{"access_token": "..."}""
DR <- - INGRESS: ""200 OK""\n""{"access_token": "..."}""

alt DR requires access to account for data

note right of DR
**Account Information**
- - -
DRs use a generic endpoint for Account Information that covers all
account types (checking, credit card, loans, etc).
end note

DR -> INGRESS: ""POST /consents/v1/consents""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /consents/v1/consents""

else DR requires access to account to initiate payment

note right of DR
**Payment Initiation**
- - -
Payment Initiation has a dedicated endpoint that will be used
to cover all payment rails (PIX, TED, etc).
end note

DR -> INGRESS: ""POST /payments/v1/consents""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/consents""

end alt

API_GATEWAY -> IAM: Introspect Access Token
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Verify Access Token scope

note right of API_GATEWAY
The consent management API provides separate operations based on the type of consent i.e.
account information, payments, etc. The API Gateway mediates the request and
calls the operation appropriate to the consent in question.
end note

alt Account Information
API_GATEWAY -> CONSENT: ""POST /consents/v1/consents""
else Payment Initation
API_GATEWAY -> CONSENT: ""POST /payments/v1/consents""
end alt

API_GATEWAY <- - CONSENT: ""201 Created""\n""{"consentId": "..."}""
API_GATEWAY -> API_GATEWAY: Format response
INGRESS <- - API_GATEWAY: ""201 Created""\n""{"consentId": "..."}"" 
DR <- - INGRESS: ""201 Created""\n""{"consentId": "..."}"" 

== Part 3: Customer is Redirected to Authorization Server ==

note right of DR
**API Security Profile**
- - -
FAPI mandates the use of the [[https://openid.net/specs/openid-financial-api-part-2-ID2.html#authorization-server Authentication Request object]] which is defined in [[https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests Section 6]]
of OpenID Connect Core. This is a JSON Web Signature that contains parameters
normally found in the URL (redirect_uri, state, scope, etc)
|||
However, FAPI has been extended by the [[https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html API Security Profile for Brazil]] where 2
alternatives are added to the Authorization Server (AS) in terms of Request parameter
support:
|||
1. Request parameter passed in the URI that must be **signed and encrypted**.
2. Request parameter passed by reference through [[https://datatracker.ietf.org/doc/html/draft-ietf-oauth-par Pushed Authorization Requests (PAR)]].
|||
Support for either approach should be included in the OpenID Configuration available
through Discovery that banks are obliged to provide under the API Security Profile.
Both options are shown in the sequence diagram.
|||
**Note that Amplify Open Banking will initially support the first approach, namely a signed**
**and encrypted JSON Web Token and introduce support for PAR in a later release.**
end note

DR -> DR: Create Request parameter

' alt AS supports Request parameter passed by value

note right of DR
The Signing and Encryption keys will be the private part of the pair signed by the Directory
that can be referenced in the JSON Web Key Set maintained therein i.e. the key ID matches
one of the DRs JSON Web Keys.
end note

DR -> DR: Sign Request parameter with Signing Key
DR -> DR: Encrypt Request parameter with Encryption Key
DR -> DR: Create redirect URL including Request parameter

' else AS supports PAR

' note right of DR
' To create an Authorization request through PAR the DR **must** authenticate using the same
' method as they use at the Token endpoint.
' end note

' DR -> DR: Encode Request parameter in payload
' DR -> INGRESS: ""POST /par""
' INGRESS -> OCSP: Check Client Certificate Validity
' INGRESS <- - OCSP: Response
' INGRESS -> API_GATEWAY: ""POST /par""
' API_GATEWAY -> IAM: Authorization request
' API_GATEWAY <- - IAM: Response
' INGRESS <- - API_GATEWAY: ""201 Created""\n""{"request_uri": "..."}"" 
' DR <- - INGRESS: ""201 Created""\n""{"request_uri": "..."}"" 
' DR -> DR: Create redirect URL including ""request_uri"" value

' end alt

PSU <- - DR: Redirect customer
PSU -> IAM: ""GET /oauth2/authorize?...""

note right of IAM
This is indicative as the Directory JWKS is likely to be cached for a
period time i.e. the JWKS will not be retrieved on every Authentication
Request.
end note

IAM -> OBD_JWKS: Get JSON Web Key Set
IAM <- - OBD_JWKS: Response
IAM -> API_GATEWAY: Match Request parameter ""kid""
IAM -> API_GATEWAY: Verify Request parameter signature
IAM -> IAM: Verify Request parameter
IAM -> CONSENT: Request Consent by ID
CONSENT -> CONSENT: Retrieve Consent
IAM <- CONSENT: Response
PSU <- IAM: Return redirect URL

== Part 4: Customer Authenticates and Authorizes Consent ==

note right of PSU
The following steps can vary according the bank's requirements
for authentication and authorization but these steps provide
an accurate overview in the context of the Amplify Open Banking.
end note

PSU -> ASPSP_WEB: Follow Redirect
ASPSP_WEB -> ASPSP_WEB: Verify redirect

loop Request required number of authentication factors

note right of PSU
This loop is intended to be indicative and the actual
mechanics are entirely dependent on the bank's
implementation and their approach to user experience.
end note

PSU <- - ASPSP_WEB: Serve credentials input page
PSU -> ASPSP_WEB: Submit credentials
ASPSP_WEB -> ASPSP_WEB: Verify credentials

end loop

note right of INGRESS
* Providing security for the Consent Management API should be reviewed on a case-by-case
**basis and implemented according to customer requirements.**
|||
This diagram shows an example of access to the Consent Management API
being implemented via the Ingress Controller/API Gateway. Security
is provided via an internal certificate which is **not** validated
against ICP.
|||
The ""{operation}"" parameter denotes either an Account Information or
Payment Initiation consent. The possible values are:

* ""consents"": Account Information
* ""payments"": Payment Initiation

The value of ""{consent-id}"" must be retrieved from the requested scope as
this contains the consent resource identifier as defined in the [[https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html#section-7.1.2 Security Profile]].
end note

ASPSP_WEB -> INGRESS: ""GET ​/open-banking​/{operation}/v1/consent/{consent-id}""
INGRESS -> API_GATEWAY: ""GET ​/open-banking​/{operation}/v1/consent/{consent-id}""
API_GATEWAY -> CONSENT: ""GET ​/open-banking​/{operation}/v1/consent/{consent-id}""
CONSENT -> CONSENT: Retrieve "Intent"
API_GATEWAY <- - CONSENT: ""200 OK {...}""
INGRESS <- - API_GATEWAY: ""200 OK {...}""
ASPSP_WEB <- - INGRESS: ""200 OK {...}""

alt Account Information Consent

note right of ASPSP_WEB
**Account Information**
- - -
When creating the Consent Confirmation screen the
permission codes held in the "Intent" need to be
converted to something that will be meaningful to the
Customer. The wording should adhere to that detailed
in the [[https://github.com/OpenBanking-Brasil/areadesenvolvedor/raw/gh-pages/documents/GuiaDeExperienciaDoUsuarioCompartilhamentoDeDadosEIniciacaoDePagamento_v3.02.03.pdf Customer Experience Guidelines]].
end note

else Payment Initiation Consent

note right of ASPSP_WEB
**Payment Initiation**
- - -
The Consent Confirmation screen requires the following properties to be displayed:
* Transaction Value.
* Recipient details (name, CPF/CNPJ).
* Payment Date.
* Payment method (currently fixed on PIX).
* Fee amount charged by the bank (if any).
end note

par Request fee amount for payment

note right of ASPSP_WEB
Fees for payment must be provided from the Banking Systems
end note

ASPSP_WEB -> ASPSP_API: Request fee amount
ASPSP_WEB <- - ASPSP_API: Response

else

alt Debtor account not provided in Consent

note right of ASPSP_WEB
If the debtor account has not been provided in the Consent then
the customer's payment accounts will need to be retrieved:

* If the customer only has one payment account then this is the default.
* If they have multiple accounts they should be able to select one.

This should be incorporated into the Consent Confirmation screen.
end note

ASPSP_WEB -> ASPSP_API: Request in-scope payment accounts
ASPSP_WEB <- - ASPSP_API: Response

else Debtor account provided in Consent

note right of ASPSP_WEB
If the debtor account has already been provided ownership of the
account by the customer **must** be verified. This must be executed
at the Banking Systems as they will understand the relationship
between a (now authenticated) customer and the accounts they own.
end note

ASPSP_WEB -> ASPSP_API: Verify account ownership
ASPSP_WEB <- - ASPSP_API: Response

end alt

end par

end alt

ASPSP_WEB -> ASPSP_WEB: Render Consent Confirmation screen
PSU <- - ASPSP_WEB: Serve Consent Confirmation screen
PSU -> ASPSP_WEB: Confirm consent is correct

alt Account Information Consent

note right of ASPSP_WEB
**Account Information**
- - -
Once consent has been confirmed by the Customer the list of
in-scope accounts will be retrieved from the Banking Systems.
This list will obviously be dictated by the permission codes
requested by the DR i.e. if only ""ACCOUNTS_READ"" is requested
then all other account types can be ignored.
end note

ASPSP_WEB -> ASPSP_API: Request in-scope Customer accounts
ASPSP_WEB <- - ASPSP_API: Response

ASPSP_WEB -> ASPSP_WEB: Render Account Selection screen
PSU <- - ASPSP_WEB: Serve Account Selection screen
PSU -> ASPSP_WEB: Send Account Selection

end alt

note right of INGRESS
**Payment Initation**
- - -
The consent is updated with the granted accounts. Note for for Payment
Initiation ""account_ids"" can be omitted.
end note

ASPSP_WEB -> INGRESS: ""POST /open-banking/{operation}/{login}/accept""\n""{ account_ids: [...] }"" 
INGRESS -> API_GATEWAY: ""POST /open-banking/{operation}/{login}/accept""\n""{ account_ids: [...] }"" 
API_GATEWAY -> CONSENT: ""POST /open-banking/{operation}/{login}/accept""\n""{ account_ids: [...] }"" 
CONSENT -> CONSENT: Update "Intent" with Account IDs
CONSENT -> CONSENT: Mark Consent as ""AUTHORISED""
API_GATEWAY <- - CONSENT: ""200 OK {redirect_to: "..."}""
INGRESS <- - API_GATEWAY: ""200 OK {redirect_to: "..."}""
ASPSP_WEB <- - INGRESS: ""200 OK {redirect_to: "..."}""

note right of PSU
The Customer is redirected back to the Amplify Open Banking stack from
the bank's Identity Provider in order to complete Hybrid Flow, using
the value of the ""redirect_uri"" property returned in the response
from the call to the consent API.
|||
The hand-off is constrained using a number of parameters included
in the redirect URI to help safeguard this process i.e. to prevent
unsolicited authentication attempts or session takeover.
end note

PSU <- - ASPSP_WEB: Redirect Customer\nback to Authorization Server
PSU -> INGRESS: Follow redirect
'INGRESS -> API_GATEWAY: Follow redirect
INGRESS -> IAM: Forward redirect parameters
IAM -> IAM: Verify redirect
IAM -> IAM: Mint Authorization Code\nand ID Token

note right of IAM
At this point the Identity Management module mints a redirect
URI that will take the Customer back to the Data Recipient App.
The URI includes the Authorization Code and parameters that
adhere to the API Security Profile for Brazil.
end note

'API_GATEWAY <- - IAM: Return redirect
INGRESS <- - IAM: Return redirect
PSU <- - INGRESS: Redirect Customer
PSU -> DR: Follow Redirect

== Part 5: DR Swaps Authorization Code for Access Token ==

DR -> DR: Verify redirect including\nID Token signature, nonce and s_hash value
DR -> INGRESS: ""POST /oauth2/token""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
'INGRESS -> API_GATEWAY: ""POST /oauth2/token""
INGRESS -> IAM: ""POST /oauth2/token""
IAM -> IAM: Validate Token Request
IAM -> IAM: Mint ID, Access and Refresh Tokens
'API_GATEWAY <- - IAM: ""200 OK""\n""{"access_token": "..."}""
INGRESS <- - IAM: ""200 OK""\n""{"access_token": "..."}""
DR <- - INGRESS: ""200 OK""\n""{"access_token": "..."}""

== Part 6: Data Recipient Gets Data from Account ==

alt Account Information

note right of DR
**Account Information**
- - -
The retrieval of account data happens in two stages:

1. The DR requests the available resources at the Resources API.
2. Using the identifiers returned they can request account data.
end note

group Get all resource identifiers

note right of DR
The DR will require the ""RESOURCES_READ"" permission to access
the ""/resources"" endpoint. If Customer has not consented to this
the request should be rejected (not shown here).
end note

DR -> INGRESS: ""GET /resources/v1/resources""\n""Authorization: Bearer ...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""GET /resources/v1/resources""\n""Authorization: Bearer ...""
API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties
API_GATEWAY -> API_GATEWAY: Apply access controls
API_GATEWAY -> BIA: ""GET /resources/v1/resources""
BIA -> ASPSP_API: Get available resources for Customer
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""200 OK { "data": ... }""
INGRESS <- - API_GATEWAY: ""200 OK { "data": ... }""
DR <- - INGRESS: ""200 OK { "data": ... }""

end group

loop For each Account ID returned from ""/resources""

note right of DR
In this example the DR only has access to checking accounts.
They will require the ""ACCOUNTS_READ"" permission to access
the ""/accounts/v1/accounts/{accountId}"" endpoint. If Customer
has not consented to this the request should be rejected (not
shown here).
end note

DR -> INGRESS: ""GET /accounts/v1/accounts/{accountId}""\n""Authorization: Bearer ...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""GET /accounts/v1/accounts/{accountId}""\n""Authorization: Bearer ...""
API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties
API_GATEWAY -> API_GATEWAY: Apply access controls
API_GATEWAY -> BIA: ""GET /accounts/v1/accounts/{accountId}""
BIA -> ASPSP_API: Get requested account
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""200 OK { "data": ... }""
INGRESS <- - API_GATEWAY: ""200 OK { "data": ... }""
DR <- - INGRESS: ""200 OK { "data": ... }""
end loop

else Payment Initiation

note right of DR
**Payment Initiation**
- - -
The DR can now make the payment instruction request. The Access Token
is bound to this single operation and will be revoked once the payment
instruction is successfully transmitted.
|||
Note that in cases where multiple authorizations are required the DR
will receive and indicator in the ""status"" property with a value of
""PART"".
end note

group Create payment initation request

DR -> INGRESS: ""POST /payments/v1/pix/payments""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/pix/payments""

note right of API_GATEWAY
The approach to Access Token introspection remains the same under payments
i.e. the API Gateway will need an assertion that indicates the consent granted
by the Customer matches the payment being instructed.
end note

API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties

note right of API_GATEWAY
On introspecting the Access Token the API Gateway will decorate the
request with the debtor account which is stored with the Consent. This can
then be forwarded to the Backend Integration application and used to make the correct
payment instruction in the Banking Systems.
end note

API_GATEWAY -> API_GATEWAY: Decorate request with debtor account
API_GATEWAY -> BIA: ""POST /payments/v1/pix/payments""

note right of BIA
This flow is non-normative and will vary on customer requirements.
It //could// be to a PIX-compliant API or any other available mechanism
to make a PIX payment.
end note

BIA -> BIA: Mediate request payload
BIA -> ASPSP_API: Deliver payment instruction to Banking System API
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""201 Created""\n""{paymentId: "..."}""
INGRESS <- - API_GATEWAY: ""201 Created""\n""{paymentId: "..."}""
DR <- - INGRESS: ""201 Created""\n""{paymentId: "..."}""

end group

loop Until status ""ACCEPTED_SETTLEMENT_COMPLETED"" is returned

DR -> INGRESS: ""GET /payments/v1/pix/payments/{paymentId}""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""GET /payments/v1/pix/payments/{paymentId}""
API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties
API_GATEWAY -> BIA: ""GET /payments/v1/pix/payments/{paymentId}""

note right of BIA
This flow is non-normative and will vary on customer requirements.
It //could// be to a PIX-compliant API or any other available mechanism
to get the status of a PIX payment.
end note

BIA -> BIA: Mediate request payload
BIA -> ASPSP_API: Get Payment Status
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""200 OK {...}""
INGRESS <- - API_GATEWAY: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

end loop

end alt

@enduml

@startuml Generic_Web_Journey_Sequence

title \n\n\n

actor "Customer" as PSU
participant "Data\nRecipient" as DR

box Infrastructure #6FA8DC
participant "Ingress\nController" as INGRESS
participant "API\nGateway" as API_GATEWAY
end box

box Identity and Access Control #94c47d
participant "Identity Management\n- - -\nAuthorisation Server" as IAM
participant "Consent\nManagement" as CONSENT
end box

box Open Banking APIs #e06666
participant "Backend\nIntegration\nApplication" as BIA
end box

box Core Banking Applications #d5a6bd
participant "Banking\nIdentity\nProvider" as ASPSP_WEB
participant "Banking\nSystems" as ASPSP_API
end box

box Open Banking Directory
participant "Participants\nList" as OBD_PARTICIPANTS
participant "JSON Web\nKey Set" as OBD_JWKS
end box

participant "Certificate\nAuthority\n- - -\nOCSP Endpoint" as OCSP

hide footbox
skinparam defaultFontName Roboto
skinparam BoxPadding 10

note right of PSU
Overview
===
This diagram shows the end-to-end web journey for obtaining Consent and starting to collect
Account Information data. The goal is to place the components from the Architecture Overview
in context.
|||
Note this diagram shows the means for the Client to authenticate at the Authorization Server
as mutual authentication but this could equally be done using ""private_key_jwt"".
end note

== Part 1: DR Obtains Customer Consent ==

note right of PSU
Obtaining Consent from the Customer is usually outside the scope of technical standards. The
Customer Experience Guidelines in Brazil informs how Consent should be displayed and obtained.
|||
The specifics of this process are therefore not shown here. The Data Recipient (DR) is
assumed to have implemented this within the guidelines specified.
end note

PSU -> DR: Indicate wish to share data
PSU <- - DR: Display "Intent"\ni.e. data to be accessed\nor payment to be made
PSU -> DR: Confirm intent
PSU <- - DR: Show bank selection screen
PSU -> DR: Confirm bank selection

== Part 2: DR Creates and Lodges "Intent" ==

note right of DR
With the consent of the Consumer obtained the DR can now call the Consent API at the correct bank. Note at this point Consent is usual termed "Intent" as it has
yet to confirmed at the bank.
end note

DR -> DR: Create Intent payload

note right of DR
Given the adherence to OpenID Connect Discovery in the standards DRs are expected to collect
OpenID Configuration information from participating banks.
end note

alt DR has cached OpenID Configuration for bank 

note right of DR
Do nothing
end note

else DR retrieves OpenID Configuration for bank

DR -> OBD_PARTICIPANTS: Get List of Participants
DR <- - OBD_PARTICIPANTS: Response

note right of DR
The discovery endpoint value is stored in the ""OpenIDDiscoveryDocument"" property of the banks
entry in the list
end note

DR -> DR: Get Discovery endpoint for target bank

note right of DR
The OpenID Configuration is hosted at Authorization Server. This is an open URL
that does not require authentication.
end note

DR -> INGRESS: ""GET /.well-known/openid-configuation""
INGRESS -> IAM: ""GET /.well-known/openid-configuation""
INGRESS <- - IAM: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

end alt

DR -> DR: Lookup Token endpoint\nfrom OpenID Configuration

note right of DR
The DR then uses the Client Credentials grant to obtain an Access Token to then
lodge the Consent on behalf of the Consumer.
|||
These request will be made using Mutual TLS with a certificate signed by a 
Certificate Authority whose certificate chain resolves at the Brazil ICP CA.
|||
The Kubernetes Ingress Controller is responsible for TLS termination and performing
an OCSP call to the Certificate Authority to ensure the client certificate presented
is valid. The fingerprint of the certificate will be forwarded to Identity Management
to verify the validity of the OAuth Client as this cannot be asserted via OCSP.
|||
It should be noted that due to the adoption of the Mutual TLS profile for OAuth 2.0 in
FAPI [[https://tools.ietf.org/id/draft-ietf-oauth-mtls-08.html (here)]] many Authorization Servers will bind Access Tokens to the
client certificate presented when they were created. This is indicated in the OpenID Configuration
through by the value of the ""tls_client_certificate_bound_access_tokens"" property.
end note

DR -> INGRESS: ""POST /oauth2/token""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /oauth2/token""
API_GATEWAY -> IAM: ""POST /oauth2/token""
IAM -> IAM: Verify Client
INGRESS <- IAM: ""200 OK""\n""{"access_token": "..."}""
DR <- - INGRESS: ""200 OK""\n""{"access_token": "..."}""

alt DR requires access to account for data

note right of DR
**Account Information**
- - -
DRs use a generic endpoint for Account Information that covers all
account types (checking, credit card, loans, etc).
end note

DR -> INGRESS: ""POST /consents/v1/consents""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /consents/v1/consents""

else DR requires access to account to initiate payment

note right of DR
**Payment Initiation**
- - -
Payment Initiation has a dedicated endpoint that will be used
to cover all payment rails (PIX, TED, etc).
end note

DR -> INGRESS: ""POST /payments/v1/consents""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/consents""

end alt

API_GATEWAY -> IAM: Introspect Access Token
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Verify Access Token scope

note right of API_GATEWAY
The consent management API provides separate operations based on the type of consent i.e.
account information, payments, etc. The API Gateway mediates the request and
calls the operation appropriate to the consent in question.
end note

alt Account Information
API_GATEWAY -> CONSENT: ""POST /consents/v1/consents""
else Payment Initation
API_GATEWAY -> CONSENT: ""POST /payments/v1/consents""
end alt

API_GATEWAY <- - CONSENT: ""201 Created""\n""{"consentId": "..."}""
API_GATEWAY -> API_GATEWAY: Format response
INGRESS <- - API_GATEWAY: ""201 Created""\n""{"consentId": "..."}"" 
DR <- - INGRESS: ""201 Created""\n""{"consentId": "..."}"" 

== Part 3: Customer is Redirected to Authorization Server ==

note right of DR
**API Security Profile**
- - -
FAPI mandates the use of the [[https://openid.net/specs/openid-financial-api-part-2-ID2.html#authorization-server Authentication Request object]] which is defined in [[https://openid.net/specs/openid-connect-core-1_0.html#JWTRequests Section 6]]
of OpenID Connect Core. This is a JSON Web Signature that contains parameters
normally found in the URL (redirect_uri, state, scope, etc)
|||
However, FAPI has been extended by the [[https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html API Security Profile for Brazil]] where 2
alternatives are added to the Authorization Server (AS) in terms of Request parameter
support:
|||
1. Request parameter passed in the URI that must be **signed and encrypted**.
2. Request parameter passed by reference through [[https://datatracker.ietf.org/doc/html/draft-ietf-oauth-par Pushed Authorization Requests (PAR)]].
|||
Support for either approach should be included in the OpenID Configuration available
through Discovery that banks are obliged to provide under the API Security Profile.
Both options are shown in the sequence diagram.
|||
**Note that Amplify Open Banking will initially support the first approach, namely a signed**
**and encrypted JSON Web Token and introduce support for PAR in a later release.**
end note

DR -> DR: Create Request parameter


note right of DR
The Signing and Encryption keys will be the private part of the pair signed by the Directory
that can be referenced in the JSON Web Key Set maintained therein i.e. the key ID matches
one of the DRs JSON Web Keys.
end note

DR -> DR: Sign Request parameter with Signing Key
DR -> DR: Encrypt Request parameter with Encryption Key
DR -> DR: Create redirect URL including Request parameter





PSU <- - DR: Redirect customer
PSU -> IAM: ""GET /oauth2/authorize?...""

note right of IAM
This is indicative as the Directory JWKS is likely to be cached for a
period time i.e. the JWKS will not be retrieved on every Authentication
Request.
end note

IAM -> OBD_JWKS: Get JSON Web Key Set
IAM <- - OBD_JWKS: Response
IAM -> API_GATEWAY: Match Request parameter ""kid""
IAM -> API_GATEWAY: Verify Request parameter signature
IAM -> IAM: Verify Request parameter
IAM -> CONSENT: Request Consent by ID
CONSENT -> CONSENT: Retrieve Consent
IAM <- CONSENT: Response
PSU <- IAM: Return redirect URL

== Part 4: Customer Authenticates and Authorizes Consent ==

note right of PSU
The following steps can vary according the bank's requirements
for authentication and authorization but these steps provide
an accurate overview in the context of the Amplify Open Banking.
end note

PSU -> ASPSP_WEB: Follow Redirect
ASPSP_WEB -> ASPSP_WEB: Verify redirect

loop Request required number of authentication factors

note right of PSU
This loop is intended to be indicative and the actual
mechanics are entirely dependent on the bank's
implementation and their approach to user experience.
end note

PSU <- - ASPSP_WEB: Serve credentials input page
PSU -> ASPSP_WEB: Submit credentials
ASPSP_WEB -> ASPSP_WEB: Verify credentials

end loop

note right of INGRESS
* Providing security for the Consent Management API should be reviewed on a case-by-case
**basis and implemented according to customer requirements.**
|||
This diagram shows an example of access to the Consent Management API
being implemented via the Ingress Controller/API Gateway. Security
is provided via an internal certificate which is **not** validated
against ICP.
|||
The ""{operation}"" parameter denotes either an Account Information or
Payment Initiation consent. The possible values are:

* ""consents"": Account Information
* ""payments"": Payment Initiation

The value of ""{consent-id}"" must be retrieved from the requested scope as
this contains the consent resource identifier as defined in the [[https://openbanking-brasil.github.io/specs-seguranca/open-banking-brasil-financial-api-1_ID2.html#section-7.1.2 Security Profile]].
end note

ASPSP_WEB -> INGRESS: ""GET ​/open-banking​/{operation}/v1/consent/{consent-id}""
INGRESS -> API_GATEWAY: ""GET ​/open-banking​/{operation}/v1/consent/{consent-id}""
API_GATEWAY -> CONSENT: ""GET ​/open-banking​/{operation}/v1/consent/{consent-id}""
CONSENT -> CONSENT: Retrieve "Intent"
API_GATEWAY <- - CONSENT: ""200 OK {...}""
INGRESS <- - API_GATEWAY: ""200 OK {...}""
ASPSP_WEB <- - INGRESS: ""200 OK {...}""

alt Account Information Consent

note right of ASPSP_WEB
**Account Information**
- - -
When creating the Consent Confirmation screen the
permission codes held in the "Intent" need to be
converted to something that will be meaningful to the
Customer. The wording should adhere to that detailed
in the [[https://github.com/OpenBanking-Brasil/areadesenvolvedor/raw/gh-pages/documents/GuiaDeExperienciaDoUsuarioCompartilhamentoDeDadosEIniciacaoDePagamento_v3.02.03.pdf Customer Experience Guidelines]].
end note

else Payment Initiation Consent

note right of ASPSP_WEB
**Payment Initiation**
- - -
The Consent Confirmation screen requires the following properties to be displayed:
* Transaction Value.
* Recipient details (name, CPF/CNPJ).
* Payment Date.
* Payment method (currently fixed on PIX).
* Fee amount charged by the bank (if any).
end note

par Request fee amount for payment

note right of ASPSP_WEB
Fees for payment must be provided from the Banking Systems
end note

ASPSP_WEB -> ASPSP_API: Request fee amount
ASPSP_WEB <- - ASPSP_API: Response

else

alt Debtor account not provided in Consent

note right of ASPSP_WEB
If the debtor account has not been provided in the Consent then
the customer's payment accounts will need to be retrieved:

* If the customer only has one payment account then this is the default.
* If they have multiple accounts they should be able to select one.

This should be incorporated into the Consent Confirmation screen.
end note

ASPSP_WEB -> ASPSP_API: Request in-scope payment accounts
ASPSP_WEB <- - ASPSP_API: Response

else Debtor account provided in Consent

note right of ASPSP_WEB
If the debtor account has already been provided ownership of the
account by the customer **must** be verified. This must be executed
at the Banking Systems as they will understand the relationship
between a (now authenticated) customer and the accounts they own.
end note

ASPSP_WEB -> ASPSP_API: Verify account ownership
ASPSP_WEB <- - ASPSP_API: Response

end alt

end par

end alt

ASPSP_WEB -> ASPSP_WEB: Render Consent Confirmation screen
PSU <- - ASPSP_WEB: Serve Consent Confirmation screen
PSU -> ASPSP_WEB: Confirm consent is correct

alt Account Information Consent

note right of ASPSP_WEB
**Account Information**
- - -
Once consent has been confirmed by the Customer the list of
in-scope accounts will be retrieved from the Banking Systems.
This list will obviously be dictated by the permission codes
requested by the DR i.e. if only ""ACCOUNTS_READ"" is requested
then all other account types can be ignored.
end note

ASPSP_WEB -> ASPSP_API: Request in-scope Customer accounts
ASPSP_WEB <- - ASPSP_API: Response

ASPSP_WEB -> ASPSP_WEB: Render Account Selection screen
PSU <- - ASPSP_WEB: Serve Account Selection screen
PSU -> ASPSP_WEB: Send Account Selection

end alt

note right of INGRESS
**Payment Initation**
- - -
The consent is updated with the granted accounts. Note for for Payment
Initiation ""account_ids"" can be omitted.
end note

ASPSP_WEB -> INGRESS: ""POST /open-banking/{operation}/{login}/accept""\n""{ account_ids: [...] }"" 
INGRESS -> API_GATEWAY: ""POST /open-banking/{operation}/{login}/accept""\n""{ account_ids: [...] }"" 
API_GATEWAY -> CONSENT: ""POST /open-banking/{operation}/{login}/accept""\n""{ account_ids: [...] }"" 
CONSENT -> CONSENT: Update "Intent" with Account IDs
CONSENT -> CONSENT: Mark Consent as ""AUTHORISED""
API_GATEWAY <- - CONSENT: ""200 OK {redirect_to: "..."}""
INGRESS <- - API_GATEWAY: ""200 OK {redirect_to: "..."}""
ASPSP_WEB <- - INGRESS: ""200 OK {redirect_to: "..."}""

note right of PSU
The Customer is redirected back to the Amplify Open Banking stack from
the bank's Identity Provider in order to complete Hybrid Flow, using
the value of the ""redirect_uri"" property returned in the response
from the call to the consent API.
|||
The hand-off is constrained using a number of parameters included
in the redirect URI to help safeguard this process i.e. to prevent
unsolicited authentication attempts or session takeover.
end note

PSU <- - ASPSP_WEB: Redirect Customer\nback to Authorization Server
PSU -> INGRESS: Follow redirect
INGRESS -> IAM: Forward redirect parameters
IAM -> IAM: Verify redirect
IAM -> IAM: Mint Authorization Code\nand ID Token

note right of IAM
At this point the Identity Management module mints a redirect
URI that will take the Customer back to the Data Recipient App.
The URI includes the Authorization Code and parameters that
adhere to the API Security Profile for Brazil.
end note

INGRESS <- - IAM: Return redirect
PSU <- - INGRESS: Redirect Customer
PSU -> DR: Follow Redirect

== Part 5: DR Swaps Authorization Code for Access Token ==

DR -> DR: Verify redirect including\nID Token signature, nonce and s_hash value
DR -> INGRESS: ""POST /oauth2/token""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> IAM: ""POST /oauth2/token""
IAM -> IAM: Validate Token Request
IAM -> IAM: Mint ID, Access and Refresh Tokens
INGRESS <- - IAM: ""200 OK""\n""{"access_token": "..."}""
DR <- - INGRESS: ""200 OK""\n""{"access_token": "..."}""

== Part 6: Data Recipient Gets Data from Account ==

alt Account Information

note right of DR
**Account Information**
- - -
The retrieval of account data happens in two stages:

1. The DR requests the available resources at the Resources API.
2. Using the identifiers returned they can request account data.
end note

group Get all resource identifiers

note right of DR
The DR will require the ""RESOURCES_READ"" permission to access
the ""/resources"" endpoint. If Customer has not consented to this
the request should be rejected (not shown here).
end note

DR -> INGRESS: ""GET /resources/v1/resources""\n""Authorization: Bearer ...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""GET /resources/v1/resources""\n""Authorization: Bearer ...""
API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties
API_GATEWAY -> API_GATEWAY: Apply access controls
API_GATEWAY -> BIA: ""GET /resources/v1/resources""
BIA -> ASPSP_API: Get available resources for Customer
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""200 OK { "data": ... }""
INGRESS <- - API_GATEWAY: ""200 OK { "data": ... }""
DR <- - INGRESS: ""200 OK { "data": ... }""

end group

loop For each Account ID returned from ""/resources""

note right of DR
In this example the DR only has access to checking accounts.
They will require the ""ACCOUNTS_READ"" permission to access
the ""/accounts/v1/accounts/{accountId}"" endpoint. If Customer
has not consented to this the request should be rejected (not
shown here).
end note

DR -> INGRESS: ""GET /accounts/v1/accounts/{accountId}""\n""Authorization: Bearer ...""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""GET /accounts/v1/accounts/{accountId}""\n""Authorization: Bearer ...""
API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties
API_GATEWAY -> API_GATEWAY: Apply access controls
API_GATEWAY -> BIA: ""GET /accounts/v1/accounts/{accountId}""
BIA -> ASPSP_API: Get requested account
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""200 OK { "data": ... }""
INGRESS <- - API_GATEWAY: ""200 OK { "data": ... }""
DR <- - INGRESS: ""200 OK { "data": ... }""
end loop

else Payment Initiation

note right of DR
**Payment Initiation**
- - -
The DR can now make the payment instruction request. The Access Token
is bound to this single operation and will be revoked once the payment
instruction is successfully transmitted.
|||
Note that in cases where multiple authorizations are required the DR
will receive and indicator in the ""status"" property with a value of
""PART"".
end note

group Create payment initation request

DR -> INGRESS: ""POST /payments/v1/pix/payments""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""POST /payments/v1/pix/payments""

note right of API_GATEWAY
The approach to Access Token introspection remains the same under payments
i.e. the API Gateway will need an assertion that indicates the consent granted
by the Customer matches the payment being instructed.
end note

API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties

note right of API_GATEWAY
On introspecting the Access Token the API Gateway will decorate the
request with the debtor account which is stored with the Consent. This can
then be forwarded to the Backend Integration application and used to make the correct
payment instruction in the Banking Systems.
end note

API_GATEWAY -> API_GATEWAY: Decorate request with debtor account
API_GATEWAY -> BIA: ""POST /payments/v1/pix/payments""

note right of BIA
This flow is non-normative and will vary on customer requirements.
It //could// be to a PIX-compliant API or any other available mechanism
to make a PIX payment.
end note

BIA -> BIA: Mediate request payload
BIA -> ASPSP_API: Deliver payment instruction to Banking System API
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""201 Created""\n""{paymentId: "..."}""
INGRESS <- - API_GATEWAY: ""201 Created""\n""{paymentId: "..."}""
DR <- - INGRESS: ""201 Created""\n""{paymentId: "..."}""

end group

loop Until status ""ACCEPTED_SETTLEMENT_COMPLETED"" is returned

DR -> INGRESS: ""GET /payments/v1/pix/payments/{paymentId}""
INGRESS -> OCSP: Check Client Certificate Validity
INGRESS <- - OCSP: Response
INGRESS -> API_GATEWAY: ""GET /payments/v1/pix/payments/{paymentId}""
API_GATEWAY -> IAM: Request Access Token properties
IAM -> IAM: Retrieve Access Token properties
API_GATEWAY <- - IAM: Response
API_GATEWAY -> API_GATEWAY: Introspect Access Token properties
API_GATEWAY -> BIA: ""GET /payments/v1/pix/payments/{paymentId}""

note right of BIA
This flow is non-normative and will vary on customer requirements.
It //could// be to a PIX-compliant API or any other available mechanism
to get the status of a PIX payment.
end note

BIA -> BIA: Mediate request payload
BIA -> ASPSP_API: Get Payment Status
BIA <- - ASPSP_API: Response
BIA -> BIA: Mediate response payload
API_GATEWAY <- - BIA: ""200 OK {...}""
INGRESS <- - API_GATEWAY: ""200 OK {...}""
DR <- - INGRESS: ""200 OK {...}""

end loop

end alt

@enduml

PlantUML version 1.2022.7(Mon Aug 22 19:01:30 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>